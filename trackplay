#!/usr/bin/python

#Audio Tools, a module and set of tools for manipulating audio data
#Copyright (C) 2007  Brian Langenberger

#This program is free software; you can redistribute it and/or modify
#it under the terms of the GNU General Public License as published by
#the Free Software Foundation; either version 2 of the License, or
#(at your option) any later version.

#This program is distributed in the hope that it will be useful,
#but WITHOUT ANY WARRANTY; without even the implied warranty of
#MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#GNU General Public License for more details.

#You should have received a copy of the GNU General Public License
#along with this program; if not, write to the Free Software
#Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA


import audiotools
import optparse
import sys

class OSSPlayer:
    def __init__(self):
        import ossaudiodev
        self.dev = ossaudiodev.open("w")

    def close(self):
        self.dev.close()

    def play(self, pcm):
        import ossaudiodev
        
        if (pcm.bits_per_sample == 16):
            fmt = ossaudiodev.AFMT_S16_LE
        elif (pcm.bits_per_sample == 8):
            fmt = ossaudiodev.AFMT_U8
        else:
            #if the bits-per-sample is not 8/16 (which usually means 24)
            #have PCMConverter turn it into 16 for us
            pcm = audiotools.PCMConverter(
                pcm,pcm.sample_rate,pcm.channels,
                16)
            fmt = ossaudiodev.AFMT_S16_LE

        self.dev.setparameters(fmt,
                          pcm.channels,
                          pcm.sample_rate)

        audiotools.threaded_transfer_data(pcm.read,self.dev.writeall)


if (__name__ == '__main__'):
    parser = optparse.OptionParser(
        "%prog <track 1> [track 2] ...",
        version="Python Audio Tools %s" % (audiotools.VERSION))

    parser.add_option('-T','--track-replaygain',
                      action='store_true',
                      default=False,
                      dest='track_replaygain',
                      help='apply track ReplayGain during playback, if present')

    parser.add_option('-A','--album-replaygain',
                      action='store_true',
                      default=False,
                      dest='album_replaygain',
                      help='apply album ReplayGain during playback, if present')

    (options,args) = parser.parse_args()

    player = OSSPlayer()

    try:
        for audiofile in audiotools.open_files(args,sorted=False):
            pcm = audiofile.to_pcm()

            try:
                #if ReplayGain specified, wrap ReplayGainReader
                #around the given PCMReader
                if (options.track_replaygain or options.album_replaygain):
                    replaygain = audiofile.replay_gain()
                    if ((replaygain is not None) and options.album_replaygain):
                        pcm = audiotools.ReplayGainReader(
                            pcm,replaygain.album_gain,replaygain.album_peak)
                    elif ((replaygain is not None) and options.track_replaygain):
                        pcm = audiotools.ReplayGainReader(
                            pcm,replaygain.track_gain,replaygain.track_peak)

                player.play(pcm)
            finally:
                pcm.close()
    finally:
        player.close()

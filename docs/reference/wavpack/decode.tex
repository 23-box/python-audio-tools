%This work is licensed under the
%Creative Commons Attribution-Share Alike 3.0 United States License.
%To view a copy of this license, visit
%http://creativecommons.org/licenses/by-sa/3.0/us/ or send a letter to
%Creative Commons,
%171 Second Street, Suite 300,
%San Francisco, California, 94105, USA.

\section{WavPack Decoding}

\ALGORITHM{a WavPack encoded file}{PCM samples}
\SetKwData{INDEX}{index}
\SetKwData{SAMPLES}{samples}
\SetKwData{TOTALSAMPLES}{total samples}
\SetKwData{FINALBLOCK}{final block}
\SetKwData{OUTPUTCHANNEL}{output channel}
\SetKwData{BLOCKCHANNEL}{block channel}
\SetKwData{BLOCKDATASIZE}{block data size}
\Repeat{block header's $\text{\INDEX} + \text{\SAMPLES} >= \text{\TOTALSAMPLES}$}{
  $c \leftarrow 0$\;
  \Repeat{block header's $\text{\FINALBLOCK} = 1$}{
    \hyperref[wavpack:read_block_header]{read block header}\;
    read \BLOCKDATASIZE bytes of block data\;
    \hyperref[wavpack:decode_block]{decode block header and block data to 1 or 2 channels of PCM data}\;
    \eIf{2 channels}{
      $\text{\OUTPUTCHANNEL}_c \leftarrow \text{\BLOCKCHANNEL}_0$\;
      $\text{\OUTPUTCHANNEL}_{c + 1} \leftarrow \text{\BLOCKCHANNEL}_1$\;
      $c \leftarrow c + 2$\;
    }{
      $\text{\OUTPUTCHANNEL}_c \leftarrow \text{\BLOCKCHANNEL}_0$\;
      $c \leftarrow c + 1$\;
    }
  }
  update stream MD5 sum with \OUTPUTCHANNEL data\;
  \Return \OUTPUTCHANNEL data\;
}
\BlankLine
\hyperref[wavpack:md5_sum]{attempt to read one additional block for MD5 sub block}\;
\If{MD5 sub block found}{
  \ASSERT sub block MD5 sum = stream MD5 sum\;
}
\EALGORITHM
\par
\noindent
For example, four blocks with the following attributes:
\begin{table}[h]
\begin{tabular}{rrr}
channel count & initial block & final block \\
\hline
2 & 1 & 0 \\
1 & 0 & 0 \\
1 & 0 & 0 \\
2 & 0 & 1 \\
\end{tabular}
\end{table}
\par
\noindent
combine into 6 channels of PCM output as follows:
\begin{figure}[h]
\includegraphics{wavpack/figures/block_channels.pdf}
\end{figure}

\clearpage

\subsection{Reading Block Header}
\label{wavpack:read_block_header}
{\relsize{-1}
  \input{wavpack/algorithms/read_block_header}
}

\clearpage

\subsubsection{Decoding Sample Rate}
\label{wavpack:decode_sample_rate}
{\relsize{-1}
\input{wavpack/algorithms/decode_sample_rate}
}
\clearpage

\subsubsection{Reading Block Header Example}
\begin{figure}[h]
  \includegraphics[height=3.5in,keepaspectratio]{wavpack/figures/block_header_parse.pdf}
\end{figure}

{\relsize{-2}
  \begin{tabular}{rrl}
    field & value & meaning \\
    \hline
    \textbf{block ID} & \texttt{0x6B707677} & \texttt{"wvpk"} \\
    \textbf{block data size} & \texttt{0x000000B2} & $178 - 24 = 154$ bytes \\
    \textbf{version} & \texttt{0x0407} \\
    \textbf{track number} & \texttt{0} \\
    \textbf{index number} & \texttt{0} \\
    \textbf{total samples} & \texttt{0x00000019} & 25 PCM frames \\
    \textbf{block index} & \texttt{0x00000000} & 0 PCM frames \\
    \textbf{block samples} & \texttt{0x00000019} & 25 PCM frames \\
    \textbf{bits per sample} & \texttt{1} & 16 bits per sample \\
    \textbf{mono output} & \texttt{0} & 2 channel block \\
    \textbf{hybrid mode} & \texttt{0} & lossless data \\
    \textbf{joint stereo} & \texttt{1} & channels stored in joint stereo \\
    \textbf{channel decorrelation} & \texttt{1} & cross-channel decorrelation used \\
    \textbf{hybrid noise shaping} & \texttt{0} \\
    \textbf{floating point data} & \texttt{0} & samples stored as integers \\
    \textbf{extended size integers} & \texttt{0} \\
    \textbf{hybrid controls bitrate} & \texttt{0} \\
    \textbf{hybrid noise balanced} & \texttt{0} \\
    \textbf{initial block} & \texttt{1} & is initial block in sequence \\
    \textbf{final block} & \texttt{1} & is final block in sequence \\
    \textbf{left shift data} & \texttt{0} \\
    \textbf{maximum magnitude} & \texttt{15} & 16 bits per sample output \\
    \textbf{sample rate} & \texttt{9} & 44100 Hz \\
    \textbf{reserved} & \texttt{0} \\
    \textbf{use IIR} & \texttt{0} \\
    \textbf{false stereo} & \texttt{0} & both channels are not identical \\
    \textbf{reserved} & \texttt{0} \\
    \textbf{CRC} & \texttt{0x22D25AD7} \\
  \end{tabular}
}

\clearpage

\subsection{Reading Block Parameters}
\label{wavpack:read_block_parameters}
{\relsize{-1}
\input{wavpack/algorithms/read_block_parameters}
}

\clearpage

\input{wavpack/decode/terms}

\clearpage

\input{wavpack/decode/weights}

\clearpage

\input{wavpack/decode/samples}

\clearpage

\input{wavpack/decode/entropy}

\clearpage

\input{wavpack/decode/bitstream}

\clearpage

\input{wavpack/decode/decorrelation}

\clearpage

\subsection{Undo Joint Stereo}
\label{wavpack:undo_joint_stereo}
\ALGORITHM{mid and side channels of signed sample data, in that order}{left and right channels of signed sample data, in that order}
\SetKwData{MID}{mid}
\SetKwData{SIDE}{side}
\SetKwData{LEFT}{left}
\SetKwData{RIGHT}{right}
\For{$i \leftarrow 0$ \emph{\KwTo}sample count}{
  $\text{\RIGHT}_i \leftarrow \text{\SIDE}_i - \lfloor\text{\MID}_i \div 2\rfloor$\;
  $\text{\LEFT}_i \leftarrow \text{\MID}_i + \text{\RIGHT}_i$\;
}
\Return left and right channels\;
\EALGORITHM

\subsubsection{Joint Stereo Example}
\begin{table}[h]
\begin{tabular}{|r|r|r||>{$}r<{$}|>{$}r<{$}|}
$i$ & $\textsf{mid}_i$ & $\textsf{side}_i$ & \textsf{right}_i & \textsf{left}_i \\
\hline
0 & -64 & 32 &
32 - \lfloor-64 \div 2\rfloor = 64 &
-64 + 64 = 0 \\
1 & -46 & 39 &
39 - \lfloor-46 \div 2\rfloor = 62 &
-46 + 62 = 16 \\
2 & -25 & 43 &
43 - \lfloor-25 \div 2\rfloor = 56 &
-25 + 56 = 31 \\
3 & -3 & 45 &
45 - \lfloor-3 \div 2\rfloor = 47 &
-3 + 47 = 44 \\
4 & 20 & 44 &
44 - \lfloor20 \div 2\rfloor = 34 &
20 + 34 = 54 \\
5 & 41 & 40 &
40 - \lfloor41 \div 2\rfloor = 20 &
41 + 20 = 61 \\
6 & 60 & 34 &
34 - \lfloor60 \div 2\rfloor = 4 &
60 + 4 = 64 \\
7 & 75 & 25 &
25 - \lfloor75 \div 2\rfloor = -12 &
75 + -12 = 63 \\
8 & 85 & 15 &
15 - \lfloor85 \div 2\rfloor = -27 &
85 + -27 = 58 \\
9 & 90 & 4 &
4 - \lfloor90 \div 2\rfloor = -41 &
90 + -41 = 49 \\
\hline
\end{tabular}
\end{table}

\clearpage

\label{wavpack:verify_crc}
\subsection{Checksum Calculation}
\ALGORITHM{one or two channels of signed audio samples}{an unsigned 32-bit CRC integer}
\SetKwData{MONO}{mono output}
\SetKwData{CRC}{CRC}
\SetKwData{LCRC}{LCRC}
\SetKwData{SCRC}{SCRC}
\SetKwData{CHANNEL}{channel}
$\text{\CRC}_{-1} \leftarrow \texttt{0xFFFFFFFF}$\;
\For{$i \leftarrow 0$ \emph{\KwTo}sample count}{
  \eIf{$\text{\MONO} = 0$}{
    $\text{\LCRC}_i \leftarrow (3 \times \text{\CRC}_{i - 1}) + \text{\CHANNEL}_{0~i}$\tcc*[r]{calculate signed CRC of left channel}
    $\text{\SCRC}_i \leftarrow (3 \times \text{\LCRC}_{i - 1}) + \text{\CHANNEL}_{1~i}$\tcc*[r]{calculate signed CRC of right channel}
  }{
    $\text{\SCRC}_i \leftarrow (3 \times \text{\CRC}_{i - 1}) + \text{\CHANNEL}_{0~i}$\tcc*[r]{calculate signed CRC of channel}
  }
  \BlankLine
  \eIf(\tcc*[f]{convert signed CRC to unsigned, 32-bit integer}){$\text{\SCRC}_i \geq 0$}{
    $\text{\CRC}_i \leftarrow \text{\SCRC}_i \bmod \texttt{0x100000000}$\;
  }{
    $\text{\CRC}_i \leftarrow (2 ^ {32} - (-\text{\SCRC}_i)) \bmod \texttt{0x100000000}$\;
  }
}
\Return $\text{\CRC}_{\text{sample count} - 1}$\;
\EALGORITHM

\subsubsection{Checksum Calculation Example}
{\relsize{-1}
\begin{tabular}{|r|r|r||>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|}
$i$ & $\textsf{channel}_{0~i}$ & $\textsf{channel}_{1~i}$ & \textsf{LCRC}_i & \text{SCRC}_i & \textsf{CRC}_i \\
\hline
0 & 0 & 64 &
(3 \times \texttt{FFFFFFFF}) + 0 = \texttt{2FFFFFFFD} &
(3 \times \texttt{2FFFFFFFD}) + 64 = \texttt{900000037} &
\texttt{00000037} \\
1 & 16 & 62 &
(3 \times \texttt{00000037}) + 16 = \texttt{000000B5} &
(3 \times \texttt{000000B5}) + 62 = \texttt{0000025D} &
\texttt{0000025D} \\
2 & 31 & 56 &
(3 \times \texttt{0000025D}) + 31 = \texttt{00000736} &
(3 \times \texttt{00000736}) + 56 = \texttt{000015DA} &
\texttt{000015DA} \\
3 & 44 & 47 &
(3 \times \texttt{000015DA}) + 44 = \texttt{000041BA} &
(3 \times \texttt{000041BA}) + 47 = \texttt{0000C55D} &
\texttt{0000C55D} \\
4 & 54 & 34 &
(3 \times \texttt{0000C55D}) + 54 = \texttt{0002504D} &
(3 \times \texttt{0002504D}) + 34 = \texttt{0006F109} &
\texttt{0006F109} \\
5 & 61 & 20 &
(3 \times \texttt{0006F109}) + 61 = \texttt{0014D358} &
(3 \times \texttt{0014D358}) + 20 = \texttt{003E7A1C} &
\texttt{003E7A1C} \\
6 & 64 & 4 &
(3 \times \texttt{003E7A1C}) + 64 = \texttt{00BB6E94} &
(3 \times \texttt{00BB6E94}) + 4 = \texttt{02324BC0} &
\texttt{02324BC0} \\
7 & 63 & -12 &
(3 \times \texttt{02324BC0}) + 63 = \texttt{0696E37F} &
(3 \times \texttt{0696E37F}) - 12 = \texttt{13C4AA71} &
\texttt{13C4AA71} \\
8 & 58 & -27 &
(3 \times \texttt{13C4AA71}) + 58 = \texttt{3B4DFF8D} &
(3 \times \texttt{3B4DFF8D}) - 27 = \texttt{B1E9FE8C} &
\texttt{B1E9FE8C} \\
9 & 49 & -41 &
(3 \times \texttt{B1E9FE8C}) + 49 = \texttt{215BDFBD5} &
(3 \times \texttt{215BDFBD5}) - 41 = \texttt{64139F356} &
\texttt{4139F356} \\
\hline
\end{tabular}
}
\vskip 1em
\par
\noindent
Resulting in a final CRC of \texttt{0x4139F356}

\clearpage

\subsection{Decode Extended Integers}
\label{wavpack:decode_extended_integers}
\ALGORITHM{sub block data}{\VAR{zero bits}, \VAR{one bits}, \VAR{duplicate bits} values as unsigned integers}
\SetKwData{SENTS}{sent bits}
\SetKwData{ZEROES}{zero bits}
\SetKwData{ONES}{one bits}
\SetKwData{DUPLICATES}{duplicate bits}
\SENTS $\leftarrow$ \READ 8 unsigned bits\tcc*[r]{unused}
\ZEROES $\leftarrow$ \READ 8 unsigned bits\;
\ONES $\leftarrow$ \READ 8 unsigned bits\;
\DUPLICATES $\leftarrow$ \READ 8 unsigned bits\;
\Return $\left\lbrace\begin{tabular}{l}
\ZEROES \\
\ONES \\
\DUPLICATES \\
\end{tabular}\right.$\;
\EALGORITHM

\begin{figure}[h]
  \includegraphics{wavpack/figures/extended_integers.pdf}
\end{figure}

\subsection{Undoing Extended Integers}
\label{wavpack:undo_extended_integers}
\ALGORITHM{\VAR{zero bits}, \VAR{one bits}, \VAR{duplicate bits} values; 1 or 2 channels of shifted PCM data}{1 or 2 channels of un-shifted PCM data}
\SetKwData{ZEROES}{zero bits}
\SetKwData{ONES}{one bits}
\SetKwData{DUPLICATES}{duplicate bits}
\SetKwData{SHIFTED}{shifted channel}
\SetKwData{UNSHIFTED}{un-shifted channel}
\For{$c \leftarrow 0$ \emph{\KwTo}channel count}{
  \uIf{$\text{\ZEROES} > 0$}{
    \For{$i \leftarrow 0$ \emph{\KwTo}sample count}{
      $\text{\UNSHIFTED}_{c~i} \leftarrow \text{\SHIFTED}_{c~i} \times 2 ^ {\text{\ZEROES}}$\;
    }
  }
  \uElseIf{$\text{\ONES} > 0$}{
    \For{$i \leftarrow 0$ \emph{\KwTo}sample count}{
      $\text{\UNSHIFTED}_{c~i} \leftarrow \text{\SHIFTED}_{c~i} \times 2 ^ {\text{\ONES}} + (2 ^ {\text{\ONES}} - 1)$\;
    }
  }
  \uElseIf{$\text{\DUPLICATES} > 0$}{
    \For{$i \leftarrow 0$ \emph{\KwTo}sample count}{
      \eIf{$\text{\SHIFTED}_{c~i} \bmod 2 = 0$}{
        $\text{\UNSHIFTED}_{c~i} \leftarrow \text{\SHIFTED}_{c~i} \times 2 ^ {\text{\DUPLICATES}}$\;
      }{
        $\text{\UNSHIFTED}_{c~i} \leftarrow \text{\SHIFTED}_{c~i} \times 2 ^ {\text{\DUPLICATES}} + (2 ^ {\text{\DUPLICATES}} - 1)$\;
      }
    }
  }
  \Else{
    $\text{\UNSHIFTED}_c \leftarrow \text{\SHIFTED}_c$\;
  }
}
\Return \UNSHIFTED data\;
\EALGORITHM

\clearpage

\subsection{MD5 Sum}
\label{wavpack:md5_sum}
The MD5 is the hash of all the PCM samples, on a PCM frame basis,
in little-endian format and signed if the bits per sample is greater than 0.

\begin{figure}[h]
\includegraphics{wavpack/figures/md5sum.pdf}
\end{figure}

\subsection{RIFF WAVE Header and Footer}

These sub-blocks are typically found in the first and last
WavPack block, respectively.
The header must always be present in the file while
the footer is optional.

\begin{figure}[h]
\includegraphics{wavpack/figures/pcm_sandwich.pdf}
\end{figure}

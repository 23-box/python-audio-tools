%This work is licensed under the
%Creative Commons Attribution-Share Alike 3.0 United States License.
%To view a copy of this license, visit
%http://creativecommons.org/licenses/by-sa/3.0/us/ or send a letter to
%Creative Commons,
%171 Second Street, Suite 300,
%San Francisco, California, 94105, USA.

\section{True Audio Decoding}

The basic process for decoding a TTA file is as follows:
\par
\noindent
{\relsize{-1}
  \ALGORITHM{a TTA encoded file}{PCM samples}
  \SetKwData{SIGNATURE}{signature}
  \SetKwData{FORMAT}{format}
  \SetKwData{CHANNELS}{channels}
  \SetKwData{BPS}{bits per sample}
  \SetKwData{SAMPLERATE}{sample rate}
  \SetKwData{PCMFRAMES}{total PCM frames}
  \SetKwData{HEADERCRC}{header CRC32}
  \SetKwData{FRAMESIZE}{TTA frame size}
  \SetKwData{SEEKTABLECRC}{seektable CRC32}
  \tcc{read header}
  \begin{tabular}{rcl}
    \SIGNATURE & $\leftarrow$ & \READ 4 bytes\; \\
    & & \ASSERT $\text{\SIGNATURE} = \texttt{"TTA1"}$\; \\
    \FORMAT & $\leftarrow$ & \READ 16 unsigned bits\; \\
    \CHANNELS & $\leftarrow$ & \READ 16 unsigned bits\; \\
    \BPS & $\leftarrow$ & \READ 16 unsigned bits\; \\
    \SAMPLERATE & $\leftarrow$ & \READ 32 unsigned bits\; \\
    \PCMFRAMES & $\leftarrow$ & \READ 32 unsigned bits\; \\
  \end{tabular}\;
  $\HEADERCRC \leftarrow$ \READ 32 unsigned bits\tcc*{don't process this value with CRC}
  \hyperref[tta:crc32]{validate calculated CRC32 against \HEADERCRC}\;
  \BlankLine
  \tcc{read seektable}
  \For{$i \leftarrow 0$ \emph{\KwTo}$\lceil(\text{\PCMFRAMES} \times 245) \div (\text{\SAMPLERATE} \times 256)\rceil$}{
    $\text{\FRAMESIZE}_i \leftarrow$ \READ 32 unsigned bits\;
  }
  $\SEEKTABLECRC \leftarrow$ \READ 32 unsigned bits\tcc*{don't process this value with CRC}
  \hyperref[tta:crc32]{validate calculated CRC32 against \SEEKTABLECRC}\;
  \BlankLine
  \tcc{decode frames}
  \While{$\PCMFRAMES > 0$}{
     \hyperref[tta:decode_frame]{decode TTA frames to 1 or more PCM frames}\;
     deduct frame's block size from $\PCMFRAMES$\;
     \Return decoded PCM frames\;
  }
  \EALGORITHM
}
\begin{figure}[h]
  \includegraphics{tta/figures/frames.pdf}
\end{figure}

\clearpage

\subsection{Decoding a TTA Frame}
\label{tta:decode_frame}
{\relsize{-1}
  \ALGORITHM{channels, sample rate, remaining PCM frames}{1 or more PCM frames}
  \SetKwData{BLOCKSIZE}{block size}
  \SetKwFunction{MIN}{min}
  \SetKwFunction{MAX}{max}
  \SetKwData{CHANNELS}{channels}
  \SetKwData{SAMPLERATE}{sample rate}
  \SetKwData{PCMFRAMES}{remaining PCM frames}
  \SetKwData{KZ}{k0}
  \SetKwData{KO}{k1}
  \SetKwData{SUMZ}{sum0}
  \SetKwData{SUMO}{sum1}
  \SetKwData{MSB}{MSB}
  \SetKwData{LSB}{LSB}
  \SetKwData{UNSHIFTED}{unshifted}
  \SetKwData{UNSIGNED}{unsigned}
  \SetKwData{RESIDUAL}{residual}
  \SetKwData{FILTERED}{filtered}
  \SetKwData{PREDICTED}{predicted}
  \SetKwData{DECORRELATED}{decorrelated}
  \SetKwData{FRAMECRC}{frame CRC32}
  \For{$c \leftarrow 0$ \emph{\KwTo}\CHANNELS}{
    $\text{\KZ}_c \leftarrow \text{\KO}_c \leftarrow 10$\;
    $\text{\SUMZ}_c \leftarrow \text{\SUMO}_c \leftarrow 2 ^ {14}$\;
  }
  $\BLOCKSIZE \leftarrow \MIN(\lceil(\SAMPLERATE \times 256) \div 245\rceil~,~\PCMFRAMES)$\;
  \BlankLine
  \For(\tcc*[f]{decode residuals}){$i \leftarrow 0$ \emph{\KwTo}\BLOCKSIZE}{
    \For{$c \leftarrow 0$ \emph{\KwTo}\CHANNELS}{
      $\MSB \leftarrow$ \UNARY with stop bit 0\;
      \eIf{$\MSB = 0$}{
        $\UNSIGNED \leftarrow$ \READ $\text{\KZ}_c$ unsigned bits\;
      }{
        $\LSB \leftarrow$ \READ $\text{\KO}_c$ unsigned bits\;
        $\UNSHIFTED \leftarrow ((\MSB - 1) \times 2 ^ {\text{\KO}_c}) + \LSB$\;
        $\UNSIGNED \leftarrow \UNSHIFTED + 2 ^ {\text{\KZ}_c}$\;
        $\text{\SUMO}'_c \leftarrow \text{\SUMO}_c + (\UNSHIFTED - \lfloor\text{\SUMO}_c \div 2 ^ 4\rfloor)$\;
        \uIf{$\text{\SUMO}'_c < 2 ^ {\text{\KO}_c + 4}$}{
        $\text{\KO}'_c \leftarrow \MAX(\text{\KO}_c - 1~,~0)$\;
        }
        \ElseIf{$\text{\SUMO}'_c > 2 ^ {\text{\KO}_c + 5}$}{
          $\text{\KO}'_c \leftarrow \text{\KO}_c + 1$\;
        }
      }
      $\text{\SUMZ}'_c \leftarrow \text{\SUMZ}_c + (\UNSIGNED - \lfloor\text{\SUMZ}_c \div 2 ^ 4\rfloor)$\;
      \uIf{$\text{\SUMZ}'_c < 2 ^ {\text{\KZ}_c + 4}$}{
        $\text{\KZ}'_c \leftarrow \MAX(\text{\KZ}_c - 1~,~0)$\;
      }
      \ElseIf{$\text{\SUMZ}'_c > 2 ^ {\text{\KZ}_c + 5}$}{
        $\text{\KZ}'_c \leftarrow \text{\KZ}_c + 1$\;
      }
      \eIf(\tcc*[f]{apply sign bit}){$(\UNSIGNED \bmod 2) = 1$}{
        $\text{\RESIDUAL}_{c~i} \leftarrow (\UNSIGNED + 1) \div 2$\;
      }{
        $\text{\RESIDUAL}_{c~i} \leftarrow -(\UNSIGNED \div 2)$\;
      }
    }
  }
  byte-align file stream\;
  $\FRAMECRC \leftarrow$ \READ 32 unsigned bits\tcc*{don't process this value with CRC}
  \hyperref[tta:crc32]{validate calculated CRC32 against \FRAMECRC}\;
  \BlankLine
  \For{$c \leftarrow 0$ \emph{\KwTo}\CHANNELS}{
      $\text{\FILTERED}_c \leftarrow$ \hyperref[tta:hybridfilter]{run hybrid filter on $\text{\RESIDUAL}_c$}\;
      $\text{\PREDICTED}_c \leftarrow$ run fixed order prediction on $\text{\FILTERED}_c$\;  %FIXME - add link
  }
  $\text{\DECORRELATED} \leftarrow$ decorrelate $\text{\PREDICTED}$\;  %FIXME - add link
  \Return \DECORRELATED\;
  \EALGORITHM
}

\clearpage

\subsubsection{Residual Decoding Example}
In this example, the frame's \textsf{block size} is 10 and
channel count is 2.
\begin{table}[h]
  {\relsize{-2}
    \begin{tabular}{rrrrrrrrrrr}
      $i$ & $c$ & $\textsf{k0}_c$ & $\textsf{sum0}_c$ & $\textsf{k1}_c$ & $\textsf{sum1}_c$ & $\textsf{MSB}_{c~i}$ & $\textsf{LSB}_{c~i}$ & $\textsf{unshifted}_{c~i}$ & $\textsf{unsigned}_{c~i}$ & $\textsf{residual}_{c~i}$ \\
      \hline
0 & 0 & 10 & 16384 & 10 & 16384 & 4 &
168 & $((4 - 1) \times 2 ^ {10}) + 168 = 3240$ & 4264 &
-2132
\\
0 & 1 & 10 & 16384 & 10 & 16384 & 6 &
432 & $((6 - 1) \times 2 ^ {10}) + 432 = 5552$ & 6576 &
-3288
\\
1 & 0 & 10 & 19624 & 10 & 18600 & 0 &
 & & 530 &
-265
\\
1 & 1 & 10 & 21936 & 10 & 20912 & 0 &
 & & 463 &
232
\\
2 & 0 & 10 & 18928 & 10 & 18600 & 0 &
 & & 532 &
-266
\\
2 & 1 & 10 & 21028 & 10 & 20912 & 0 &
 & & 865 &
433
\\
3 & 0 & 10 & 18277 & 10 & 18600 & 0 &
 & & 586 &
-293
\\
3 & 1 & 10 & 20579 & 10 & 20912 & 0 &
 & & 537 &
269
\\
4 & 0 & 10 & 17721 & 10 & 18600 & 0 &
 & & 512 &
-256
\\
4 & 1 & 10 & 19830 & 10 & 20912 & 0 &
 & & 625 &
313
\\
5 & 0 & 10 & 17126 & 10 & 18600 & 0 &
 & & 436 &
-218
\\
5 & 1 & 10 & 19216 & 10 & 20912 & 0 &
 & & 565 &
283
\\
6 & 0 & 10 & 16492 & 10 & 18600 & 0 &
 & & 348 &
-174
\\
6 & 1 & 10 & 18580 & 10 & 20912 & 0 &
 & & 545 &
273
\\
7 & 0 & 9 & 15810 & 10 & 18600 & 0 &
 & & 316 &
-158
\\
7 & 1 & 10 & 17964 & 10 & 20912 & 0 &
 & & 575 &
288
\\
8 & 0 & 9 & 15138 & 10 & 18600 & 0 &
 & & 300 &
-150
\\
8 & 1 & 10 & 17417 & 10 & 20912 & 0 &
 & & 579 &
290
\\
9 & 0 & 9 & 14492 & 10 & 18600 & 0 &
 & & 356 &
-178
\\
9 & 1 & 10 & 16908 & 10 & 20912 & 0 &
 & & 627 &
314
\\
    \end{tabular}
  }
\end{table}
\begin{figure}[h]
  \includegraphics[width=6in,keepaspectratio]{tta/figures/residuals.pdf}
\end{figure}

\clearpage

\subsubsection{Running Hybrid Filter}
\label{tta:hybridfilter}
{\relsize{-2}
  \ALGORITHM{a list of residuals for a given channel, the frame's block size, the stream's bits per sample}{a list of filtered residuals}
  \SetKwData{BLOCKSIZE}{block size}
  \SetKwData{BPS}{bits per sample}
  \SetKwData{SHIFT}{shift}
  \SetKwData{ROUND}{round}
  \SetKwData{QM}{qm}
  \SetKwData{DX}{dx}
  \SetKwData{DL}{dl}
  \SetKwData{SUM}{sum}
  \SetKwData{RESIDUAL}{residual}
  \SetKwData{FILTERED}{filtered}
  \Switch{\BPS}{
    \uCase{8}{
      $\SHIFT \leftarrow 10$\;
    }
    \uCase{16}{
      $\SHIFT \leftarrow 9$\;
    }
    \Case{24}{
      $\SHIFT \leftarrow 10$\;
    }
  }
  \begin{tabular}{rcl}
    \ROUND & $\leftarrow$ & $2 ^ {\SHIFT - 1}$ \\
    \QM & $\leftarrow$ & \texttt{[0, 0, 0, 0, 0, 0, 0, 0]} \\
    \DX & $\leftarrow$ & \texttt{[0, 0, 0, 0, 0, 0, 0, 0]} \\
    \DL & $\leftarrow$ & \texttt{[0, 0, 0, 0, 0, 0, 0, 0]} \\
  \end{tabular}\;
  \For{$i \leftarrow 0$ \emph{\KwTo}\BLOCKSIZE}{
    \eIf{$i = 0$}{
      $\text{\FILTERED}_0 \leftarrow \lfloor\ROUND \div 2 ^ {\SHIFT}\rfloor$\;
    }{
      \uIf{$\text{\RESIDUAL}_{i - 1} < 0$}{
        \For{$j \leftarrow 0$ \emph{\KwTo}8}{
          $\text{\QM}'_j \leftarrow \text{\QM}_j - \text{\DX}_j$\;
        }
      }
      \ElseIf{$\text{\RESIDUAL}_{i - 1} > 0$}{
        \For{$j \leftarrow 0$ \emph{\KwTo}8}{
          $\text{\QM}'_j \leftarrow \text{\QM}_j + \text{\DX}_j$\;
        }
      }
      $\SUM \leftarrow \ROUND + \overset{7}{\underset{j = 0}{\sum}}\text{\DL}_j \times \text{\QM}'_j$\;
      $\text{\FILTERED}_i \leftarrow \text{\RESIDUAL}_i + \lfloor\SUM \div 2 ^ {\SHIFT}\rfloor$\;
    }
    \begin{tabular}{rcl}
      $\text{\DX}'_0$ & $\leftarrow$ & $\text{\DX}_1$ \\
      $\text{\DX}'_1$ & $\leftarrow$ & $\text{\DX}_2$ \\
      $\text{\DX}'_2$ & $\leftarrow$ & $\text{\DX}_3$ \\
      $\text{\DX}'_3$ & $\leftarrow$ & $\text{\DX}_4$ \\
      $\text{\DX}'_4$ & $\leftarrow$ & \lIf{$\text{\DL}_4 \geq 0$}{1} \lElse{-1} \\
      $\text{\DX}'_5$ & $\leftarrow$ & \lIf{$\text{\DL}_5 \geq 0$}{2} \lElse{-2} \\
      $\text{\DX}'_6$ & $\leftarrow$ & \lIf{$\text{\DL}_6 \geq 0$}{2} \lElse{-2} \\
      $\text{\DX}'_7$ & $\leftarrow$ & \lIf{$\text{\DL}_7 \geq 0$}{4} \lElse{-4} \\
      $\text{\DL}'_0$ & $\leftarrow$ & $\text{\DL}_1$ \\
      $\text{\DL}'_1$ & $\leftarrow$ & $\text{\DL}_2$ \\
      $\text{\DL}'_2$ & $\leftarrow$ & $\text{\DL}_3$ \\
      $\text{\DL}'_3$ & $\leftarrow$ & $\text{\DL}_4$ \\
      $\text{\DL}'_4$ & $\leftarrow$ & $-\text{\DL}_5 + (-\text{\DL}_6 + (\text{\FILTERED}_i - \text{\DL}_7))$ \\
      $\text{\DL}'_5$ & $\leftarrow$ & $-\text{\DL}_6 + (\text{\FILTERED}_i - \text{\DL}_7)$ \\
      $\text{\DL}'_6$ & $\leftarrow$ & $\text{\FILTERED}_i - \text{\DL}_7$ \\
      $\text{\DL}'_7$ & $\leftarrow$ & $\text{\FILTERED}_i$ \\
    \end{tabular}\;
  }
  \Return \FILTERED\;
  \EALGORITHM
}

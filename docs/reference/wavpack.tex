%This work is licensed under the
%Creative Commons Attribution-Share Alike 3.0 United States License.
%To view a copy of this license, visit
%http://creativecommons.org/licenses/by-sa/3.0/us/ or send a letter to
%Creative Commons,
%171 Second Street, Suite 300,
%San Francisco, California, 94105, USA.

\chapter{WavPack}
WavPack is a format for compressing Wave files, typically in lossless mode.
Notably, it also has a lossy mode and even a hybrid mode which allows
the `correction' file to be separated from a lossy core.

Metadata is stored as an APEv2 tag, which is described on page \pageref{apev2}.

Its stream of data is stored little-endian, as described on page
\pageref{bitstreams}.

\section{the WavPack file stream}
\begin{figure}[h]
\includegraphics{figures/wavpack_stream.pdf}
\end{figure}

\clearpage

\section{the WavPack block header}
\begin{figure}[h]
\includegraphics{figures/wavpack_block_header.pdf}
\end{figure}
\begin{wrapfigure}[10]{r}{1.5in}
\begin{tabular}{|c|r|}
\hline
value & sample rate \\
\hline
\texttt{0000} & 6000 \\
\texttt{0001} & 8000 \\
\texttt{0010} & 9600 \\
\texttt{0011} & 11025 \\
\texttt{0100} & 12000 \\
\texttt{0101} & 16000 \\
\texttt{0110} & 22050 \\
\texttt{0111} & 24000 \\
\texttt{1000} & 32000 \\
\texttt{1001} & 44100 \\
\texttt{1010} & 48000 \\
\texttt{1011} & 64000 \\
\texttt{1100} & 88200 \\
\texttt{1101} & 96000 \\
\texttt{1110} & 192000 \\
\texttt{1111} & reserved \\
\hline
\end{tabular}
\end{wrapfigure}

\VAR{Block Size} is the length of everything in the block past
the \VAR{Block Size} field itself -
or everything in the block past the CRC, minus 24 bytes.

\VAR{Bits per Sample} is one of 4 values:

\begin{inparaenum}
\item[\texttt{00} = ] 8 bps,
\item[\texttt{01} = ] 16 bps,
\item[\texttt{10} = ] 24 bps,
\item[\texttt{11} = ] 32 bps
\end{inparaenum}
.

\VAR{Mono Output} bit indicates the channel count.
If 1, this block has 1 channel.
If 0, this block has 2 channels.
For an audio stream with more than 2 channels,
check the \VAR{Initial Block} and \VAR{Final Block} bits to indicate
the start and end of the channels.  As an example:

\begin{tabular}{c|c|c|c}
Initial Block & Final Block & Mono Output & Channels \\
\hline
1 & 0 & 0 & 2 \\
0 & 0 & 1 & 1 \\
0 & 0 & 1 & 1 \\
0 & 1 & 0 & 2 \\
\hline
\multicolumn{3}{r|}{Total} & 6
\end{tabular}

\clearpage

\subsection{WavPack sub-block}
\begin{figure}[h]
\includegraphics{figures/wavpack_subblock_header.pdf}
\end{figure}
\par
\noindent
If the \VAR{Large Block} field is 0, the \VAR{Block Size} field is 8 bits long.
If it is 1, the \VAR{Block Size} field is 24 bits long.
The \VAR{Block Size} field is the length of \VAR{Block Data}, in 16-bit
words rather than bytes.
If \VAR{Actual Size 1 Less} is set, that means \VAR{Block Data} doesn't contain
an even number of bytes; it is padded with a single null byte at the
end in order to fit.
If \VAR{Nondecoder Data} is set, that means the decoder does not have
to understand the contents of this particular sub-block in
order to decode the audio.

\clearpage

\section{WavPack decoding}
The general principle of WavPack decoding is that we take the
values from several sub-blocks as decoder ``arguments''
and then decode one or two channels of audio per block.
If the file contains more than two channels, we combine the output
of several blocks into a single chunk of output data.

\subsection{the Decorrelation Terms sub-block}
\begin{figure}[h]
\includegraphics{figures/wavpack_decorr_terms.pdf}
\end{figure}
\par
\noindent
The number of decorrelation terms and deltas
equals the \VAR{Block Size} times 2, and minus 1 if
\VAR{Actual Size 1 Less} is set.
Each term and delta pair is 8 bits and stored in \textit{reverse} order.
In addition, one must subtract 5 from the stored value of each
unsigned term to get its actual value.

For example, given the complete sub-block bytes:
\begin{Verbatim}[frame=single]
42 03 57 57 47 56 48 00
\end{Verbatim}
we have a total of 5 term/delta pairs whose values are as follows:
\begin{table}[h]
\begin{tabular}{r r | r r}
$\text{Decorrelation Term}_5$ & \texttt{0x17} - 5 = 18 & $\text{Decorrlation Delta}_5$ & \texttt{0x2} = 2 \\
$\text{Decorrelation Term}_4$ & \texttt{0x17} - 5 = 18 & $\text{Decorrlation Delta}_4$ & \texttt{0x2} = 2 \\
$\text{Decorrelation Term}_3$ & \texttt{0x07} - 5 = 2 & $\text{Decorrlation Delta}_3$ & \texttt{0x2} = 2 \\
$\text{Decorrelation Term}_2$ & \texttt{0x16} - 5 = 17 & $\text{Decorrlation Delta}_2$ & \texttt{0x2} = 2 \\
$\text{Decorrelation Term}_1$ & \texttt{0x08} - 5 = 3 & $\text{Decorrlation Delta}_1$ & \texttt{0x2} = 2 \\
\end{tabular}
\end{table}
\par
\noindent
Remember that this is a little-endian stream and that the least-significant
bits (the \VAR{Decorrelation Delta} value) are on the left side of each byte.

\clearpage

\subsection{the Decorrelation Weights sub-block}
\begin{figure}[h]
\includegraphics{figures/wavpack_decorr_weights.pdf}
\end{figure}
\par
\noindent
As with the decorrelations terms sub-block,
the decorrelation weights are stored in reverse order.
The number of weights stored can be determined from the sub-block's
size.
Each is stored in a signed, 8-bit field and interleaved between
channels in the case of 2 channel blocks.
For example, $\text{Decorrelation Weight}_1$ is for channel \VAR{B},
$\text{Decorrelation Weight}_2$ is for channel
\VAR{A}\footnote{Why \VAR{A} and \VAR{B}?
Since a block may be only two channels out of many,
it makes sense not to number them to avoid ambiguity.},
$\text{Decorrelation Weight}_3$ is for channel \VAR{B} and so on
such that the first value will be for the highest
\VAR{Decorrelation Weight A}.
Converting the 8-bit values to the actual decorrelation weights
requires the following formula:
\begin{equation*}
\text{Decorrelation Weight} =
\begin{cases}
\text{value} \times 2 ^ 3 + \left\lfloor\frac{\text{value} \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor & \text{if value} > 0 \\
0 & \text{if value} = 0 \\
\text{value} \times 2 ^ 3 & \text{if value} < 0
\end{cases}
\end{equation*}
\par
\noindent
For example, given a 2 channel block with 5 decorrelation terms and the
sub-block bytes:
\begin{Verbatim}[frame=single]
06 06 06 06 04 04 06 06 02 03
\end{Verbatim}
our \VAR{Decorrelation Weights} are as follows:
\begin{table}[h]
\begin{tabular}{r r | r r}
$\text{Weight A}_5$ & $6 \times 2 ^ 3 + \left\lfloor\frac{6 \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor$ = 48 & $\text{Weight B}_5$ & $6 \times 2 ^ 3 + \left\lfloor\frac{6 \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor$ = 48 \\
$\text{Weight A}_4$ & $6 \times 2 ^ 3 + \left\lfloor\frac{6 \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor$ = 48 & $\text{Weight B}_4$ & $6 \times 2 ^ 3 + \left\lfloor\frac{6 \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor$ = 48 \\
$\text{Weight A}_3$ & $4 \times 2 ^ 3 + \left\lfloor\frac{4 \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor$ = 32 & $\text{Weight B}_3$ & $4 \times 2 ^ 3 + \left\lfloor\frac{4 \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor$ = 32 \\
$\text{Weight A}_2$ & $6 \times 2 ^ 3 + \left\lfloor\frac{6 \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor$ = 48 & $\text{Weight B}_2$ & $6 \times 2 ^ 3 + \left\lfloor\frac{6 \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor$ = 48 \\
$\text{Weight A}_1$ & $2 \times 2 ^ 3 + \left\lfloor\frac{2 \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor$ = 16 & $\text{Weight B}_1$ & $3 \times 2 ^ 3 + \left\lfloor\frac{3 \times 2 ^ 3 + 2 ^ 6}{2 ^ 7}\right\rfloor$ = 24 \\
\end{tabular}
\end{table}
\par
\noindent
Note that decoding a WavPack file requires having the same
number of \VAR{Decorrelation Weight} values, per channel, as
\VAR{Decorrelation Terms} values.
However, this block may contain less.
In that event, those low weight values are set to 0.


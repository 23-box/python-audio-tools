%This work is licensed under the
%Creative Commons Attribution-Share Alike 3.0 United States License.
%To view a copy of this license, visit
%http://creativecommons.org/licenses/by-sa/3.0/us/ or send a letter to
%Creative Commons,
%171 Second Street, Suite 300,
%San Francisco, California, 94105, USA.

\chapter{Apple Lossless}

Apple's lossless audio codec, informally referred to as ``ALAC'',
is lossless audio inside a QuickTime container - similar to M4A.
Its stream is the same collection of atoms as covered on page
\pageref{m4a}.
The key difference is the contents of its \texttt{mdat} atom.

\section{the ALAC file stream}
\begin{wrapfigure}[6]{r}{1.5in}
\includegraphics{figures/alac_atoms.pdf}
\end{wrapfigure}

This is the typical arrangements of ALAC atoms as encoded by iTunes.
As you can see, it is almost identical to the layout of AAC audio.
One of the key differences is that ALAC's \texttt{stsd} atom
contains an \texttt{alac} description sub-atom rather than an
\texttt{mp4a} description atom.

Its layout is as follows:

\begin{figure}[h]
\includegraphics{figures/alac_alac_atom.pdf}
\end{figure}

\pagebreak

\section{ALAC decoding}

An ALAC stream is made up of individual frames within the \texttt{mdat}
atom, as follows:

\begin{figure}[h]
\includegraphics{figures/alac_stream.pdf}
\end{figure}
\par
\noindent
ALAC frames come in two varieties: compressed and uncompressed,
depending on the \VAR{Is Not Compressed} bit in the frame header.
An uncompressed frame is laid out as follows:

\begin{figure}[h]
\includegraphics{figures/alac_uncompressed_frame.pdf}
\end{figure}
\par
\noindent
The number of PCM frames in an ALAC frame depends on the \VAR{Has Sample Size}
bit.
If set, the number of PCM frames equals the 32-bit \VAR{Sample Size}
value.
If not set, the total number of PCM frames equals the \VAR{Max Coded Frame Size}
value in the \texttt{alac} atom and the \VAR{Sample Size} value is omitted.
ALAC streams typically use the same number of samples per frame
until the end of the stream, at which point the leftover samples
are placed in a different-sized frame.

Uncompressed frames interleave samples between channels during decoding.
For example, a 2 channel frame places $\text{Sample}_1$ on $\text{Channel}_1$,
$\text{Sample}_2$ on $\text{Channel}_2$,
$\text{Sample}_3$ on $\text{Channel}_1$,
$\text{Sample}_4$ on $\text{Channel}_2$ and so on.

Finally, note that all ALAC frames have a footer of the bits `\texttt{111}'
and padding as needed such that each frame begins on an aligned byte boundary.

\pagebreak

A compressed frame is laid out as follows:

\begin{figure}[h]
\includegraphics{figures/alac_compressed_frame.pdf}
\end{figure}
\par
\noindent
\VAR{Interlacing Shift} and \VAR{Interlacing Leftweight} are used
for channel decorrelation after the subframes have been decoded.

There is one subframe header and one residual block per
channel.
If \VAR{Wasted Bits} is greater than 0, there is also
a block of wasted bits samples after the subframe headers but before
the residuals.

\label{alac_wasted_bits}
\VAR{Wasted Bits} is an attempt to store the least significant bits
of each sample more efficiently at high bits-per-sample, where
that data will often be indistinguishable from random noise.
In effect, it's a block of interlaced uncompressed samples
(similar to an uncompressed ALAC frame) each $8 \times \text{\VAR{Wasted Bits}}$
bits large.
Those wasted bits are then prepended to each sample after channel
decorrelation.
I'll explain this process in more detail later.

Each subframe header is laid out as follows:

\begin{figure}[h]
\includegraphics{figures/alac_subframe_header.pdf}
\end{figure}
\par
\noindent
There are \VAR{Coefficient Count} number of coefficients in each
subframe header, each a 16-bit signed value.

\pagebreak

\subsection{Residual decoding}

There are \VAR{Sample Size} number of residuals per residual block.
Decoding a residual block requires knowing the \VAR{Initial History},
\VAR{History Multiplier}, \VAR{Maximum K}, \VAR{Channels}, \VAR{Wasted Bits} and
\VAR{Bits per Sample} values, from the \texttt{alac} atom and frame header.
Fortunately, most of these values are rarely used;
we'll mostly be concerned with the \VAR{History} and \VAR{History Multiplier}.

For each residual block, \VAR{History} starts with the value of
\VAR{Initial History} and will change during residual decoding.
We use it to calculate $\kappa$ using the following formula:
\begin{equation}
\kappa = \left\lfloor\log_2 \left( \frac{\text{history}}{2 ^ 9} + 3 \right) \right\rfloor
\end{equation}
Note that if $\kappa$ exceeds the \VAR{Maximum K} value from the
\texttt{alac} atom, \VAR{Maximum K} is used instead.

We then need to know the \VAR{Bits per Sample} value of the residual
block, which is equal to:
\begin{equation}
\text{Bits per Sample}_{Residual} = \text{Bits per Sample}_{ALAC} - (\text{Wasted Bits} \times 8) + \text{Channels} - 1
\end{equation}
For mono streams, this is typically equal to the stream's
\VAR{Bits per Sample},
while for stereo streams it's often the \VAR{Bits per Sample} plus 1.

\begin{wrapfigure}[14]{r}{2.5in}
\includegraphics{figures/alac_read_residual.pdf}
\end{wrapfigure}
The $\kappa$ and \VAR{Bits per Sample} values are used to read a
single unsigned residual value in the following way:

The initial bit reading portion of the process
involves reading a unary value with a stop bit of `0'
and a maximum value of 8.
If the maximum value is exceeded, we read \VAR{Bits per Sample}
number of bits as our final value
(the only place \VAR{Bits per Sample} is used throughout the
residual decoding process).

Otherwise, we read $\kappa$ number of \VAR{extra} bits if $\kappa > 1$.
If \VAR{extra} is greater than 1, we return
$(\text{\VAR{unary}} \times (2^k - 1)) + (\text{\VAR{extra}} - 1)$.
If not, we push a single \VAR{extra} bit back on the stream and return our
$\text{\VAR{unary}} \times (2^k - 1)$ value.

\clearpage

We perform the following to convert unsigned residuals to signed residuals
which are returned to the subframe decoder:
\begin{equation}
\text{signed} =
\begin{cases}
(\text{unsigned} + 1) \gg 1 & \text{if unsigned is even} \\
-((\text{unsigned} + 1) \gg 1) & \text{if unsigned is odd}
\end{cases}
\end{equation}

Finally, we use our unsigned value to update \VAR{history}
before reading the next residual:
{\relsize{-1}
\begin{equation*}
\text{history} =
\begin{cases}
\text{history} + (\text{unsigned} \times \text{history multiplier}) - \left\lfloor\frac{\text{history} \times \text{history multiplier}}{2^9}\right\rfloor & \text{if unsigned} \leq 65535 \\
65535 & \text{if unsigned} > 65535
\end{cases}
\end{equation*}
}

Thus far, residual decoding isn't overly complex.
We simply calculate $\kappa$ from \VAR{history}, read a residual,
update \VAR{history} from its unsigned value and repeat the process
until we've read an entire subframe's worth of residuals.
The bulk of an ALAC file's residuals will be read in this way.
However, ALAC also features an ``escape code'' for large chunks
of 0 residuals (which may happen during a long stretch of
digital silence, for example).

If \VAR{history} ever falls below 128, this special case is triggered.
First, we read a special \VAR{block size} residual value
with a \VAR{Bits per Sample} value of 16 and a $\kappa$\footnote{Again, $\kappa$ cannot exceed \VAR{Maximum K} as encoded in the \texttt{alac} atom.} value of:
\begin{equation}
\kappa_{\text{blocksize}} = 7 - \log_2(\text{history}) + \frac{\text{history} + 16}{64}
\end{equation}
This \VAR{block size} is how many 0 residuals to send outright -
which may be 0, indicating no 0 residuals to send.
Either way, if $\text{\VAR{block size}} \leq 65535$,
we add 1 to the unsigned value of the next residual in the block (if any).
Finally, \VAR{history} is automatically set to 0.

\clearpage

\subsubsection{Residual decoding example}

In this example, we'll decode a group of residuals in which our
\VAR{Initial History} is 1130 and our \VAR{History Multiplier} is 40.
As a spoiler, $\kappa$ (the amount of non-unary bits to read
after each unary value) will remain 2 for this batch of residuals,
but why that is so will be explained below.

\begin{figure}[h]
\includegraphics{figures/alac_residual.pdf}
\end{figure}
\begin{itemize}
\setlength{\itemsep}{0in}
\setlength{\parskip}{0in}
\item Residual 1
\begin{itemize}
\item $\kappa = \lfloor\log_2((1130 \div 2^9) + 3)\rfloor = \lfloor\log_2(5)\rfloor = 2$
\item $\text{unsigned}_1 = (\textbf{0} \times (2^2 - 1)) + (\textbf{3} - 1) = \textbf{2}$
\item $\text{residual}_1 = (2 + 1) \gg 1 = 1$
\item $\text{history} = 1130 + (\textbf{2} \times 40) - \lfloor(1130 \times 40) \div 2^9\rfloor = 1130 + 80 - 88 = 1122$
\end{itemize}
\item Residual 2
\begin{itemize}
\item $\kappa = \lfloor\log_2((1122 \div 2^9) + 3)\rfloor = \lfloor\log_2(5)\rfloor = 2$
\item $\text{unsigned}_2 = (\textbf{2} \times (2^2 - 1)) + (\textbf{3} - 1) = \textbf{8}$
\item $\text{residual}_2 = (8 + 1) \gg 1 = 4$
\item $\text{history} = 1122 + (\textbf{8} \times 40) - \lfloor(1122 \times 40) \div 2^9\rfloor = 1122 + 320 - 87 = 1355$
\end{itemize}
\item Residual 3
\begin{itemize}
\item $\kappa = \lfloor\log_2((1355 \div 2^9) + 3)\rfloor = \lfloor\log_2(5)\rfloor = 2$
\item $\text{unsigned}_3 = (\textbf{1} \times (2^2 - 1)) = \textbf{3}$\hfill (note that we ``unread'' one 0 bit here)
\item $\text{residual}_3 = -((3 + 1) \gg 1) = -2$
\item $\text{history} = 1355 + (\textbf{3} \times 40) - \lfloor(1355 \times 40) \div 2^9\rfloor = 1355 + 120 - 105 = 1370$
\end{itemize}
\item Residual 4
\begin{itemize}
\item $\kappa = \lfloor\log_2((1370 \div 2^9) + 3)\rfloor = \lfloor\log_2(5)\rfloor = 2$
\item $\text{unsigned}_4 = (\textbf{0} \times (2^2 - 1)) + (\textbf{3} - 1) = \textbf{2}$
\item $\text{residual}_4 = (2 + 1) \gg 1 = 1$
\item $\text{history} = 1370 + (\textbf{2} \times 40) - \lfloor(1370 \times 40) \div 2^9\rfloor = 1370 + 80 - 107 = 1343$
\end{itemize}
\end{itemize}
Thus, our batch of signed residual values are 1, 4, -2 and 1.

\clearpage

\subsection{Subframe calculation}

% example:
% decode residuals [16, 1, 9, -1, -1, 1, -4, 7, -7, -1]
% with starting coeffs [1122, -766, 107, 122]
% and prediction_quantitization 9
% to samples [16, 17, 26, 25, 24, 23, 20, 24, 23, 20]

Given our list of decoded residual values;
along with a list of coefficients,
a \VAR{Coefficient Count} and a \VAR{Prediction Quantitization} value
(all from the subframe header),
we can now generate a list of signed subframe samples for a
given channel.

The first residual is always the first output sample:
\begin{align*}
\text{Sample}_0 &= \text{Residual}_0 \\
\intertext{Then, for the next \VAR{Coefficient Count} number of residuals:}
\text{Sample}_i &= \text{Residual}_i + \text{Sample}_{i - 1}
\end{align*}

For example, given that we have a \VAR{Coefficient Count} of 4
and our first five residuals are 16, 1, 9, -1 and -1;
our first five sample values are:
\begin{align*}
\text{Sample}_0 &= \textbf{16} \\
\text{Sample}_1 = 16 + 1 &= \textbf{17} \\
\text{Sample}_2 = 17 + 9 &= \textbf{26} \\
\text{Sample}_3 = 26 - 1 &= \textbf{25} \\
\text{Sample}_4 = 25 - 1 &= \textbf{24}
\end{align*}
These are our ``starting point'' samples upon which the remainder
of the subframe will be built.

Subsequent samples are calculated in the following way:

\begin{align*}
\text{LPC Sum}_i &= \overset{coeffs - 1}{\underset{j = 0}{\sum}}
\text{Coefficient}_j \times (\text{Sample}_{i - j - 1} - \text{Sample}_{i - coeffs - 1}) \\
\text{Sample}_i &= \left\lfloor \frac{\text{LPC Sum}_i + 2^{\text{Predictor Quantitization - 1}}} {2 ^ \text{Predictor Quantitization}}\right\rfloor + Residual_i + \text{Sample}_{i - coeffs - 1} \\
\intertext{For example, given $\text{Residual}_5$ = 1,
\VAR{Predictor Quantitization} = 9
and the coefficients 1122, -766, 107 and 122:}
\text{LPC Sum}_5 &=
(1122 \times (24 - 16)) + (-766 \times (25 - 16)) +
 (107 \times (26 - 16)) + (122 \times (17 - 16)) \\
&= (1122 \times 8) + (-766 \times 9) + (107 \times 10) + (122 \times 1) \\
&= 8976 + -6894 + 1070 + 122 = \textbf{3274} \\
\text{Sample}_5 &= \left\lfloor\frac{\textbf{3274} + 2^8}{2^9}\right\rfloor + 1 + 16
= \left\lfloor\frac{3530}{512}\right\rfloor + 1 + 16 = \textbf{23}
\end{align*}
But before calculating $\text{Sample}_6$,
we need to adjust our coefficient list.

\clearpage

Updating the coefficient list first requires calculating a set
of temporary \VAR{Val} and \VAR{Sign} values, as follows:
\begin{align}
\text{Val}_j &= \text{Sample}_{i - coeffs - 1} - \text{Sample}_{i - coeffs + j} & \text{for j = 0 to } coeffs - 1 \\
\text{Sign}_j &= \frac{\text{Val}_j}{|\text{Val}_j|} \times \frac{\text{Residual}_i}{|\text{Residual}_i|} & \text{for j = 0 to } coeffs - 1
\end{align}
Unless $\text{Residual}_i$ is 0, in which case our coefficient list
remains unchanged.
If $\text{Val}_j$ is 0, $\text{Sign}_j$ is also 0.
So to continue our example in which $\text{Residual}_5$ is 1 and
our \VAR{Coefficient Count} is 4:
\begin{table}[h]
\begin{tabular}{|c| >{$}l<{$} >{$}r<{$} | >{$}r<{$} |}
\hline
j & & \text{Val}_j & \text{Sign}_j \\
\hline
0 & \text{Sample}_0 - \text{Sample}_1 = 16 - 17 =& \textbf{-1} &
(-1 \div |-1|) \times (1 \div |1|) = -1 \times 1 = \textbf{-1} \\
\hline
1 & \text{Sample}_0 - \text{Sample}_2 = 16 - 26 =& \textbf{-10} &
(-10 \div |-10|) \times (1 \div |1|) = -1 \times 1 = \textbf{-1} \\
\hline
2 & \text{Sample}_0 - \text{Sample}_3 = 16 - 25 =& \textbf{-9} &
(-9 \div |-9|) \times (1 \div |1|) = -1 \times 1 = \textbf{-1} \\
\hline
3 & \text{Sample}_0 - \text{Sample}_4 = 16 - 24 =& \textbf{-8} &
(-8 \div |-8|) \times (1 \div |1|) = -1 \times 1 = \textbf{-1} \\
\hline
\end{tabular}
\end{table}
\par
\noindent
We then perform the following operations for each `j' from 0 to $coeffs - 1$
\textit{or} until
\linebreak
$\frac{\text{Residual}_i}{|\text{Residual}_i|} \neq \frac{\text{Residual}_j}{|\text{Residual}_j|}$ where $\text{Residual}_j$'s initial value is $\text{Residual}_i$:
\begin{align}
\text{Step 1. } & \text{Coefficient}_{coeffs - j - 1} = \text{Coefficient}_{coeffs - j - 1} - \text{Sign}_j \\
\text{Step 2. } & \text{Residual}_j = \text{Residual}_{j - 1} - \left\lfloor\frac{\text{Val}_j \times \text{Sign}_j}{2 ^ \text{Predictor Quantitization}}\right\rfloor \times (j + 1)
\end{align}
So to complete our example:
\begin{align*}
\text{Coefficient}_3 &= \text{Coefficient}_3 - \text{Sign}_0 = 122 - -1 =& 123 \\
\text{Residual}_0 &= \text{Residual}_{-1} - \left\lfloor\frac{\text{Val}_0 \times \text{Sign}_0}{2 ^ 9}\right\rfloor \times (0 + 1) = 1 - \left\lfloor\frac{-1 \times -1}{2 ^ 9}\right\rfloor \times 1 =& 1 \\
\text{Coefficient}_2 &= \text{Coefficient}_2 - \text{Sign}_1 = 107 - -1 =& 108 \\
\text{Residual}_1 &= \text{Residual}_0 - \left\lfloor\frac{\text{Val}_1 \times \text{Sign}_1}{2 ^ 9}\right\rfloor \times (1 + 1) = 1 - \left\lfloor\frac{-10 \times -1}{2 ^ 9}\right\rfloor \times 2 =& 1 \\
\text{Coefficient}_1 &= \text{Coefficient}_1 - \text{Sign}_2 = -766 - -1 =& -765 \\
\text{Residual}_2 &= \text{Residual}_1 - \left\lfloor\frac{\text{Val}_2 \times \text{Sign}_2}{2 ^ 9}\right\rfloor \times (2 + 1) = 1 - \left\lfloor\frac{-9 \times -1}{2 ^ 9}\right\rfloor \times 3 =& 1 \\
\text{Coefficient}_0 &= \text{Coefficient}_0 - \text{Sign}_3 = 1122 - -1 =& 1123 \\
\text{Residual}_3 &= \text{Residual}_2 - \left\lfloor\frac{\text{Val}_3 \times \text{Sign}_3}{2 ^ 9}\right\rfloor \times (3 + 1) = 1 - \left\lfloor\frac{-8 \times -1}{2 ^ 9}\right\rfloor \times 4 =& 1
\end{align*}
Thus, our list of coefficients for $\text{Sample}_6$ are now
1123, -765, 108 and 123.

\clearpage

Given that $\text{Residual}_6$ is -4, the calculation of $\text{Sample}_6$
is as follows:
\begin{align*}
\text{LPC Sum}_6 &= (1123 \times (23 - 17)) + (-765 \times (24 - 17)) + (108 \times (25 - 17)) + (123 \times (26 - 17)) \\
&= (1123 \times 6) + (-765 \times 7) + (108 \times 8) + (123 \times 9) \\
&= 6738 + -5355 + 864 + 1107 = \textbf{3354} \\
\text{Sample}_6 &= \left\lfloor\frac{\textbf{3354} + 2^8}{2^9}\right\rfloor + -4 + 17 = \left\lfloor\frac{3610}{512}\right\rfloor + -4 + 17 = \textbf{20}
\end{align*}
\begin{table}[h]
\begin{tabular}{|c| >{$}l<{$} >{$}r<{$} | >{$}r<{$} |}
\hline
j & & \text{Val}_j & \text{Sign}_j \\
\hline
0 & \text{Sample}_1 - \text{Sample}_2 = 17 - 26 =& \textbf{-9} &
(-9 \div |-9|) \times (-4 \div |-4|) = -1 \times -1 = \textbf{1} \\
\hline
1 & \text{Sample}_1 - \text{Sample}_3 = 17 - 25 =& \textbf{-8} &
(-8 \div |-8|) \times (-4 \div |-4|) = -1 \times -1 = \textbf{1} \\
\hline
2 & \text{Sample}_1 - \text{Sample}_4 = 17 - 24 =& \textbf{-7} &
(-7 \div |-7|) \times (-4 \div |-4|) = -1 \times -1 = \textbf{1} \\
\hline
3 & \text{Sample}_1 - \text{Sample}_5 = 17 - 23 =& \textbf{-6} &
(-6 \div |-6|) \times (-4 \div |-4|) = -1 \times -1 = \textbf{1} \\
\hline
\end{tabular}
\end{table}
\begin{align*}
\text{Coefficient}_3 &= \text{Coefficient}_3 - \text{Sign}_0 = 123 - 1 =& 122 \\
\text{Residual}_0 &= \text{Residual}_{-1} - \left\lfloor\frac{\text{Val}_0 \times \text{Sign}_0}{2 ^ 9}\right\rfloor \times (0 + 1) = -4 - \left\lfloor\frac{-9 \times 1}{2 ^ 9}\right\rfloor \times 1 =& -3 \\
\text{Coefficient}_2 &= \text{Coefficient}_2 - \text{Sign}_1 = 108 - 1 =& 107 \\
\text{Residual}_1 &= \text{Residual}_0 - \left\lfloor\frac{\text{Val}_1 \times \text{Sign}_1}{2 ^ 9}\right\rfloor \times (1 + 1) = -3 - \left\lfloor\frac{-8 \times 1}{2 ^ 9}\right\rfloor \times 2 =& -1 \\
\text{Coefficient}_1 &= \text{Coefficient}_1 - \text{Sign}_2 = -765 - 1 =& -766 \\
\text{Residual}_2 &= \text{Residual}_1 - \left\lfloor\frac{\text{Val}_2 \times \text{Sign}_2}{2 ^ 9}\right\rfloor \times (2 + 1) = -1 - \left\lfloor\frac{-7 \times 1}{2 ^ 9}\right\rfloor \times 3 =& 2
\intertext{Note that since $\text{Residual}_2$'s sign has changed,
the calculation stops.  Therefore:}
\text{Coefficient}_0 &= & 1123
\end{align*}
So, the coefficients for $\text{Sample}_7$ are 1123, -766, 107 and 122.

\clearpage

\subsection{Channel decorrelation}

If we have more than one channel of output, the next step is
performing channel decorrelation.
If our \VAR{Interlacing Leftweight} value from the frame header is 0,
our channels are stored independently.
In that case, the $\text{Channel}_1$ is our left samples and
$\text{Channel}_2$ is our right samples.

If \VAR{Interlacing Leftweight} is greater than zero,
we calculate samples as follows:
\begin{align*}
\text{Right}_i &= \text{Channel}_1 - \left\lfloor\frac{\text{Channel}_2 \times \text{Interlacing Leftweight}}{2 ^ \text{Interlacing Shift}}\right\rfloor \\
\text{Left}_i &= \text{Channel}_2 + \text{Right}_i
\end{align*}

For example, given the $\text{Channel}_1$ samples of 14, 15, 19, 17, 18;
the $\text{Channel}_2$ samples of 16, 17, 26, 25, 24,
an \VAR{Interlacing Shift} value of 2 and an \VAR{Interlacing Leftweight}
values of 3, we calculate output samples as follows:
\begin{table}[h]
\begin{tabular}{|c||>{$}r<{$}|>{$}r<{$}||>{$}r<{$}|>{$}r<{$}|}
\hline
Sample & \text{Channel}_1 & \text{Channel}_2 & \text{Right}_i & \text{Left}_i \\
\hline
0 & 14 & 16 & 14 - \lfloor(16 \times 3) \div 2^2\rfloor = \textbf{2} & 16 + \textbf{2} = \textbf{18} \\
1 & 15 & 17 & 15 - \lfloor(17 \times 3) \div 2^2\rfloor = \textbf{3} & 17 + \textbf{3} = \textbf{20} \\
2 & 19 & 26 & 19 - \lfloor(26 \times 3) \div 2^2\rfloor = \textbf{0} & 26 + \textbf{0} = \textbf{26} \\
3 & 17 & 25 & 17 - \lfloor(25 \times 3) \div 2^2\rfloor = \textbf{-1} & 25 + \textbf{-1} = \textbf{24} \\
4 & 18 & 24 & 18 - \lfloor(24 \times 3) \div 2^2\rfloor = \textbf{0} & 24 + \textbf{0} = \textbf{24} \\
\hline
\end{tabular}
\end{table}

\subsection{Wasted bits}

As explained on page \pageref{alac_wasted_bits}, a compressed ALAC frame
with \VAR{Wasted Bits} stores them interleaved between channels.
Then, after channel decorrelation, these verbatim values are
prepended to each sample.
For example, given a 2 channel stream with 24 bits-per-sample and
a \VAR{Wasted Bits} value of 1 (meaning our ``wasted'' samples
are 8 bits large), our final output is as follows:
\begin{figure}[h]
\includegraphics{figures/alac_wasted.pdf}
\end{figure}

\clearpage

\section{ALAC encoding}

To encode an ALAC file, we need a stream of PCM sample integers
along with that stream's sample rate, bits-per-sample and number of
channels.
We'll start by encoding all of the non-audio ALAC atoms,
most of which are contained within the \ATOM{moov} atom.
There's over twenty atoms in a typical ALAC file,
most of which are packed with seemingly redundant or
nonessential data,
so it will take awhile before we can move on to the actual
audio encoding process.

Remember, all of an ALAC's fields are big-endian.

\subsection{ALAC atoms}

We'll encode our ALAC file in iTunes order, which means
it contains the \ATOM{ftyp}, \ATOM{moov}, \ATOM{free} and
\ATOM{mdat} atoms, in that order.

%% \begin{table}[h]
%% \begin{tabular}{|l|r|l|}
%% \hline
%% Field & Size & Value \\
%% \hline
%% atom length & 32 & ? \\
%% atom type & 32 & ? \\
%% \hline
%% \hline
%% \end{tabular}
%% \end{table}

\subsubsection{the ftyp atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & 32 \\
atom type & 32 & `ftyp' (\texttt{0x66747970}) \\
\hline
major brand & 32 & `M4A ' (\texttt{0x4d344120}) \\
major brand version & 32 & \texttt{0} \\
compatible brand & 32 & `M4A ' (\texttt{0x4d344120}) \\
compatible brand & 32 & `mp42' (\texttt{0x6d703432}) \\
compatible brand & 32 & `isom' (\texttt{0x69736f6d}) \\
compatible brand & 32 & \texttt{0x00000000} \\
\hline
\end{tabular}
\end{table}

\subsubsection{the moov atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & \ATOM{mvhd} size + \ATOM{trak} size + \ATOM{udta} size + 8 \\
atom type & 32 & `moov' (\texttt{0x6d6f6f76}) \\
\hline
\ATOM{mvhd} atom & \ATOM{mvhd} size & \ATOM{mvhd} data \\
\ATOM{trak} atom & \ATOM{trak} size & \ATOM{trak} data \\
\ATOM{udta} atom & \ATOM{udta} size & \ATOM{udta} data \\
\hline
\end{tabular}
\end{table}

\clearpage

\subsubsection{the mvhd atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & 108/120 \\
atom type & 32 & `mvhd' (\texttt{0x6d766864}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
created date & 32/64 & creation date as Mac UTC \\
modified date & 32/64 & modification date as Mac UTC \\
time scale & 32 & sample rate \\
duration & 32/64 & total PCM frames \\
playback speed & 32 & \texttt{0x10000} \\
user volume & 16 & \texttt{0x100} \\
padding & 80 & \texttt{0x00000000000000000000} \\
window geometry matrix a & 32 & \texttt{0x10000} \\
window geometry matrix b & 32 & \texttt{0} \\
window geometry matrix u & 32 & \texttt{0} \\
window geometry matrix c & 32 & \texttt{0} \\
window geometry matrix d & 32 & \texttt{0x10000} \\
window geometry matrix v & 32 & \texttt{0} \\
window geometry matrix x & 32 & \texttt{0} \\
window geometry matrix y & 32 & \texttt{0} \\
window geometry matrix x & 32 & \texttt{0x40000000} \\
QuickTime preview & 64 & \texttt{0} \\
QuickTime still poster & 32 & \texttt{0} \\
QuickTime selection time & 64 & \texttt{0} \\
QuickTime current time & 32 & \texttt{0} \\
next track ID & 32 & \texttt{2} \\
\hline
\end{tabular}
\end{table}

If \VAR{version} is 0, \VAR{created date}, \VAR{modified date} and
\VAR{duration} are 32 bit fields.
Otherwise, they are 64 bit fields.
The \VAR{created date} and \VAR{modified date} are seconds
since the Macintosh Epoch, which is 00:00:00, January 1st, 1904.\footnote{Why 1904?  It's the first leap year of the 20th century.}
To convert a Unix Epoch timestamp (seconds since January 1st, 1970) to
a Macintosh Epoch, one needs to add 24,107 days -
or \texttt{2082844800} seconds.

\clearpage

\subsubsection{the trak atom}
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & \ATOM{tkhd} size + \ATOM{mdia} size + 8 \\
atom type & 32 & `trak' (\texttt{0x7472616b}) \\
\hline
\ATOM{tkhd} atom & \ATOM{tkhd} size & \ATOM{tkhd} data \\
\ATOM{mdia} atom & \ATOM{mdia} size & \ATOM{mdia} data \\
\hline
\end{tabular}

\subsubsection{the tkhd atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & 92/104 \\
atom type & 32 & `tkhd' (\texttt{0x746b6864}) \\
\hline
version & 8 & \texttt{0x00} \\
padding & 20 & \texttt{0x000000} \\
track in poster & 1 & \texttt{0} \\
track in preview & 1 & \texttt{1} \\
track in movie & 1 & \texttt{1} \\
track enabled & 1 & \texttt{1} \\
created date & 32/64 & creation date as Mac UTC \\
modified date & 32/64 & modification date as Mac UTC \\
track ID & 32 & \texttt{1} \\
padding & 32 & \texttt{0x00000000} \\
duration & 32/64 & total PCM frames \\
padding & 64 & \texttt{0x0000000000000000} \\
video layer & 16 & \texttt{0} \\
QuickTime alternate & 16 & \texttt{0} \\
volume & 16 & \texttt{0x1000} \\
padding & 16 & \texttt{0x0000} \\
video geometry matrix a & 32 & \texttt{0x10000} \\
video geometry matrix b & 32 & \texttt{0} \\
video geometry matrix u & 32 & \texttt{0} \\
video geometry matrix c & 32 & \texttt{0} \\
video geometry matrix d & 32 & \texttt{0x10000} \\
video geometry matrix v & 32 & \texttt{0} \\
video geometry matrix x & 32 & \texttt{0} \\
video geometry matrix y & 32 & \texttt{0} \\
video geometry matrix w & 32 & \texttt{0x40000000} \\
video width & 32 & \texttt{0} \\
video height & 32 & \texttt{0} \\
\hline
\end{tabular}
\end{table}

\clearpage

\subsubsection{the mdia atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & \ATOM{mdhd} size + \ATOM{hdlr} size + \ATOM{minf} size + 8 \\
atom type & 32 & `mdia' (0x6d646961) \\
\hline
\ATOM{mdhd} atom & \ATOM{mdhd} size & \ATOM{mdhd} data \\
\ATOM{hdlr} atom & \ATOM{hdlr} size & \ATOM{hdlr} data \\
\ATOM{minf} atom & \ATOM{minf} size & \ATOM{minf} data \\
\hline
\end{tabular}
\end{table}

\subsubsection{the mdhd atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & 32/44 \\
atom type & 32 & `mdhd' (0x6d646864) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
created date & 32/64 & creation date as Mac UTC \\
modified date & 32/64 & modification date as Mac UTC \\
time scale & 32 & sample rate \\
duration & 32/64 & total PCM frames \\
padding & 1 & \texttt{0} \\
language & 5 & \\
language & 5 & language value as ISO 639-2 \\
language & 5 & \\
QuickTime quality & 16 & \texttt{0} \\
\hline
\end{tabular}
\end{table}
Note the three, 5-bit \VAR{language} fields.
By adding 0x60 to each value and converting the result to ASCII characters,
the result is an \href{http://www.loc.gov/standards/iso639-2/}{ISO 639-2}
string of the file's language representation.
For example, given the values \texttt{0x15}, \texttt{0x0E} and \texttt{0x04}:
\begin{align*}
\text{language}_0 &= \texttt{0x15} + \texttt{0x60} = \texttt{0x75} = \texttt{u} \\
\text{language}_1 &= \texttt{0x0E} + \texttt{0x60} = \texttt{0x6E} = \texttt{n} \\
\text{language}_2 &= \texttt{0x04} + \texttt{0x60} = \texttt{0x64} = \texttt{d}
\end{align*}
Which is the code `\texttt{und}', meaning `undetermined' - which is typical.

\clearpage

\subsubsection{the hdlr atom}
\label{alac_hdlr}
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & 33 + component \\
atom type & 32 & `hdlr' (\texttt{0x68646c72}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
QuickTime type & 32 & \texttt{0x00000000} \\
QuickTime subtype & 32 & `soun' (\texttt{0x736f756e}) \\
QuickTime manufacturer & 32 & \texttt{0x00000000} \\
QuickTime component reserved flags & 32 & \texttt{0x00000000} \\
QuickTime component reserved flags mask & 32 & \texttt{0x00000000} \\
component name length & 8 & \texttt{0x00} \\
component name & component name length $\times$ 8 & \\
\hline
\end{tabular}


\subsubsection{the minf atom}
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & \ATOM{smhd} size + \ATOM{dinf} size + \ATOM{stbl} size + 8 \\
atom type & 32 & `minf' (\texttt{0x6d696e66}) \\
\hline
\ATOM{smhd} atom & \ATOM{smhd} size & \ATOM{smhd} data \\
\ATOM{dinf} atom & \ATOM{dinf} size & \ATOM{dinf} data \\
\ATOM{stbl} atom & \ATOM{stbl} size & \ATOM{stbl} data \\
\hline
\end{tabular}

\subsubsection{the smhd atom}
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & 16 \\
atom type & 32 & `smhd' (\texttt{0x736d6864}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
audio balance & 16 & \texttt{0x0000} \\
padding & 16 & \texttt{0x0000} \\
\hline
\end{tabular}

\subsubsection{the dinf atom}
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & \ATOM{dref} size + 8 \\
atom type & 32 & `dinf' (\texttt{0x64696e66}) \\
\hline
\ATOM{dref} atom & \ATOM{dref} size & \ATOM{dref} data \\
\hline
\end{tabular}

\clearpage

\subsubsection{the dref atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & 28 \\
atom type & 32 & `dref' (\texttt{0x64726566}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
number of references & 32 & \texttt{1} \\
\hline
\hline
reference atom size & 32 & \texttt{12} \\
reference atom type & 32 & `url ' (\texttt{0x75726c20}) \\
reference atom data & 32 & \texttt{0x00000001} \\
\hline
\end{tabular}
\end{table}

\subsubsection{the stbl atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & \ATOM{stsd} size + \ATOM{stts} size + \ATOM{stsc} size + \\
& & \ATOM{stsz} size + \ATOM{stco} size + 8 \\
atom type & 32 & `stbl' (0x7374626c) \\
\hline
\ATOM{stsd} atom & \ATOM{stsd} size & \ATOM{stsd} data \\
\ATOM{stts} atom & \ATOM{stts} size & \ATOM{stts} data \\
\ATOM{stsc} atom & \ATOM{stsc} size & \ATOM{stsc} data \\
\ATOM{stsz} atom & \ATOM{stsz} size & \ATOM{stsz} data \\
\ATOM{stco} atom & \ATOM{stco} size & \ATOM{stco} data \\
\hline
\end{tabular}
\end{table}

\subsubsection{the stsd atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & \ATOM{alac} size + 16 \\
atom type & 32 & `stsd' (\texttt{0x73747364}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
number of descriptions & 32 & \texttt{1} \\
\hline
\ATOM{alac} atom & \ATOM{alac} size & \ATOM{alac} data \\
\hline
\end{tabular}
\end{table}

\clearpage

\subsubsection{the alac atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & 72 \\
atom type & 32 & `alac' (\texttt{0x616c6163}) \\
\hline
reserved & 48 & \texttt{0x000000000000} \\
reference index & 16 & \texttt{1} \\
version & 16 & \texttt{0} \\
revision level & 16 & \texttt{0} \\
vendor & 32 & \texttt{0x00000000} \\
channels & 16 & channel count \\
bits per sample & 16 & bits per sample \\
compression ID & 16 & \texttt{0} \\
audio packet size & 16 & \texttt{0} \\
%FIXME
%not entirely sure on this one.  it might be a float
sample rate & 16 & sample rate \\
padding & 16 & \texttt{0x0000} \\
\hline
\hline
atom length & 32 & 36 \\
atom type & 32 & `alac' (\texttt{0x616c6163}) \\
\hline
padding & 32 & \texttt{0x00000000} \\
max samples per frame & 32 & largest number of PCM frames per ALAC frame \\
padding & 8 & \texttt{0x00} \\
sample size & 8 & bits per sample \\
history multiplier & 8 & FIXME \\
initial history & 8 & FIXME \\
maximum K & 8 & FIXME \\
channels & 8 & channel count \\
unknown & 16 & \texttt{0x00FF} \\
%FIXME - double check this
max coded frame size & 32 & largest ALAC frame size, in bytes \\
bitrate & 32 & $((\text{\ATOM{mdat} size} \times 8 ) \div (\text{total frames} \div \text{sample rate}))$ \\
sample rate & 32 & sample rate \\
\hline
\end{tabular}
\end{table}
Note that the \VAR{history multiplier}, \VAR{initial history},
\VAR{maximum K} and \VAR{bitrate} fields can't be known in advance;
we must fill those values with 0s for now and then
return to this atom once encoding is completed
and those values have been determined.

\clearpage

\subsubsection{the stts atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & number of times $\times$ 8 + 16\\
atom type & 32 & `stts' (\texttt{0x73747473}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
number of times & 32 & \\
\hline
frame count 1 & 32 & number of occurrances \\
frame duration 1 & 32 & PCM frame count \\
\hline
\multicolumn{3}{|c|}{...} \\
\hline
\end{tabular}
\end{table}
This atom keeps track of how many different sizes of ALAC frames
occur in the ALAC file, in PCM frames.
It will typically have only two ``times'', the block size we're
using for most of our samples and the final block size for
any remaining samples.

For example, let's imagine encoding a 1 minute audio file
at 44100Hz with a block size of 4096 frames.
This file has a total of 2,646,000 PCM frames ($60 \times 44100 = 2646000$).
2,646,000 PCM frames divided by a 4096 block size means
we have 645 ALAC frames of size 4096, and 1 ALAC frame of size 4080.

Therefore:
\begin{align*}
\text{number of times} &= 2 \\
\text{frame count}_1 &= 645 \\
\text{frame duration}_1 &= 4096 \\
\text{frame count}_2 &= 1 \\
\text{frame duration}_2 &= 4080
\end{align*}

\subsubsection{the stsc atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & entries $\times$ 12 + 16 \\
atom type & 32 & `stsc' (\texttt{0x73747363}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
number of entries & 32 & \\
\hline
first chunk & 32 & \\
ALAC frames per chunk & 32 & \\
description index & 32 & \texttt{1} \\
\hline
\multicolumn{3}{|c|}{...} \\
\hline
\end{tabular}
\end{table}

This atom stores how many ALAC frames are in a given ``chunk''.
In this instance each ``chunk'' represents an entry in
the \ATOM{stco} atom table, used for seeking backwards and forwards
through the file.
\VAR{First chunk} is the starting offset of its frames-per-chunk
value, beginning at 1.

As an example, let's take a one minute, 44100Hz audio file
that's been broken into 130 chunks
(each with an entry in the \ATOM{stco} atom).
Its \ATOM{stco} entries would typically be:
\begin{align*}
\text{first chunk}_1 &= 1 \\
\text{frames per chunk}_1 &= 5 \\
\text{first chunk}_2 &= 130 \\
\text{frames per chunk}_2 &= 1
\end{align*}
What this means is that chunks 1 through 129 have 5 ALAC frames each
while frame 130 has 1 ALAC frame.
This is a total of 646 ALAC frames, which matches the contents of
the \ATOM{stts} atom.

\subsubsection{the stsz atom}

\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & sizes $\times$ 4 + 16 \\
atom type & 32 & `stsz' (\texttt{0x7374737a}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
number of sizes & 32 & \\
\hline
frame size & 32 & \\
\hline
\multicolumn{3}{|c|}{...} \\
\hline
\end{tabular}

This atom is a list of ALAC frame sizes, each in bytes.
For example, our 646 frame file would have 646 corresponding
\ATOM{stsz} entries.

\subsubsection{the stco atom}

\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & offset $\times$ 4 + 16 \\
atom type & 32 & `stco' (\texttt{0x7374636f}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
number of offsets & 32 & \\
\hline
frame offset & 32 & \\
\hline
\multicolumn{3}{|c|}{...} \\
\hline
\end{tabular}

This atom is a list of absolute file offsets for each chunk, where
each chunk is typically 5 ALAC frames large.

\clearpage

\subsubsection{the udta atom}

\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & \ATOM{meta} size + 8 \\
atom type & 32 & `udta' (\texttt{0x75647461}) \\
\hline
\ATOM{meta} atom & \ATOM{meta} size & \ATOM{meta} data \\
\hline
\end{tabular}

\subsubsection{the meta atom}

\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & \ATOM{ftyp} size + \ATOM{ilst} size + \ATOM{free} size + 12 \\
atom type & 32 & `meta' (\texttt{0x6d657461}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
\hline
\ATOM{ftyp} atom & \ATOM{ftyp} size & \ATOM{ftyp} data \\
\ATOM{ilst} atom & \ATOM{ilst} size & \ATOM{ilst} data \\
\ATOM{free} atom & \ATOM{free} size & \ATOM{free} data \\
\hline
\end{tabular}

\subsubsection{the hdlr atom (revisited)}

\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & 34 \\
atom type & 32 & `hdlr' (\texttt{0x68646c72}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
QuickTime type & 32 & \texttt{0x00000000} \\
QuickTime subtype & 32 & `mdir' (\texttt{0x6d646972}) \\
QuickTime manufacturer & 32 & `appl' (\texttt{0x6170706c}) \\
QuickTime component reserved flags & 32 & \texttt{0x00000000} \\
QuickTime component reserved flags mask & 32 & \texttt{0x00000000} \\
component name length & 8 & \texttt{0x00} \\
component name & 0 & \\
\hline
\end{tabular}

This atom is laid out identically to the ALAC file's primary
\ATOM{hdlr} atom (described on page \pageref{alac_hdlr}).
The only difference is the contents of its fields.

\subsubsection{the ilst atom}

This atom is a collection of \ATOM{data} sub-atoms
and is described on page \pageref{m4a_meta}.
%FIXME - ilst probably has required fields
%which I need to figure out and explain here

\subsubsection{the free atom}

These atoms are simple collection of NULL bytes which can easily be
resized to make room for other atoms without rewriting the entire file.


\chapter{Apple Lossless}

Apple's lossless audio codec, informally referred to as ``ALAC'',
is lossless audio inside a QuickTime container - similar to M4A.
Its stream is the same collection of atoms as covered on page
\pageref{m4a}.
The key difference is the contents of its \texttt{mdat} atom.

\section{the ALAC file stream}
\begin{wrapfigure}[6]{r}{1.5in}
\includegraphics{figures/alac_atoms.pdf}
\end{wrapfigure}

This is the typical arrangements of ALAC atoms as encoded by iTunes.
As you can see, it is almost identical to the layout of AAC audio.
One of the key differences is that ALAC's \texttt{stsd} atom
contains an \texttt{alac} description sub-atom rather than an
\texttt{mp4a} description atom.

Its layout is as follows:

\begin{figure}[h]
\includegraphics{figures/alac_alac_atom.pdf}
\end{figure}

\pagebreak

\section{ALAC decoding}

An ALAC stream is made up of individual frames within the \texttt{mdat}
atom, as follows:

\begin{figure}[h]
\includegraphics{figures/alac_stream.pdf}
\end{figure}
\par
\noindent
ALAC frames come in two varieties: compressed and uncompressed,
depending on the \VAR{Is Not Compressed} bit in the frame header.
An uncompressed frame is laid out as follows:

\begin{figure}[h]
\includegraphics{figures/alac_uncompressed_frame.pdf}
\end{figure}
\par
\noindent
The number of PCM frames in an ALAC frame depends on the \VAR{Has Sample Size}
bit.
If set, the number of PCM frames equals the 32-bit \VAR{Sample Size}
value.
If not set, the total number of PCM frames equals the \VAR{Max Coded Frame Size}
value in the \texttt{alac} atom and the \VAR{Sample Size} value is omitted.
ALAC streams typically use the same number of samples per frame
until the end of the stream, at which point the leftover samples
are placed in a different-sized frame.

Uncompressed frames interleave samples between channels during decoding.
For example, a 2 channel frame places $\text{Sample}_1$ on $\text{Channel}_1$,
$\text{Sample}_2$ on $\text{Channel}_2$,
$\text{Sample}_3$ on $\text{Channel}_1$,
$\text{Sample}_4$ on $\text{Channel}_2$ and so on.

Finally, note that all ALAC frames have a footer of the bits `\texttt{111}'
and padding as needed such that each frame begins on an aligned byte boundary.

\pagebreak

A compressed frame is laid out as follows:

\begin{figure}[h]
\includegraphics{figures/alac_compressed_frame.pdf}
\end{figure}
\par
\noindent
\VAR{Interlacing Shift} and \VAR{Interlacing Leftweight} are used
for channel decorrelation after the subframes have been decoded.

There is one subframe header and one residual block per
channel.
If \VAR{Wasted Bits} is greater than 0, there is also
a block of wasted bits samples after the subframe headers but before
the residuals.

\VAR{Wasted Bits} is an attempt to store the least significant bits
of each sample more efficiently at high bits-per-sample, where
that data will often be indistinguishable from random noise.
In effect, it's a block of interlaced uncompressed samples
(similar to an uncompressed ALAC frame) each $8 \times \text{\VAR{Wasted Bits}}$
bits large.
Those wasted bits are then prepended to each sample prior to channel
decorrelation.
I'll explain this process in more detail later.

Each subframe header is laid out as follows:

\begin{figure}[h]
\includegraphics{figures/alac_subframe_header.pdf}
\end{figure}
\par
\noindent
There are \VAR{Coefficient Count} number of coefficients in each
subframe header, each a 16-bit signed value.

\pagebreak

\subsection{Residual decoding}

There are \VAR{Sample Size} number of residuals per residual block.
Decoding a residual block requires knowing the \VAR{Initial History},
\VAR{History Multiplier}, \VAR{Maximum K}, \VAR{Channels}, \VAR{Wasted Bits} and
\VAR{Bits per Sample} values, from the \texttt{alac} atom and frame header.
Fortunately, most of these values are rarely used;
we'll mostly be concerned with the \VAR{History} and \VAR{History Multiplier}.

For each residual block, \VAR{History} starts with the value of
\VAR{Initial History} and will change during residual decoding.
We use it to calculate $\kappa$ using the following formula:
\begin{equation}
\kappa = \left\lfloor\log_2 \left( \frac{\text{history}}{2 ^ 9} + 3 \right) \right\rfloor
\end{equation}
Note that if $\kappa$ exceeds the \VAR{Maximum K} value from the
\texttt{alac} atom, \VAR{Maximum K} is used instead.

We then need to know the \VAR{Bits per Sample} value of the residual
block, which is equal to:
\begin{equation}
\text{Bits per Sample}_{Residual} = \text{Bits per Sample}_{ALAC} - (\text{Wasted Bits} \times 8) + \text{Channels} - 1
\end{equation}
For mono streams, this is typically equal to the stream's
\VAR{Bits per Sample},
while for stereo streams it's often the \VAR{Bits per Sample} plus 1.

\begin{wrapfigure}[14]{r}{2.5in}
\includegraphics{figures/alac_read_residual.pdf}
\end{wrapfigure}
The $\kappa$ and \VAR{Bits per Sample} values are used to read a
single unsigned residual value in the following way:

The initial bit reading portion of the process
involves reading a unary value with a stop bit of `0'
and a maximum value of 8.
If the maximum value is exceeded, we read \VAR{Bits per Sample}
number of bits as our final value
(the only place \VAR{Bits per Sample} is used throughout the
residual decoding process).

Otherwise, we read $\kappa$ number of \VAR{extra} bits if $\kappa > 1$.
If \VAR{extra} is greater than 1, we return
$\text{\VAR{unary}} + (\text{\VAR{extra}} - 1)$.
If not, we push a single \VAR{extra} bit back on the stream and return our
\VAR{unary} value outright.

\clearpage

We perform the following to convert unsigned residuals to signed residuals
which are returned to the subframe decoder:
\begin{equation}
\text{signed} =
\begin{cases}
(\text{unsigned} + 1) \gg 1 & \text{if unsigned is even} \\
-((\text{unsigned} + 1) \gg 1) & \text{if unsigned is odd}
\end{cases}
\end{equation}

Finally, we use our unsigned value to update \VAR{history}
before reading the next residual:
\begin{equation*}
\text{history} =
\begin{cases}
(\text{unsigned} \times \text{history multiplier}) - \left\lfloor\frac{\text{history} \times \text{history multiplier}}{2^9}\right\rfloor & \text{if unsigned} \leq 65535 \\
65535 & \text{if unsigned} > 65535
\end{cases}
\end{equation*}

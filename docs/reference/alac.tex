%This work is licensed under the
%Creative Commons Attribution-Share Alike 3.0 United States License.
%To view a copy of this license, visit
%http://creativecommons.org/licenses/by-sa/3.0/us/ or send a letter to
%Creative Commons,
%171 Second Street, Suite 300,
%San Francisco, California, 94105, USA.

\chapter{Apple Lossless}

Apple's lossless audio codec, informally referred to as ``ALAC'',
is lossless audio inside a QuickTime container - similar to M4A.
Its stream is the same collection of atoms as covered on page
\pageref{m4a}.
The key difference is the contents of its \texttt{mdat} atom.

\section{ALAC Decoding}
\begin{wrapfigure}[6]{r}{1.5in}
\includegraphics{figures/alac/atoms.pdf}
\end{wrapfigure}
The basic process for decoding an ALAC file is as follows:
\par
\begin{wrapfigure}[6]{l}{4.5in}
{\relsize{-1}
\ALGORITHM{an ALAC encoded file}{PCM samples}
read \texttt{alac} atom to obtain decoding parameters\;
read \texttt{mdhd} atom to obtain $PCM~frame~count$\;
seek to \texttt{mdat} atom's data\;
\While{$PCM~frame~count > 0$}{
  decode ALAC frameset to 1 or more PCM frames\;
  deduct ALAC frameset's samples from stream's $PCM~frame~count$\;
  return decoded PCM frames\;
}
\EALGORITHM
}
\par
Seeking to a particular atom within the ALAC file is a recursive
process.
Each ALAC atom is laid out as follows:
\vskip .1in
\includegraphics{figures/alac/atom.pdf}
\vskip .1in
where \VAR{atom length} is the full size of the atom in bytes,
including the 8 byte atom header.
\VAR{atom type} is an ASCII string
\VAR{atom data} is a binary blob of data
which may contain one or more sub-atoms.
\end{wrapfigure}

\clearpage

\subsection{Parsing the alac Atom}

The \texttt{stsd} atom contains a single \texttt{alac} atom
which contains an \texttt{alac} sub-atom of its own.
\begin{figure}[h]
\includegraphics{figures/alac/alac_atom.pdf}
\end{figure}
\par
\noindent
Many of these fields appear redundant between the outer \texttt{alac} atom
and the inner sub-atom.
However, for proper decoding, one must ignore the outer atom entirely
and use only the parameters from the innermost \texttt{alac} atom.

Of these, we'll be interested in \VAR{samples per frame},
\VAR{bits per sample}, \VAR{history multiplier}, \VAR{initial history},
\VAR{maximum K}, \VAR{channels} and \VAR{sample rate}.
The others can safely be ignored.

\clearpage

For example, given the bytes:
\par
\begin{figure}[h]
\includegraphics{figures/alac/alac-atom-parse.pdf}
\end{figure}
\begin{tabular}{rcrcl}
$alac~length$ & $\leftarrow$ & \texttt{00000024} & = & 36 \\
$alac$ & $\leftarrow$ & \texttt{616C6163} & = & \texttt{"alac"} \\
$padding$ & $\leftarrow$ & \texttt{00000000} & = & 0 \\
samples per frame & $\leftarrow$ & \texttt{00001000} & = & 4096 \\
compatible version & $\leftarrow$ & \texttt{00} & = & 0 \\
bits per sample & $\leftarrow$ & \texttt{10} & = & 16 \\
history multiplier & $\leftarrow$ & \texttt{28} & = & 40 \\
initial history & $\leftarrow$ & \texttt{0A} & = & 10 \\
maximum K & $\leftarrow$ & \texttt{0E} & = & 14 \\
channels & $\leftarrow$ & \texttt{02} & = & 2 \\
max run & $\leftarrow$ & \texttt{FF} & = & 255 \\
max coded frame size & $\leftarrow$ & \texttt{24} & = & 36 bytes \\
bitrate & $\leftarrow$ & \texttt{0AC4} & = & 2756 \\
sample rate & $\leftarrow$ & \texttt{0000AC44} & = & 44100 Hz\\
\end{tabular}

\clearpage

\subsection{Parsing the mdhd atom}
\begin{figure}[h]
\includegraphics{figures/alac/mdhd.pdf}
\end{figure}
\par
\noindent
\VAR{version} indicates whether the Mac UTC date fields are 32 or 64 bit.
These date fields are seconds since the Macintosh Epoch,
which is 00:00:00, January 1st, 1904.\footnote{Why 1904?
 It's the first leap year of the 20th century.}
To convert the Macintosh Epoch to a Unix Epoch timestamp
(seconds since January 1st, 1970), one needs to subtract 24,107 days -
or \texttt{2082844800} seconds.
\par
\noindent
\VAR{track length} is the total length of the ALAC file, in PCM frames.
\par
\noindent
\VAR{language} is 3, 5 bit fields encoded as ISO 639-2.
Add 96 to each field to convert the value to ASCII.

\clearpage

For example, given the bytes:
\begin{figure}[h]
\includegraphics{figures/alac/mdhd-parse.pdf}
\end{figure}
\par
\noindent
\begin{tabular}{rcrcll}
created MAC UTC date & $\leftarrow$ & \texttt{CA6BF4A9} & = & 3396072617 \\
modified MAC UTC date & $\leftarrow$ & \texttt{CA6BFF5E} & = & 3396075358 \\
sample rate & $\leftarrow$ & \texttt{0000AC44} & = & 44100 Hz \\
PCM frame count & $\leftarrow$ & \texttt{8EACE80} & = & 149606016 & \texttt{56m 32s} \\
$\text{language}_0$ & $\leftarrow$ & \texttt{15} & = & 21 & + 96 = `\texttt{u}'\\
$\text{language}_1$ & $\leftarrow$ & \texttt{0E} & = & 14 & + 96 = `\texttt{n}'\\
$\text{language}_2$ & $\leftarrow$ & \texttt{04} & = & 4 & + 96 = `\texttt{d}'\\
\end{tabular}
\vskip .15in
\par
\noindent
Note that the language field is typically \texttt{und},
meaning ``undetermined''.

\clearpage

\subsection{Decoding ALAC Frameset}
ALAC framesets contain multiple frames,
each of which contains 1 or 2 subframes.
\par
\noindent
\ALGORITHM{\texttt{mdat} atom data, decoding parameters from \texttt{alac} atom}{decoded PCM frames}
$channels \leftarrow$ (\READ 3 unsigned bits) + 1\;
\While{$channels \neq 8$}{
  decode ALAC frame to 1 or 2 channels of PCM data\;
  $channels \leftarrow$ (\READ 3 unsigned bits) + 1\;
}
byte-align file stream\;
\Return all frames' channels as PCM frames\;
\EALGORITHM
\begin{figure}[h]
\includegraphics{figures/alac/stream.pdf}
\end{figure}

\clearpage

\subsection{Decoding ALAC Frame}
{\relsize{-1}
\ALGORITHM{\texttt{mdat} atom data, channel count, decoding parameters from \texttt{alac} atom}{1 or 2 decoded channels of PCM data}
\SKIP 16 bits\;
$has~sample~count \leftarrow$ \READ 1 unsigned bit\;
$uncompressed~LSBs \leftarrow$ \READ 2 unsigned bits\;
$not~compressed \leftarrow$ \READ 1 unsigned bit\;
\eIf{$has~sample~count = 0$}{
  sample count $\leftarrow$ samples per frame from \texttt{alac} atom\;
}{
  sample count $\leftarrow$ \READ 32 unsigned bits\;
}
\eIf(\tcc*[f]{raw, uncompressed frame}){$not~compressed = 1$}{
  \For{i = 0 \emph{\KwTo}sample count}{
    \For{c = 0 \emph{\KwTo}channel count}{
      \tcc{bits per sample taken from alac atom}
      $\text{channel}_{c~i} \leftarrow$ \READ (bits per sample) signed bits\;
    }
  }
}(\tcc*[f]{compressed frame}){
  interlacing shift $\leftarrow$ \READ 8 unsigned bits\;
  interlacing leftweight $\leftarrow$ \READ 8 unsigned bits\;
  \For{c = 0 \emph{\KwTo}channel count}{
    $\text{subframe header}_c \leftarrow$ read subframe header\;
  }
  \If{$uncompressed~LSBs > 0$}{
    \For{i = 0 \emph{\KwTo}sample count}{
      \For{c = 0 \emph{\KwTo}channel count}{
        $\text{LSBs}_{c~i} \leftarrow$ \READ ($uncompressed~LSBs \times 8$) unsigned bits\;
      }
    }
  }
  \For{c = 0 \emph{\KwTo}channel count}{
    $\text{residual block}_c \leftarrow$ read residual block where sample size is $\text{bits per sample} - (uncompressed~LSBs \times 8) + (\text{channel count} - 1)$\;
    decode $\text{subframe}_c$ from $\text{subframe header}_c$ and $\text{residual block}_c$\;
  }
  \eIf{$channel~count = 2$}{
    decorrelate $\text{subframe}_0$ and $\text{subframe}_1$ to $\text{channel}_0$ and $\text{channel}_1$ according to interlacing shift and interlacing leftweight\;
  }{
    \For{c = 0 \emph{\KwTo}channel count}{
      $\text{channel}_c \leftarrow \text{subframe}_c$\;
    }
  }
  \If{$uncompressed~LSBs > 0$}{
    \For{c = 0 \emph{\KwTo}channel count}{
      \For{i = 0 \emph{\KwTo}sample count}{
        $\text{channel}_{c~i} \leftarrow (\text{channel}_{c~i} \times 2 ^ {uncompressed~LSBs \times 8}) + \text{LSB}_{c~i}$\;
      }
    }
  }
}
\Return channel data\;
\EALGORITHM
}


\clearpage

\subsection{Reading Subframe Header}
\ALGORITHM{\texttt{mdat} atom data}{subframe decoding parameters}
$prediction~type \leftarrow$ \READ 4 unsigned bits\tcc*[r]{must be 0}
QLP shift needed $\leftarrow$ \READ 4 unsigned bits\;
Rice modifier $\leftarrow$ \READ 3 unsigned bits\tcc*[r]{unusued}
$\text{coefficient count} \leftarrow$ \READ 5 unsigned bits\tcc*[r]{always 4 or 8}
\For{i = 0 \emph{\KwTo}coefficient count}{
  $\text{QLP coefficient}_i \leftarrow$ \READ 16 signed bits\;
}
\Return QLP shift needed, QLP coefficients
\EALGORITHM
\begin{figure}[h]
\includegraphics{figures/alac/subframe_header.pdf}
\end{figure}
\par
\noindent
For example, given the bytes on the opposite page,
our frame and subframe headers are:
\begin{table}[h]
{\relsize{-1}
\begin{tabular}{rclcl}
\multicolumn{5}{l}{frame header:} \\
$channels$ & $\leftarrow$ & \texttt{0} (+1) &=& 2 \\
$has~sample~count$ & $\leftarrow$ & \texttt{1} \\
$uncompressed~LSBs$ & $\leftarrow$ & \texttt{0} \\
$not~compressed$ & $\leftarrow$ & \texttt{0} \\
sample count & $\leftarrow$ & \texttt{0x19} &=& 25 \\
interlacing shift & $\leftarrow$ & \texttt{2} \\
interlacing leftweight & $\leftarrow$ & \texttt{2} \\
\hline
\multicolumn{5}{l}{subframe header 0:} \\
$prediction~type_0$ & $\leftarrow$ & \texttt{0} \\
$\text{QLP shift needed}_0$ & $\leftarrow$ & \texttt{9} \\
$\text{Rice modifier}_0$ & $\leftarrow$ & \texttt{4} \\
$\text{coefficient count}_0$ & $\leftarrow$ & \texttt{4} \\
$\text{coefficient}_{0~0}$ & $\leftarrow$ & \texttt{0x05A6} &=& 1446 \\
$\text{coefficient}_{0~1}$ & $\leftarrow$ & \texttt{0xF943} &=& -1725 \\
$\text{coefficient}_{0~2}$ & $\leftarrow$ & \texttt{0x0430} &=& 1072 \\
$\text{coefficient}_{0~3}$ & $\leftarrow$ & \texttt{0xFECF} &=& -305 \\
\hline
\multicolumn{5}{l}{subframe header 1:} \\
$prediction~type_1$ & $\leftarrow$ & \texttt{0} \\
$\text{QLP shift needed}_1$ & $\leftarrow$ & \texttt{9} \\
$\text{Rice modifier}_1$ & $\leftarrow$ & \texttt{4} \\
$\text{coefficient count}_1$ & $\leftarrow$ & \texttt{4} \\
$\text{coefficient}_{1~0}$ & $\leftarrow$ & \texttt{0x0587} &=& 1415 \\
$\text{coefficient}_{1~1}$ & $\leftarrow$ & \texttt{0xF987} &=& -1657 \\
$\text{coefficient}_{1~2}$ & $\leftarrow$ & \texttt{0x03F3} &=& 1011 \\
$\text{coefficient}_{1~3}$ & $\leftarrow$ & \texttt{0xFEE5} &=& -283 \\
\end{tabular}
}
\end{table}

\clearpage

\begin{figure}[h]
\includegraphics{figures/alac/subframe-parse.pdf}
\caption{mdat atom bytes}
\end{figure}

\clearpage

\subsection{Reading Residual Block}
\ALGORITHM{\texttt{mdat} atom data, initial history and maximum K from \texttt{alac} atom, sample count, sample size}{a decoded list of signed residuals}
\SetKwData{SIGN}{sign modifier}
\SetKwData{HISTORY}{history}
\SetKwData{HISTORYMULT}{history multiplier}
\SetKwData{ZEROES}{zero residuals count}
\SetKw{AND}{and}
\SetKwFunction{MIN}{min}
\SetKwFunction{READRESIDUAL}{read residual}
\HISTORY $\leftarrow$ initial history\;
\SIGN $\leftarrow 0$\;
\For{i = 0 \emph{\KwTo}sample count}{
  $\kappa \leftarrow \MIN(\lfloor\log_2(\HISTORY \div 2 ^ 9 + 3)\rfloor~,~\text{maximum K})$\;
  $\text{unsigned}_i \leftarrow \READRESIDUAL(\kappa~,~\text{sample size}) + \SIGN$\;
  \SIGN $\leftarrow 0$\;
  \BlankLine
  \eIf(\tcc*[f]{apply sign bit}){$\text{unsigned}_i$ is even}{
    $\text{residual}_i \leftarrow \text{unsigned}_i \div 2$\;
  }{
    $\text{residual}_i \leftarrow -((\text{unsigned}_i + 1) \div 2)$\;
  }
  \BlankLine
  \eIf(\tcc*[f]{update history}){$\text{unsigned}_i \leq 65535$}{
    \HISTORY $\leftarrow \HISTORY + (\text{unsigned}_i \times \HISTORYMULT) - \left\lfloor\frac{\HISTORY \times \HISTORYMULT}{2 ^ 9}\right\rfloor$\;
    \If{$\HISTORY < 128$ \AND $(i + 1) < sample~count$}{
      \tcc{generate run of 0 residuals if history gets too small}
      $\kappa \leftarrow \MIN(7 - \lfloor\log_2(\HISTORY)\rfloor + ((\HISTORY + 16) \div 64)~,~\text{maximum K})$\;
      \ZEROES $\leftarrow \READRESIDUAL(\kappa~,~16)$\;
      \For{j = 0 \emph{\KwTo}\ZEROES}{
        $\text{residual}_{i + j + 1} \leftarrow 0$\;
      }
      $i \leftarrow i + j$\;
      \HISTORY $\leftarrow 0$\;
      \If{$\ZEROES \leq 65535$}{
        \SIGN $\leftarrow 1$\;
      }
    }
  }{
    \HISTORY $\leftarrow 65535$\;
  }
}
\Return signed residual values\;
\EALGORITHM

\clearpage

\subsubsection{Reading Residual}
\ALGORITHM{\texttt{mdat} atom data, $\kappa$, sample size}{an unsigned residual}
\SetKwData{MSB}{MSB}
\SetKwData{LSB}{LSB}
\SetKw{UNREAD}{unread}
\MSB $\leftarrow$ \UNARY with stop bit 0, to a maximum of 8 bits\;
\uIf{9, \texttt{1} bits encountered}{
  \Return \READ (sample size) unsigned bits\;
}
\uElseIf{$\kappa = 0$}{
  \Return \MSB\;
}
\Else{
  \LSB $\leftarrow$ \READ $\kappa$ unsigned bits\;
  \uIf{$\LSB > 1$}{
    \Return $\MSB \times (2 ^ \kappa - 1) + (\LSB - 1)$\;
  }
  \uElseIf{$\LSB = 1$}{
    \UNREAD single \texttt{1} bit back into stream\;
    \Return $\MSB \times (2 ^ \kappa - 1)$\;
  }
  \Else{
    \UNREAD single \texttt{0} bit back into stream\;
    \Return $\MSB \times (2 ^ \kappa - 1)$\;
  }
}
\EALGORITHM

\begin{landscape}
\subsubsection{Residual Decoding Example}
For this example, \VAR{initial history} (from the \texttt{alac} atom) is 10.
\par
\begin{figure}[h]
\includegraphics{figures/alac/residual-parse.pdf}
\end{figure}
\par
\noindent
Note how unreading a bit when $i = 1$ means that $\text{LSB}_1$'s 3rd bit
(a \texttt{1} in this case) is also $\text{MSB}_2$'s 1st bit.
This is signified by $\text{}_1 \leftrightarrow \text{}_2$
since the same bit is in both fields.

\clearpage

\begin{table}[h]
{\relsize{-1}
\renewcommand{\arraystretch}{1.25}
\begin{tabular}{r||>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}}
$i$ & \kappa & \text{MSB}_i & \text{LSB}_i & \text{unsigned}_i &
\text{residual}_i & \text{history}_{i + 1} \\
\hline
0 &
\lfloor\log_2(10 \div 2 ^ 9 + 3)\rfloor = 1 &
9 & & 64 &
64 \div 2 = 32 &
10 + (64 \times 40) - \left\lfloor\frac{10 \times 40}{2 ^ 9}\right\rfloor = 2570
\\
1 &
\lfloor\log_2(2570 \div 2 ^ 9 + 3)\rfloor = 3 &
2 & *1 & 2 \times (2 ^ 3 - 1) = 14 &
14 \div 2 = 7 &
2570 + (14 \times 40) - \left\lfloor\frac{2570 \times 40}{2 ^ 9}\right\rfloor = 2930
\\
2 &
\lfloor\log_2(2930 \div 2 ^ 9 + 3)\rfloor = 3 &
1 & 2 & 1 \times (2 ^ 3 - 1) + (2 - 1) = 8 &
8 \div 2 = 4 &
2930 + (8 \times 40) - \left\lfloor\frac{2930 \times 40}{2 ^ 9}\right\rfloor = 3022
\\
3 &
\lfloor\log_2(3022 \div 2 ^ 9 + 3)\rfloor = 3 &
0 & 5 & 0 \times (2 ^ 3 - 1) + (5 - 1) = 4 &
4 \div 2 = 2 &
3022 + (4 \times 40) - \left\lfloor\frac{3022 \times 40}{2 ^ 9}\right\rfloor = 2946
\\
4 &
\lfloor\log_2(2946 \div 2 ^ 9 + 3)\rfloor = 3 &
0 & 2 & 0 \times (2 ^ 3 - 1) + (2 - 1) = 1 &
-((1 + 1) \div 2) = -1 &
2946 + (1 \times 40) - \left\lfloor\frac{2946 \times 40}{2 ^ 9}\right\rfloor = 2756
\\
5 &
\lfloor\log_2(2756 \div 2 ^ 9 + 3)\rfloor = 3 &
0 & 2 & 0 \times (2 ^ 3 - 1) + (2 - 1) = 1 &
-((1 + 1) \div 2) = -1 &
2756 + (1 \times 40) - \left\lfloor\frac{2756 \times 40}{2 ^ 9}\right\rfloor = 2581
\\
6 &
\lfloor\log_2(2581 \div 2 ^ 9 + 3)\rfloor = 3 &
0 & 2 & 0 \times (2 ^ 3 - 1) + (2 - 1) = 1 &
-((1 + 1) \div 2) = -1 &
2581 + (1 \times 40) - \left\lfloor\frac{2581 \times 40}{2 ^ 9}\right\rfloor = 2420
\\
7 &
\lfloor\log_2(2420 \div 2 ^ 9 + 3)\rfloor = 2 &
2 & 2 & 2 \times (2 ^ 2 - 1) + (2 - 1) = 7 &
-((7 + 1) \div 2) = -4 &
2420 + (7 \times 40) - \left\lfloor\frac{2420 \times 40}{2 ^ 9}\right\rfloor = 2511
\\
8 &
\lfloor\log_2(2511 \div 2 ^ 9 + 3)\rfloor = 2 &
0 & 2 & 0 \times (2 ^ 2 - 1) + (2 - 1) = 1 &
-((1 + 1) \div 2) = -1 &
2511 + (1 \times 40) - \left\lfloor\frac{2511 \times 40}{2 ^ 9}\right\rfloor = 2355
\\
9 &
\lfloor\log_2(2355 \div 2 ^ 9 + 3)\rfloor = 2 &
2 & 2 & 2 \times (2 ^ 2 - 1) + (2 - 1) = 7 &
-((7 + 1) \div 2) = -4 &
2355 + (7 \times 40) - \left\lfloor\frac{2355 \times 40}{2 ^ 9}\right\rfloor = 2452
\\
10 &
\lfloor\log_2(2452 \div 2 ^ 9 + 3)\rfloor = 2 &
1 & *1 & 1 \times (2 ^ 2 - 1) = 3 &
-((3 + 1) \div 2) = -2 &
2452 + (3 \times 40) - \left\lfloor\frac{2452 \times 40}{2 ^ 9}\right\rfloor = 2381
\\
11 &
\lfloor\log_2(2381 \div 2 ^ 9 + 3)\rfloor = 2 &
1 & 3 & 1 \times (2 ^ 2 - 1) + (3 - 1) = 5 &
-((5 + 1) \div 2) = -3 &
2381 + (5 \times 40) - \left\lfloor\frac{2381 \times 40}{2 ^ 9}\right\rfloor = 2395
\\
12 &
\lfloor\log_2(2395 \div 2 ^ 9 + 3)\rfloor = 2 &
0 & 2 & 0 \times (2 ^ 2 - 1) + (2 - 1) = 1 &
-((1 + 1) \div 2) = -1 &
2395 + (1 \times 40) - \left\lfloor\frac{2395 \times 40}{2 ^ 9}\right\rfloor = 2248
\\
13 &
\lfloor\log_2(2248 \div 2 ^ 9 + 3)\rfloor = 2 &
0 & 2 & 0 \times (2 ^ 2 - 1) + (2 - 1) = 1 &
-((1 + 1) \div 2) = -1 &
2248 + (1 \times 40) - \left\lfloor\frac{2248 \times 40}{2 ^ 9}\right\rfloor = 2113
\\
14 &
\lfloor\log_2(2113 \div 2 ^ 9 + 3)\rfloor = 2 &
0 & 2 & 0 \times (2 ^ 2 - 1) + (2 - 1) = 1 &
-((1 + 1) \div 2) = -1 &
2113 + (1 \times 40) - \left\lfloor\frac{2113 \times 40}{2 ^ 9}\right\rfloor = 1988
\\
15 &
\lfloor\log_2(1988 \div 2 ^ 9 + 3)\rfloor = 2 &
0 & 3 & 0 \times (2 ^ 2 - 1) + (3 - 1) = 2 &
2 \div 2 = 1 &
1988 + (2 \times 40) - \left\lfloor\frac{1988 \times 40}{2 ^ 9}\right\rfloor = 1913
\\
16 &
\lfloor\log_2(1913 \div 2 ^ 9 + 3)\rfloor = 2 &
0 & *0 & 0 \times (2 ^ 2 - 1) = 0 &
0 \div 2 = 0 &
1913 + (0 \times 40) - \left\lfloor\frac{1913 \times 40}{2 ^ 9}\right\rfloor = 1764
\\
17 &
\lfloor\log_2(1764 \div 2 ^ 9 + 3)\rfloor = 2 &
0 & *1 & 0 \times (2 ^ 2 - 1) = 0 &
0 \div 2 = 0 &
1764 + (0 \times 40) - \left\lfloor\frac{1764 \times 40}{2 ^ 9}\right\rfloor = 1627
\\
18 &
\lfloor\log_2(1627 \div 2 ^ 9 + 3)\rfloor = 2 &
2 & *1 & 2 \times (2 ^ 2 - 1) = 6 &
6 \div 2 = 3 &
1627 + (6 \times 40) - \left\lfloor\frac{1627 \times 40}{2 ^ 9}\right\rfloor = 1740
\\
19 &
\lfloor\log_2(1740 \div 2 ^ 9 + 3)\rfloor = 2 &
1 & 2 & 1 \times (2 ^ 2 - 1) + (2 - 1) = 4 &
4 \div 2 = 2 &
1740 + (4 \times 40) - \left\lfloor\frac{1740 \times 40}{2 ^ 9}\right\rfloor = 1765
\\
20 &
\lfloor\log_2(1765 \div 2 ^ 9 + 3)\rfloor = 2 &
0 & 3 & 0 \times (2 ^ 2 - 1) + (3 - 1) = 2 &
2 \div 2 = 1 &
1765 + (2 \times 40) - \left\lfloor\frac{1765 \times 40}{2 ^ 9}\right\rfloor = 1708
\\
21 &
\lfloor\log_2(1708 \div 2 ^ 9 + 3)\rfloor = 2 &
2 & 3 & 2 \times (2 ^ 2 - 1) + (3 - 1) = 8 &
8 \div 2 = 4 &
1708 + (8 \times 40) - \left\lfloor\frac{1708 \times 40}{2 ^ 9}\right\rfloor = 1895
\\
22 &
\lfloor\log_2(1895 \div 2 ^ 9 + 3)\rfloor = 2 &
0 & 3 & 0 \times (2 ^ 2 - 1) + (3 - 1) = 2 &
2 \div 2 = 1 &
1895 + (2 \times 40) - \left\lfloor\frac{1895 \times 40}{2 ^ 9}\right\rfloor = 1827
\\
23 &
\lfloor\log_2(1827 \div 2 ^ 9 + 3)\rfloor = 2 &
2 & *1 & 2 \times (2 ^ 2 - 1) = 6 &
6 \div 2 = 3 &
1827 + (6 \times 40) - \left\lfloor\frac{1827 \times 40}{2 ^ 9}\right\rfloor = 1925
\\
24 &
\lfloor\log_2(1925 \div 2 ^ 9 + 3)\rfloor = 2 &
1 & 2 & 1 \times (2 ^ 2 - 1) + (2 - 1) = 4 &
4 \div 2 = 2 &
1925 + (4 \times 40) - \left\lfloor\frac{1925 \times 40}{2 ^ 9}\right\rfloor = 1935
\\
\end{tabular}
\renewcommand{\arraystretch}{1.0}
}
\end{table}
\end{landscape}

\clearpage

\subsection{Decoding Subframe}
\ALGORITHM{sample count from frame header, QLP coefficients and QLP shift needed from subframe header, signed residuals from residual block}{a list of signed subframe samples}
\SetKwFunction{SIGN}{sign}
\SetKw{BREAK}{break}
\SetKwData{ORIGSIGN}{original sign}
$\text{Sample}_0 \leftarrow \text{Residual}_0$\;
\For{i = 1 \emph{\KwTo}$\text{coefficient count} + 1$}{
  $\text{Sample}_i \leftarrow \text{Residual}_{i} + \text{Sample}_{i - 1}$\;
}
\BlankLine
\For{i = $\text{coefficient count} + 1$ \emph{\KwTo}$\text{sample count}$}{
  $\text{Base Sample}_i \leftarrow \text{Sample}_{i - coeff.~count - 1}$\;
  $\text{LPC Sum}_i \leftarrow \overset{coeff.~count - 1}{\underset{j = 0}{\sum}} \text{QLP Coefficient}_j \times (\text{Sample}_{i - j - 1} - \text{Base Sample}_i)$\;
  $\text{Sample}_i \leftarrow \left\lfloor\frac{\text{LPC Sum}_i + 2 ^ \text{QLP shift needed - 1}}{2 ^ \text{QLP shift needed}}\right\rfloor + \text{Residual}_i + \text{Base Sample}_i$\;
  \BlankLine
  \uIf(\tcc*[f]{modify QLP coefficients}){$\text{Residual}_i > 0$}{
    \For{j = 0 \emph{\KwTo}$\text{coefficient count}$}{
      $diff \leftarrow \text{Base Sample}_i - \text{Samples}_{i - coeff.~count + j}$\;
      $sign \leftarrow \SIGN(diff)$\;
      $\text{QLP Coefficient}_{coeff.~count - j - 1} \leftarrow \text{QLP Coefficient}_{coeff.~count - j - 1} - sign$\;
      $\text{Residual}_i \leftarrow \text{Residual}_i - \left\lfloor\frac{diff \times sign}{2 ^ \text{QLP shift needed}}\right\rfloor \times (j + 1)$\;
      \If{$\text{Residual}_i \leq 0$}{
        \BREAK\;
      }
    }
  }
  \ElseIf{$\text{Residual}_i < 0$}{
    \For{j = 0 \emph{\KwTo}$\text{coefficient count}$}{
      $diff \leftarrow \text{Base Sample}_i - \text{Samples}_{i - coeff.~count + j}$\;
      $sign \leftarrow \SIGN(diff)$\;
      $\text{QLP Coefficient}_{coeff.~count - j - 1} \leftarrow \text{QLP Coefficient}_{coeff.~count - j - 1} + sign$\;
      $\text{Residual}_i \leftarrow \text{Residual}_i - \left\lfloor\frac{diff \times -sign}{2 ^ \text{QLP shift needed}}\right\rfloor \times (j + 1)$\;
      \If{$\text{Residual}_i \geq 0$}{
        \BREAK\;
      }
    }
  }
}
\Return signed sample values\;
\EALGORITHM
where the \texttt{sign} function is defined as:
\begin{equation*}
\texttt{sign}(x) =
\begin{cases}
\texttt{ 1} & \text{if } x > 0 \\
\texttt{ 0} & \text{if } x = 0 \\
\texttt{-1} & \text{if } x < 0
\end{cases}
\end{equation*}

\clearpage

\subsubsection{Decoding Subframe Example}
Given the residuals
\texttt{32, 7, 4, 2, -1, -1, -1, -4, -1, -4, -2},
the QLP coefficients
\texttt{1446, -1725, 1072, -305}
and a QLP shift needed value of \texttt{9},
the subframe samples are calculated as follows:
\begin{table}[h]
{\relsize{-1}
\begin{tabular}{r||r|r|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}}
$i$ & $\text{Residual}_i$ & $\text{Base}_i$ & \text{LPC Sum}_i & \text{Sample}_i & \text{QLP Coeff.}_{(i + 1)~j} \\
\hline
0 & 32 & & & 32 \\
1 & 7 & & & 7 + 32 = 39 \\
2 & 4 & & & 4 + 39 = 43 \\
3 & 2 & & & 2 + 43 = 45 \\
4 & -1 & & & -1 + 45 = 44 \\
\hline
5 & -1 & 32 & 1446 \times (44 - 32) \texttt{ +} & \lfloor(4584 + 2 ^ 8) \div 2 ^ 9\rfloor - 1 + 32 = 40 & 1446 \\
& & & -1725 \times (45 - 32) \texttt{ +}& & -1725 \\
& & & 1072 \times (43 - 32) \texttt{ +} & & 1072 \\
& & & -305 \times (39 - 32) \texttt{~~} & & -305 - 1 = -306 \\
\hline
6 & -1 & 39 & 1446 \times (40 - 39) \texttt{ +} & \lfloor(-1971 + 2 ^ 8) \div 2 ^ 9\rfloor - 1 + 39 = 34 & 1446 \\
& & & -1725 \times (44 - 39) \texttt{ +} & & -1725 \\
& & & 1072 \times (45 - 39) \texttt{ +} & & 1072 \\
& & & -306 \times (43 - 39) \texttt{~~} & & -306 - 1 = -307 \\
\hline
7 & -4 & 43 & 1446 \times (34 - 43) \texttt{ +} & \lfloor(-7381 + 2 ^ 8) \div 2 ^ 9\rfloor - 4 + 43 = 25 & 1446 \\
& & & -1725 \times (40 - 43) \texttt{ +} & & -1725 + 1 = -1724 \\
& & & 1072 \times (44 - 43) \texttt{ +} & & 1072 - 1 = 1071 \\
& & & -307 \times (45 - 43) \texttt{~~} & & -307 - 1 = -308 \\
\hline
8 & -1 & 45 & 1446 \times (25 - 45) \texttt{ +} & \lfloor(-15003 + 2 ^ 8) \div 2 ^ 9\rfloor - 1 + 45 = 15 & 1446 \\
& & & -1724 \times (34 - 45) \texttt{ +} & & -1724 \\
& & & 1071 \times (40 - 45) \texttt{ +} & & 1071 \\
& & & -308 \times (44 - 45) \texttt{~~} & & -308 + 1 = -307 \\
\hline
9 & -4 & 44 & 1446 \times (15 - 44) \texttt{ +} & \lfloor(-18660 + 2 ^ 8) \div 2 ^ 9\rfloor - 4 + 44 = 4 & 1446 \\
& & & -1724 \times (25 - 44) \texttt{ +} & & -1724 + 1 = -1723 \\
& & & 1071 \times (34 - 44) \texttt{ +} & & 1071 + 1 = 1072 \\
& & & -307 \times (40 - 44) \texttt{~~} & & -307 + 1 = -306 \\
\hline
10 & -2 & 40 & 1446 \times (4 - 40) \texttt{ +} & \lfloor(-23225 + 2 ^ 8) \div 2 ^ 9\rfloor - 2 + 40 = -7 & 1446 \\
& & & -1723 \times (15 - 40) \texttt{ +} & & -1723 \\
& & & 1072 \times (25 - 40) \texttt{ +} & & 1072 + 1 = 1073 \\
& & & -306 \times (34 - 40) \texttt{~~} & & -306 + 1 = -305 \\
\hline
\end{tabular}
}
\end{table}

Although some steps have been omitted for brevity,
what's important to note is how the base sample
is removed prior to $\text{LPC Sum}_i$ calculation,
how it is re-added during $\text{Sample}_i$ calculation
and how the next sample's QLP Coefficient values are shifted.

\clearpage

\subsection{Channel Decorrelation}
\ALGORITHM{$\text{subframe samples}_0$, $\text{subframe samples}_1$, interlacing shift and interlacing leftweight from frame header}{left and right channels}
\eIf{$\text{interlacing leftweight} > 0$}{
  \For{i = 0 \emph{\KwTo}sample count}{
    $\text{Right}_i \leftarrow \text{Subframe}_{0~i} - \left\lfloor\frac{\text{Subframe}_{1~i} \times \text{interlacing leftweight}}{2 ^ \text{interlacing shift}}\right\rfloor$\;
    $\text{Left}_i \leftarrow \text{Subframe}_{1~i} + \text{Right}_i$
  }
}{
  left channel $\leftarrow \text{subframe samples}_0$\;
  right channel $\leftarrow \text{subframe samples}_1$\;
}
\Return left and right channel samples\;
\EALGORITHM
For example, given the $\text{Subframe}_0$ samples of 14, 15, 19, 17, 18;
the $\text{Subframe}_1$ samples of 16, 17, 26, 25, 24,
an \VAR{interlacing shift} value of 2 and an \VAR{interlacing leftweight}
values of 3, we calculate output samples as follows:
\begin{table}[h]
\begin{tabular}{|c||>{$}r<{$}|>{$}r<{$}||>{$}r<{$}|>{$}r<{$}|}
\hline
$i$ & \text{Subframe}_{0~i} & \text{Subframe}_{1~i} & \text{Right}_i & \text{Left}_i \\
\hline
0 & 14 & 16 & 14 - \lfloor(16 \times 3) \div 2^2\rfloor = \textbf{2} & 16 + \textbf{2} = \textbf{18} \\
1 & 15 & 17 & 15 - \lfloor(17 \times 3) \div 2^2\rfloor = \textbf{3} & 17 + \textbf{3} = \textbf{20} \\
2 & 19 & 26 & 19 - \lfloor(26 \times 3) \div 2^2\rfloor = \textbf{0} & 26 + \textbf{0} = \textbf{26} \\
3 & 17 & 25 & 17 - \lfloor(25 \times 3) \div 2^2\rfloor = \textbf{-1} & 25 + \textbf{-1} = \textbf{24} \\
4 & 18 & 24 & 18 - \lfloor(24 \times 3) \div 2^2\rfloor = \textbf{0} & 24 + \textbf{0} = \textbf{24} \\
\hline
\end{tabular}
\end{table}

\subsection{Channel Assignment}
\begin{table}[h]
\begin{tabular}{r|l}
channels & assignment \\
\hline
1 & mono \\
2 & left, right \\
3 & center, left, right \\
4 & center, left, right, center surround \\
5 & center, left, right, left surround, right surround \\
6 & center, left, right, left surround, right surround, LFE \\
7 & center, left, right, left surround, right surround, center surround, LFE \\
8 & center, left center, right center, left, right, left surround, right surround, LFE \\
\end{tabular}
\end{table}

\clearpage

\section{ALAC Encoding}

To encode an ALAC file, we need a stream of PCM sample integers
along with that stream's sample rate, bits-per-sample and number of
channels.
We'll start by encoding all of the non-audio ALAC atoms,
most of which are contained within the \ATOM{moov} atom.
There's over twenty atoms in a typical ALAC file,
most of which are packed with seemingly redundant or
nonessential data,
so it will take awhile before we can move on to the actual
audio encoding process.

Remember, all of an ALAC's fields are big-endian.

\subsection{ALAC Atoms}
\begin{wrapfigure}[6]{r}{1.5in}
\includegraphics{figures/alac/atoms.pdf}
\end{wrapfigure}
We'll encode our ALAC file in iTunes order, which means
it contains the \ATOM{ftyp}, \ATOM{moov}, \ATOM{free} and
\ATOM{mdat} atoms, in that order.

\subsubsection{the ftyp Atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & 32 \\
atom type & 32 & `ftyp' (\texttt{0x66747970}) \\
\hline
major brand & 32 & `M4A ' (\texttt{0x4d344120}) \\
major brand version & 32 & \texttt{0} \\
compatible brand & 32 & `M4A ' (\texttt{0x4d344120}) \\
compatible brand & 32 & `mp42' (\texttt{0x6d703432}) \\
compatible brand & 32 & `isom' (\texttt{0x69736f6d}) \\
compatible brand & 32 & \texttt{0x00000000} \\
\hline
\end{tabular}
\end{table}

\subsubsection{the moov Atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & \ATOM{mvhd} size + \ATOM{trak} size + \ATOM{udta} size + 8 \\
atom type & 32 & `moov' (\texttt{0x6d6f6f76}) \\
\hline
\ATOM{mvhd} atom & \ATOM{mvhd} size & \ATOM{mvhd} data \\
\ATOM{trak} atom & \ATOM{trak} size & \ATOM{trak} data \\
\ATOM{udta} atom & \ATOM{udta} size & \ATOM{udta} data \\
\hline
\end{tabular}
\end{table}

\clearpage

\subsubsection{the mvhd Atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & 108/120 \\
atom type & 32 & `mvhd' (\texttt{0x6d766864}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
created date & 32/64 & creation date as Mac UTC \\
modified date & 32/64 & modification date as Mac UTC \\
time scale & 32 & sample rate \\
duration & 32/64 & total PCM frames \\
playback speed & 32 & \texttt{0x10000} \\
user volume & 16 & \texttt{0x100} \\
padding & 80 & \texttt{0x00000000000000000000} \\
window geometry matrix a & 32 & \texttt{0x10000} \\
window geometry matrix b & 32 & \texttt{0} \\
window geometry matrix u & 32 & \texttt{0} \\
window geometry matrix c & 32 & \texttt{0} \\
window geometry matrix d & 32 & \texttt{0x10000} \\
window geometry matrix v & 32 & \texttt{0} \\
window geometry matrix x & 32 & \texttt{0} \\
window geometry matrix y & 32 & \texttt{0} \\
window geometry matrix w & 32 & \texttt{0x40000000} \\
QuickTime preview & 64 & \texttt{0} \\
QuickTime still poster & 32 & \texttt{0} \\
QuickTime selection time & 64 & \texttt{0} \\
QuickTime current time & 32 & \texttt{0} \\
next track ID & 32 & \texttt{2} \\
\hline
\end{tabular}
\end{table}

If \VAR{version} is 0, \VAR{created date}, \VAR{modified date} and
\VAR{duration} are 32 bit fields.
Otherwise, they are 64 bit fields.
The \VAR{created date} and \VAR{modified date} are seconds
since the Macintosh Epoch, which is 00:00:00, January 1st, 1904.\footnote{Why 1904?  It's the first leap year of the 20th century.}
To convert a Unix Epoch timestamp (seconds since January 1st, 1970) to
a Macintosh Epoch, one needs to add 24,107 days -
or \texttt{2082844800} seconds.

\clearpage

\subsubsection{the trak Atom}
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & \ATOM{tkhd} size + \ATOM{mdia} size + 8 \\
atom type & 32 & `trak' (\texttt{0x7472616b}) \\
\hline
\ATOM{tkhd} atom & \ATOM{tkhd} size & \ATOM{tkhd} data \\
\ATOM{mdia} atom & \ATOM{mdia} size & \ATOM{mdia} data \\
\hline
\end{tabular}

\subsubsection{the tkhd Atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & 92/104 \\
atom type & 32 & `tkhd' (\texttt{0x746b6864}) \\
\hline
version & 8 & \texttt{0x00} \\
padding & 20 & \texttt{0x000000} \\
track in poster & 1 & \texttt{0} \\
track in preview & 1 & \texttt{1} \\
track in movie & 1 & \texttt{1} \\
track enabled & 1 & \texttt{1} \\
created date & 32/64 & creation date as Mac UTC \\
modified date & 32/64 & modification date as Mac UTC \\
track ID & 32 & \texttt{1} \\
padding & 32 & \texttt{0x00000000} \\
duration & 32/64 & total PCM frames \\
padding & 64 & \texttt{0x0000000000000000} \\
video layer & 16 & \texttt{0} \\
QuickTime alternate & 16 & \texttt{0} \\
volume & 16 & \texttt{0x1000} \\
padding & 16 & \texttt{0x0000} \\
video geometry matrix a & 32 & \texttt{0x10000} \\
video geometry matrix b & 32 & \texttt{0} \\
video geometry matrix u & 32 & \texttt{0} \\
video geometry matrix c & 32 & \texttt{0} \\
video geometry matrix d & 32 & \texttt{0x10000} \\
video geometry matrix v & 32 & \texttt{0} \\
video geometry matrix x & 32 & \texttt{0} \\
video geometry matrix y & 32 & \texttt{0} \\
video geometry matrix w & 32 & \texttt{0x40000000} \\
video width & 32 & \texttt{0} \\
video height & 32 & \texttt{0} \\
\hline
\end{tabular}
\end{table}

\clearpage

\subsubsection{the mdia Atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & \ATOM{mdhd} size + \ATOM{hdlr} size + \ATOM{minf} size + 8 \\
atom type & 32 & `mdia' (\texttt{0x6d646961}) \\
\hline
\ATOM{mdhd} atom & \ATOM{mdhd} size & \ATOM{mdhd} data \\
\ATOM{hdlr} atom & \ATOM{hdlr} size & \ATOM{hdlr} data \\
\ATOM{minf} atom & \ATOM{minf} size & \ATOM{minf} data \\
\hline
\end{tabular}
\end{table}

\subsubsection{the mdhd Atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & 32/44 \\
atom type & 32 & `mdhd' (\texttt{0x6d646864}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
created date & 32/64 & creation date as Mac UTC \\
modified date & 32/64 & modification date as Mac UTC \\
time scale & 32 & sample rate \\
duration & 32/64 & total PCM frames \\
padding & 1 & \texttt{0} \\
language & 5 & \\
language & 5 & language value as ISO 639-2 \\
language & 5 & \\
QuickTime quality & 16 & \texttt{0} \\
\hline
\end{tabular}
\end{table}
Note the three, 5-bit \VAR{language} fields.
By adding 0x60 to each value and converting the result to ASCII characters,
the result is an \href{http://www.loc.gov/standards/iso639-2/}{ISO 639-2}
string of the file's language representation.
For example, given the values \texttt{0x15}, \texttt{0x0E} and \texttt{0x04}:
\begin{align*}
\text{language}_0 &= \texttt{0x15} + \texttt{0x60} = \texttt{0x75} = \texttt{u} \\
\text{language}_1 &= \texttt{0x0E} + \texttt{0x60} = \texttt{0x6E} = \texttt{n} \\
\text{language}_2 &= \texttt{0x04} + \texttt{0x60} = \texttt{0x64} = \texttt{d}
\end{align*}
Which is the code `\texttt{und}', meaning `undetermined' - which is typical.

\clearpage

\subsubsection{the hdlr Atom}
\label{alac_hdlr}
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & 33 + component \\
atom type & 32 & `hdlr' (\texttt{0x68646c72}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
QuickTime type & 32 & \texttt{0x00000000} \\
QuickTime subtype & 32 & `soun' (\texttt{0x736f756e}) \\
QuickTime manufacturer & 32 & \texttt{0x00000000} \\
QuickTime component reserved flags & 32 & \texttt{0x00000000} \\
QuickTime component reserved flags mask & 32 & \texttt{0x00000000} \\
component name length & 8 & \texttt{0x00} \\
component name & component name length $\times$ 8 & \\
\hline
\end{tabular}


\subsubsection{the minf Atom}
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & \ATOM{smhd} size + \ATOM{dinf} size + \ATOM{stbl} size + 8 \\
atom type & 32 & `minf' (\texttt{0x6d696e66}) \\
\hline
\ATOM{smhd} atom & \ATOM{smhd} size & \ATOM{smhd} data \\
\ATOM{dinf} atom & \ATOM{dinf} size & \ATOM{dinf} data \\
\ATOM{stbl} atom & \ATOM{stbl} size & \ATOM{stbl} data \\
\hline
\end{tabular}

\subsubsection{the smhd Atom}
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & 16 \\
atom type & 32 & `smhd' (\texttt{0x736d6864}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
audio balance & 16 & \texttt{0x0000} \\
padding & 16 & \texttt{0x0000} \\
\hline
\end{tabular}

\subsubsection{the dinf Atom}
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & \ATOM{dref} size + 8 \\
atom type & 32 & `dinf' (\texttt{0x64696e66}) \\
\hline
\ATOM{dref} atom & \ATOM{dref} size & \ATOM{dref} data \\
\hline
\end{tabular}

\clearpage

\subsubsection{the dref Atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & 28 \\
atom type & 32 & `dref' (\texttt{0x64726566}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
number of references & 32 & \texttt{1} \\
\hline
\hline
reference atom size & 32 & \texttt{12} \\
reference atom type & 32 & `url ' (\texttt{0x75726c20}) \\
reference atom data & 32 & \texttt{0x00000001} \\
\hline
\end{tabular}
\end{table}

\subsubsection{the stbl Atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & \ATOM{stsd} size + \ATOM{stts} size + \ATOM{stsc} size + \\
& & \ATOM{stsz} size + \ATOM{stco} size + 8 \\
atom type & 32 & `stbl' (\texttt{0x7374626c}) \\
\hline
\ATOM{stsd} atom & \ATOM{stsd} size & \ATOM{stsd} data \\
\ATOM{stts} atom & \ATOM{stts} size & \ATOM{stts} data \\
\ATOM{stsc} atom & \ATOM{stsc} size & \ATOM{stsc} data \\
\ATOM{stsz} atom & \ATOM{stsz} size & \ATOM{stsz} data \\
\ATOM{stco} atom & \ATOM{stco} size & \ATOM{stco} data \\
\hline
\end{tabular}
\end{table}

\subsubsection{the stsd Atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & \ATOM{alac} size + 16 \\
atom type & 32 & `stsd' (\texttt{0x73747364}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
number of descriptions & 32 & \texttt{1} \\
\hline
\ATOM{alac} atom & \ATOM{alac} size & \ATOM{alac} data \\
\hline
\end{tabular}
\end{table}

\clearpage

\subsubsection{the alac Atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & 72 \\
atom type & 32 & `alac' (\texttt{0x616c6163}) \\
\hline
reserved & 48 & \texttt{0x000000000000} \\
reference index & 16 & \texttt{1} \\
version & 16 & \texttt{0} \\
revision level & 16 & \texttt{0} \\
vendor & 32 & \texttt{0x00000000} \\
channels & 16 & channel count \\
bits per sample & 16 & bits per sample \\
compression ID & 16 & \texttt{0} \\
audio packet size & 16 & \texttt{0} \\
sample rate & 32 & \texttt{0xAC440000} \\
\hline
\hline
atom length & 32 & 36 \\
atom type & 32 & `alac' (\texttt{0x616c6163}) \\
\hline
padding & 32 & \texttt{0x00000000} \\
max samples per frame & 32 & largest number of PCM frames per ALAC frame \\
padding & 8 & \texttt{0x00} \\
sample size & 8 & bits per sample \\
history multiplier & 8 & \texttt{40} \\
initial history & 8 & \texttt{10} \\
maximum K & 8 & \texttt{14} \\
channels & 8 & channel count \\
unknown & 16 & \texttt{0x00FF} \\
max coded frame size & 32 & largest ALAC frame size, in bytes \\
bitrate & 32 & $((\text{\ATOM{mdat} size} \times 8 ) \div (\text{total PCM frames} \div \text{sample rate}))$ \\
sample rate & 32 & sample rate \\
\hline
\end{tabular}
\end{table}
The \VAR{history multiplier}, \VAR{initial history} and \VAR{maximum K}
values are encode-time options, typically set to 40, 10 and 14,
respectively.

Note that the \VAR{bitrate} field can't be known in advance;
we must fill that value with 0 for now and then
return to this atom once encoding is completed
and its size has been determined.

\clearpage

\subsubsection{the stts Atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & number of times $\times$ 8 + 16\\
atom type & 32 & `stts' (\texttt{0x73747473}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
number of times & 32 & \\
\hline
frame count 1 & 32 & number of occurrences \\
frame duration 1 & 32 & PCM frame count \\
\hline
\multicolumn{3}{|c|}{...} \\
\hline
\end{tabular}
\end{table}
This atom keeps track of how many different sizes of ALAC frames
occur in the ALAC file, in PCM frames.
It will typically have only two ``times'', the block size we're
using for most of our samples and the final block size for
any remaining samples.

For example, let's imagine encoding a 1 minute audio file
at 44100Hz with a block size of 4096 frames.
This file has a total of 2,646,000 PCM frames ($60 \times 44100 = 2646000$).
2,646,000 PCM frames divided by a 4096 block size means
we have 645 ALAC frames of size 4096, and 1 ALAC frame of size 4080.

Therefore:
\begin{align*}
\text{number of times} &= 2 \\
\text{frame count}_1 &= 645 \\
\text{frame duration}_1 &= 4096 \\
\text{frame count}_2 &= 1 \\
\text{frame duration}_2 &= 4080
\end{align*}

\subsubsection{the stsc Atom}

\begin{table}[h]
\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & entries $\times$ 12 + 16 \\
atom type & 32 & `stsc' (\texttt{0x73747363}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
number of entries & 32 & \\
\hline
first chunk & 32 & \\
ALAC frames per chunk & 32 & \\
description index & 32 & \texttt{1} \\
\hline
\multicolumn{3}{|c|}{...} \\
\hline
\end{tabular}
\end{table}

This atom stores how many ALAC frames are in a given ``chunk''.
In this instance a ``chunk'' represents an entry in
the \ATOM{stco} atom table, used for seeking backwards and forwards
through the file.
\VAR{First chunk} is the starting offset of its frames-per-chunk
value, beginning at 1.

As an example, let's take a one minute, 44100Hz audio file
that's been broken into 130 chunks
(each with an entry in the \ATOM{stco} atom).
Its \ATOM{stsc} entries would typically be:
\begin{align*}
\text{first chunk}_1 &= 1 \\
\text{frames per chunk}_1 &= 5 \\
\text{first chunk}_2 &= 130 \\
\text{frames per chunk}_2 &= 1
\end{align*}
What this means is that chunks 1 through 129 have 5 ALAC frames each
while chunk 130 has 1 ALAC frame.
This is a total of 646 ALAC frames, which matches the contents of
the \ATOM{stts} atom.

\subsubsection{the stsz Atom}

\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & sizes $\times$ 4 + 20 \\
atom type & 32 & `stsz' (\texttt{0x7374737a}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
block byte size & 32 & \texttt{0x00000000} \\
number of sizes & 32 & \\
\hline
frame size & 32 & \\
\hline
\multicolumn{3}{|c|}{...} \\
\hline
\end{tabular}

This atom is a list of ALAC frame sizes, each in bytes.
For example, our 646 frame file would have 646 corresponding
\ATOM{stsz} entries.

\subsubsection{the stco Atom}

\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & offset $\times$ 4 + 16 \\
atom type & 32 & `stco' (\texttt{0x7374636f}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
number of offsets & 32 & \\
\hline
frame offset & 32 & \\
\hline
\multicolumn{3}{|c|}{...} \\
\hline
\end{tabular}

This atom is a list of absolute file offsets for each chunk, where
each chunk is typically 5 ALAC frames large.

\clearpage

\subsubsection{the udta Atom}

\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & \ATOM{meta} size + 8 \\
atom type & 32 & `udta' (\texttt{0x75647461}) \\
\hline
\ATOM{meta} atom & \ATOM{meta} size & \ATOM{meta} data \\
\hline
\end{tabular}

\subsubsection{the meta Atom}

\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & \ATOM{hdlr} size + \ATOM{ilst} size + \ATOM{free} size + 12 \\
atom type & 32 & `meta' (\texttt{0x6d657461}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
\hline
\ATOM{hdlr} atom & \ATOM{hdlr} size & \ATOM{hdlr} data \\
\ATOM{ilst} atom & \ATOM{ilst} size & \ATOM{ilst} data \\
\ATOM{free} atom & \ATOM{free} size & \ATOM{free} data \\
\hline
\end{tabular}

\subsubsection{the hdlr atom (revisited)}

\begin{tabular}{|l|r|l|}
\hline
Field & Size & Value \\
\hline
atom length & 32 & 34 \\
atom type & 32 & `hdlr' (\texttt{0x68646c72}) \\
\hline
version & 8 & \texttt{0x00} \\
flags & 24 & \texttt{0x000000} \\
QuickTime type & 32 & \texttt{0x00000000} \\
QuickTime subtype & 32 & `mdir' (\texttt{0x6d646972}) \\
QuickTime manufacturer & 32 & `appl' (\texttt{0x6170706c}) \\
QuickTime component reserved flags & 32 & \texttt{0x00000000} \\
QuickTime component reserved flags mask & 32 & \texttt{0x00000000} \\
component name length & 8 & \texttt{0x00} \\
component name & 0 & \\
\hline
\end{tabular}

This atom is laid out identically to the ALAC file's primary
\ATOM{hdlr} atom (described on page \pageref{alac_hdlr}).
The only difference is the contents of its fields.

\subsubsection{the ilst Atom}

This atom is a collection of \ATOM{data} sub-atoms
and is described on page \pageref{m4a_meta}.

\subsubsection{the free Atom}

These atoms are simple collection of NULL bytes which can easily be
resized to make room for other atoms without rewriting the entire file.

\clearpage

\subsection{Encoding mdat Atom}
\ALGORITHM{PCM frames, various encoding parameters:
\newline
\begin{tabular}{rl}
parameter & typical value \\
\hline
block size & 4096 \\
initial history & 40 \\
history multiplier & 10 \\
maximum K & 14 \\
interlacing shift & 2 \\
minimum interlacing leftweight & 0 \\
maximum interlacing leftweight & 4 \\
\end{tabular}
}{an encoded \texttt{mdat} atom}
\SetKwData{BLOCKSIZE}{block size}
\WRITE 0 in 32 unsigned bits\tcc*[r]{placeholder length}
\WRITE \texttt{"mdat"} in 4 bytes\;
\While{PCM frames remain}{
  take \BLOCKSIZE PCM frames from the input\;
  write PCM frames to frameset\;
  deduct PCM frame length from \BLOCKSIZE\;
}
return to start of \texttt{mdat} atom and write actual length\;
\EALGORITHM
\begin{figure}[h]
\includegraphics{figures/alac/stream.pdf}
\end{figure}

\clearpage

\subsection{Encoding Frameset}
{\relsize{-2}
\ALGORITHM{1 or more channels of PCM frames}{1 or more ALAC frames as a frameset}
\SetKwData{CHANCOUNT}{channel count}
\SetKwData{FRAMEDATA}{frame channels}
\Switch{\CHANCOUNT}{
  \uCase{1}{
    encode mono as 1 channel frame\;
  }
  \uCase{2}{
    encode left,right as 2 channel frame\;
  }
  \uCase{3}{
    encode center as 1 channel frame\;
    encode left,right as 2 channel frame\;
  }
  \uCase{4}{
    encode center as 1 channel frame\;
    encode left,right as 2 channel frame\;
    encode center surround as 1 channel frame\;
  }
  \uCase{5}{
    encode center as 1 channel frame\;
    encode left,right as 2 channel frame\;
    encode left surround,right surround as 2 channel frame\;
  }
  \uCase{6}{
    encode center as 1 channel frame\;
    encode left,right as 2 channel frame\;
    encode left surround,right surround as 2 channel frame\;
    encode LFE as 1 channel frame\;
  }
  \uCase{7}{
    encode center as 1 channel frame\;
    encode left,right as 2 channel frame\;
    encode left surround,right surround as 2 channel frame\;
    encode center surround as 1 channel frame\;
    encode LFE as 1 channel frame\;
  }
  \Case{8}{
    encode center as 1 channel frame\;
    encode left center,right center as 2 channel frame\;
    encode left,right as 2 channel frame\;
    encode left surround,right surround as 1 channel frame\;
    encode LFE as 1 channel frame\;
  }
  \WRITE 7 in 3 unsigned bits\;
  byte align output stream\;
}
\Return encoded frameset\;
\EALGORITHM
}

\subsubsection{Channel Assignment}
\begin{tabular}{r|l}
channels & assignment \\
\hline
1 & mono \\
2 & left, right \\
3 & center, left, right \\
4 & center, left, right, center surround \\
5 & center, left, right, left surround, right surround \\
6 & center, left, right, left surround, right surround, LFE \\
7 & center, left, right, left surround, right surround, center surround, LFE \\
8 & center, left center, right center, left, right, left surround, right surround, LFE \\
\end{tabular}

\clearpage

\subsection{Encoding Frame}
\ALGORITHM{1 or 2 channels of PCM data, encoding parameters}{a compressed or uncompressed ALAC frame}
\SetKwData{PCMCOUNT}{PCM frame count}
\SetKwData{CHANCOUNT}{channel count}
\SetKwData{COMPRESSED}{compressed frame}
\SetKwData{UNCOMPRESSED}{uncompressed frame}
\SetKwData{BPS}{bits per sample}
\SetKwFunction{LEN}{len}
\WRITE ($\CHANCOUNT - 1$) in 3 unsigned bits\;
\eIf{$\text{\PCMCOUNT} \geq 10$}{
  \COMPRESSED $\leftarrow $ encode channels as compressed frame\;
  \uIf{residual overflow occured}{
    \Return \UNCOMPRESSED\;
  }
  \uElseIf{$\LEN(\COMPRESSED) \geq \LEN(\UNCOMPRESSED)$}{
    \Return \UNCOMPRESSED\;
  }
  \Else{
    \Return \COMPRESSED\;
  }
}{
  \Return \UNCOMPRESSED\;
}
\EALGORITHM

\subsection{Encoding Uncompressed Frame}
\ALGORITHM{1 or 2 channels of PCM data, encoding parameters}{an uncompressed ALAC frame}
\SetKwData{PCMCOUNT}{PCM frame count}
\SetKwData{CHANCOUNT}{channel count}
\SetKwData{BLOCKSIZE}{block size}
\SetKwData{BPS}{bits per sample}
\WRITE 0 in 16 unsigned bits\tcc*[r]{unused}
\eIf{$\text{\PCMCOUNT} = \text{encoding parameter's \BLOCKSIZE}$}{
  \WRITE 0 in 1 unsigned bit\;
}{
  \WRITE 1 in 1 unsigned bit\;
}
\WRITE 0 in 2 unsigned bits\tcc*[r]{uncompressed LSBs}
\WRITE 1 in 1 unsigned bit\tcc*[r]{not compressed}
\If{$\text{\PCMCOUNT} \neq \text{encoding parameter's \BLOCKSIZE}$}{
  \WRITE (\PCMCOUNT) in 32 unsigned bits\;
}
\For{i = 0 \emph{\KwTo}\PCMCOUNT}{
  \For{c = 0 \emph{\KwTo}\CHANCOUNT}{
      \WRITE $\text{Channel}_{c~i}$ in \BPS signed bits\;
  }
}
\Return uncompressed frame\;
\EALGORITHM

\clearpage

\subsection{Encoding Compressed Frame}
\ALGORITHM{1 or 2 channels of PCM data, encoding parameters}{a compressed ALAC frame, or a \textit{residual overflow} exception}
\SetKwData{PCMCOUNT}{PCM frame count}
\SetKwData{CHANCOUNT}{channel count}
\SetKwData{BPS}{bits per sample}
\SetKwData{HASLSBS}{uncompressed LSBs}
\SetKwData{MINWEIGHT}{minimum leftweight}
\SetKwData{MAXWEIGHT}{maximum leftweight}
\eIf{$\text{\BPS} \leq 16$}{
  \HASLSBS $\leftarrow 0$\;
}(\tcc*[f]{extract uncompressed LSBs}){
  \HASLSBS $\leftarrow (\text{\BPS} - 16) \div 8$\;
  \For{i = 0 \emph{\KwTo}\PCMCOUNT}{
    \For{c = 0 \emph{\KwTo}\CHANCOUNT}{
      $\text{LSB}_{(i \times \CHANCOUNT) + c} \leftarrow \text{Channel}_{c~i} \bmod~2^{\text{\BPS} - 16}$\;
      $\text{Channel}_{c~i} \leftarrow \left\lfloor\text{Channel}_{c~i} \div 2^{\text{\BPS} - 16}\right\rfloor$\;
    }
  }
}
\eIf{$\text{\CHANCOUNT} = 1$}{
  \Return non-interlaced frame for $\text{Channel}_0$\;
}{
  \For{l = \MINWEIGHT \emph{\KwTo}$\text{\MAXWEIGHT} + 1$}{
    $\text{Frame}_l \leftarrow$ interlaced frame with leftweight $l$\;
  }
  \Return smallest $\text{Frame}_l$\;
}
\EALGORITHM

\subsection{Encoding Non-Interlaced Frame}
{\relsize{-1}
\ALGORITHM{1 channel of PCM data, uncompressed LSBs, encoding parameters}{a compressed ALAC frame, or a \textit{residual overflow} exception}
\SetKwData{PCMCOUNT}{PCM frame count}
\SetKwData{CHANCOUNT}{channel count}
\SetKwData{BLOCKSIZE}{block size}
\SetKwData{BPS}{bits per sample}
\WRITE 0 in 16 unsigned bits\tcc*[r]{unusued}
\eIf{$\text{\PCMCOUNT} \neq \text{encoding parameter's \BLOCKSIZE}$}{
  \WRITE 1 in 1 unsigned bit\;
}{
  \WRITE 0 in 1 unsigned bit\;
}
\WRITE uncompressed LSBs in 2 unsigned bits\;
\WRITE 0 in 1 unsigned bit\tcc*[r]{is compressed}
\If{$\text{\PCMCOUNT} \neq \text{encoding parameter's \BLOCKSIZE}$}{
  \WRITE (\PCMCOUNT) in 32 unsigned bits\;
}
\WRITE 0 in 8 unsigned bits\tcc*[r]{interlacing shift}
\WRITE 0 in 8 unsigned bits\tcc*[r]{interlacing leftweight}
calculate best $\text{LPC coefficients}_0$ and $\text{Residual}_0$ for $\text{Channel}_0$\;
write subframe header with $\text{LPC coefficients}_0$\;
\If{$\text{uncompressed LSBs} > 0$}{
  \For{i = 0 \emph{\KwTo}\PCMCOUNT}{
    \WRITE $\text{LSB}_i$ in $(\text{uncompressed LSBs} \times 8)$ unsigned bits\;
  }
}
write residual block $\text{Residual}_0$\;
\BlankLine
\Return non-interlaced ALAC frame\;
\EALGORITHM
}

\clearpage

\subsection{Encoding Interlaced Frame}
{\relsize{-1}
\ALGORITHM{2 channels of PCM data, interlacing shift, interlacing leftweight, uncompressed LSBs, encoding parameters}{a compressed ALAC frame, or a \textit{residual overflow} exception}
\SetKwData{PCMCOUNT}{PCM frame count}
\SetKwData{CHANCOUNT}{channel count}
\SetKwData{BLOCKSIZE}{block size}
\SetKwData{BPS}{bits per sample}
\WRITE 0 in 16 unsigned bits\tcc*[r]{unusued}
\eIf{$\text{\PCMCOUNT} \neq \text{encoding parameter's \BLOCKSIZE}$}{
  \WRITE 1 in 1 unsigned bit\;
}{
  \WRITE 0 in 1 unsigned bit\;
}
\WRITE uncompressed LSBs in 2 unsigned bits\;
\WRITE 0 in 1 unsigned bit\tcc*[r]{is compressed}
\If{$\text{\PCMCOUNT} \neq \text{encoding parameter's \BLOCKSIZE}$}{
  \WRITE (\PCMCOUNT) in 32 unsigned bits\;
}
\WRITE interlacing shift in 8 unsigned bits\;
\WRITE interlacing leftweight in 8 unsigned bits\;
correlate $\text{Channel}_0$,$\text{Channel}_1$ to $\text{Correlated}_0$,$\text{Correlated}_1$ with interlacing shift and leftweight\;
compute best $\text{LPC Coefficients}_0$ and $\text{Residual}_0$ for $\text{Correlated}_0$\;
compute best $\text{LPC Coefficients}_1$ and $\text{Residual}_1$ for $\text{Correlated}_1$\;
write subframe header with $\text{LPC Coefficients}_0$\;
write subframe header with $\text{LPC Coefficients}_1$\;
\If{$\text{uncompressed LSBs} > 0$}{
  \For{i = 0 \emph{\KwTo}\PCMCOUNT}{
    \WRITE $\text{LSB}_i$ in $(\text{uncompressed LSBs} \times 8)$ unsigned bits\;
  }
}
write residual block $\text{Residual}_0$\;
write residual block $\text{Residual}_1$\;
\Return interlaced ALAC frame\;
\EALGORITHM
}

\subsubsection{Correlating Channels}
\ALGORITHM{2 channels of PCM data, interlacing shift, interlacing leftweight}{2 correlated channels of PCM data}
\SetKwData{PCMCOUNT}{PCM frame count}
\For{i = 0 \emph{\KwTo}\PCMCOUNT}{
  $\text{Correlated}_{0~i} \leftarrow \text{Channel}_{1~i} + \left\lfloor\frac{(\text{Channel}_{0~i} - \text{Channel}_{1~i}) \times \text{interlacing leftweight}}{2 ^ \text{interlacing shift}}\right\rfloor$\;
  $\text{Correlated}_{1~i} \leftarrow \text{Channel}_{0~i} - \text{Channel}_{1~i}$\;
}
\EALGORITHM
\par
\noindent
For example, given an \VAR{interlacing shift} value of 2 and an
\VAR{interlacing leftweight} value of 3:
\begin{table}[h]
\begin{tabular}{r||r|r||>{$}r<{$}|>{$}r<{$}|}
$i$ & $\text{Channel}_{0~i}$ & $\text{Channel}_{1~i}$ & \text{Correlated}_{0~i} & \text{Correlated}_{1~i} \\
\hline
0 & 18 & 2 & 2 + \lfloor((18 - 2) \times 3) \div 2 ^ 2\rfloor = 14 & 18 - 2 = 16 \\
1 & 20 & 3 & 3 + \lfloor((20 - 3) \times 3) \div 2 ^ 2\rfloor = 15 & 20 - 3 = 17 \\
2 & 26 & 0 & 0 + \lfloor((26 - 0) \times 3) \div 2 ^ 2\rfloor = 19 & 26 - 0 = 26 \\
3 & 24 & -1 & -1 + \lfloor((24 + 1) \times 3) \div 2 ^ 2\rfloor = 17 & 24 + 1 = 25 \\
4 & 24 & 0 & 0 + \lfloor((24 - 0) \times 3) \div 2 ^ 2\rfloor = 18 & 24 - 0 = 24 \\
\end{tabular}
\end{table}

\clearpage

\subsection{Computing LPC Coefficients and Residual}
\ALGORITHM{a list of signed PCM samples, encoding parameters}{a list of 4 or 8 signed LPC values, a block of residual data}
\SetKwData{SAMPLES}{subframe samples}
\SetKwData{WINDOWED}{windowed samples}
\SetKwData{AUTOCORRELATIONS}{autocorrelation values}
\SetKwData{LPCOEFFS}{LP coefficients}
\SetKwData{QLPCOEFFS}{QLP coefficients}
window signed integer \SAMPLES to floating point \WINDOWED\;
autocorrelate \WINDOWED to 9 floating point \AUTOCORRELATIONS\;
compute 8 lists of floating point \LPCOEFFS from \AUTOCORRELATIONS\;
quantize $\text{\LPCOEFFS}_3$ to a list of integer $\text{\QLPCOEFFS}_3$ at order 4\;
quantize $\text{\LPCOEFFS}_7$ to a list of integer $\text{\QLPCOEFFS}_7$ at order 8\;
encode $\text{Residual}_3$ from $\text{\QLPCOEFFS}_3$\;
encode $\text{Residual}_7$ from $\text{\QLPCOEFFS}_7$\;
\eIf{$\LEN(\text{Residual}_3) < \LEN(\text{Residual}_7)$}{
  \Return ($\text{\QLPCOEFFS}_3~,~\text{Residual}_3$)\;
}{
  \Return ($\text{\QLPCOEFFS}_7~,~\text{Residual}_7$)\;
}
\EALGORITHM

\subsubsection{Windowing the Input Samples}
{\relsize{-1}
\ALGORITHM{a list of signed input sample integers}{a list of signed windowed samples as floats}
\SetKwFunction{TUKEY}{tukey}
\For{i = 0 \emph{\KwTo}sample count}{
  $windowed_i = sample_i \times \TUKEY(i)$\;
}
\Return windowed samples\;
\EALGORITHM
\par
\noindent
where the \VAR{Tukey} function is defined as:
\begin{equation*}
tukey(n) =
\begin{cases}
\frac{1}{2} \times \left[1 + cos\left(\pi \times \left(\frac{2 \times n}{\alpha \times (N - 1)} - 1 \right)\right)\right] & \text{ if } 0 \leq n \leq \frac{\alpha \times (N - 1)}{2} \\
1 & \text{ if } \frac{\alpha \times (N - 1)}{2} \leq n \leq (N - 1) \times (1 - \frac{\alpha}{2}) \\
\frac{1}{2} \times \left[1 + cos\left(\pi \times \left(\frac{2 \times n}{\alpha \times (N - 1)} - \frac{2}{\alpha} + 1 \right)\right)\right] & \text{ if } (N - 1) \times (1 - \frac{\alpha}{2}) \leq n \leq (N - 1) \\
\end{cases}
\end{equation*}
\par
\noindent
$N$ is the total number of input samples and $\alpha$ is $\nicefrac{1}{2}$.
}
\par
\noindent
\subsubsection{Windowing Example}
{\relsize{-2}
\begin{tabular}{r|rcrcr}
$i$ & $sample_i$ & & \texttt{tukey}($i$) & & $windowed_i$ \\
\hline
0 & \texttt{0} & $\times$ & \texttt{0.00} & = & \texttt{0.00} \\
1 & \texttt{16} & $\times$ & \texttt{0.19} & = & \texttt{3.01} \\
2 & \texttt{31} & $\times$ & \texttt{0.61} & = & \texttt{18.95} \\
3 & \texttt{44} & $\times$ & \texttt{0.95} & = & \texttt{41.82} \\
4 & \texttt{54} & $\times$ & \texttt{1.00} & = & \texttt{54.00} \\
5 & \texttt{61} & $\times$ & \texttt{1.00} & = & \texttt{61.00} \\
6 & \texttt{64} & $\times$ & \texttt{1.00} & = & \texttt{64.00} \\
7 & \texttt{63} & $\times$ & \texttt{1.00} & = & \texttt{63.00} \\
8 & \texttt{58} & $\times$ & \texttt{1.00} & = & \texttt{58.00} \\
9 & \texttt{49} & $\times$ & \texttt{1.00} & = & \texttt{49.00} \\
10 & \texttt{38} & $\times$ & \texttt{1.00} & = & \texttt{38.00} \\
11 & \texttt{24} & $\times$ & \texttt{0.95} & = & \texttt{22.81} \\
12 & \texttt{8} & $\times$ & \texttt{0.61} & = & \texttt{4.89} \\
13 & \texttt{-8} & $\times$ & \texttt{0.19} & = & \texttt{-1.51} \\
14 & \texttt{-24} & $\times$ & \texttt{0.00} & = & \texttt{0.00} \\
\end{tabular}
}

\clearpage

\subsubsection{Autocorrelating Windowed Samples}
\ALGORITHM{a list of signed windowed samples}{a list of signed autocorrelation values}
\For{lag = 0 \emph{\KwTo}9}{
  $\text{autocorrelation}_{\text{lag}} = \overset{\text{total samples} - \text{lag} - 1}{\underset{i = 0}{\sum}}\text{windowed}_i \times \text{windowed}_{i + \text{lag}}$\;
}
\EALGORITHM

\subsubsection{Autocorrelation Example}
{\relsize{-1}
\begin{multicols}{2}
\begin{tabular}{rrrrr}
  \texttt{0.00} & $\times$ & \texttt{0.00} & $=$ & \texttt{0.00} \\
  \texttt{3.01} & $\times$ & \texttt{3.01} & $=$ & \texttt{9.07} \\
  \texttt{18.95} & $\times$ & \texttt{18.95} & $=$ & \texttt{359.07} \\
  \texttt{41.82} & $\times$ & \texttt{41.82} & $=$ & \texttt{1749.02} \\
  \texttt{54.00} & $\times$ & \texttt{54.00} & $=$ & \texttt{2916.00} \\
  \texttt{61.00} & $\times$ & \texttt{61.00} & $=$ & \texttt{3721.00} \\
  \texttt{64.00} & $\times$ & \texttt{64.00} & $=$ & \texttt{4096.00} \\
  \texttt{63.00} & $\times$ & \texttt{63.00} & $=$ & \texttt{3969.00} \\
  \texttt{58.00} & $\times$ & \texttt{58.00} & $=$ & \texttt{3364.00} \\
  \texttt{49.00} & $\times$ & \texttt{49.00} & $=$ & \texttt{2401.00} \\
  \texttt{38.00} & $\times$ & \texttt{38.00} & $=$ & \texttt{1444.00} \\
  \texttt{22.81} & $\times$ & \texttt{22.81} & $=$ & \texttt{520.37} \\
  \texttt{4.89} & $\times$ & \texttt{4.89} & $=$ & \texttt{23.91} \\
  \texttt{-1.51} & $\times$ & \texttt{-1.51} & $=$ & \texttt{2.27} \\
  \texttt{0.00} & $\times$ & \texttt{0.00} & $=$ & \texttt{0.00} \\
  \hline
  \multicolumn{3}{r}{$\text{autocorrelation}_0$} & $=$ & \texttt{24574.71} \\
\end{tabular}
\par
\begin{tabular}{rrrrr}
  \texttt{0.00} & $\times$ & \texttt{3.01} & $=$ & \texttt{0.00} \\
  \texttt{3.01} & $\times$ & \texttt{18.95} & $=$ & \texttt{57.08} \\
  \texttt{18.95} & $\times$ & \texttt{41.82} & $=$ & \texttt{792.48} \\
  \texttt{41.82} & $\times$ & \texttt{54.00} & $=$ & \texttt{2258.35} \\
  \texttt{54.00} & $\times$ & \texttt{61.00} & $=$ & \texttt{3294.00} \\
  \texttt{61.00} & $\times$ & \texttt{64.00} & $=$ & \texttt{3904.00} \\
  \texttt{64.00} & $\times$ & \texttt{63.00} & $=$ & \texttt{4032.00} \\
  \texttt{63.00} & $\times$ & \texttt{58.00} & $=$ & \texttt{3654.00} \\
  \texttt{58.00} & $\times$ & \texttt{49.00} & $=$ & \texttt{2842.00} \\
  \texttt{49.00} & $\times$ & \texttt{38.00} & $=$ & \texttt{1862.00} \\
  \texttt{38.00} & $\times$ & \texttt{22.81} & $=$ & \texttt{866.84} \\
  \texttt{22.81} & $\times$ & \texttt{4.89} & $=$ & \texttt{111.55} \\
  \texttt{4.89} & $\times$ & \texttt{-1.51} & $=$ & \texttt{-7.36} \\
  \texttt{-1.51} & $\times$ & \texttt{0.00} & $=$ & \texttt{0.00} \\
  \hline
  \multicolumn{3}{r}{$\text{autocorrelation}_1$} & $=$ & \texttt{23666.93} \\
\end{tabular}
\par
\begin{tabular}{rrrrr}
  \texttt{0.00} & $\times$ & \texttt{18.95} & $=$ & \texttt{0.00} \\
  \texttt{3.01} & $\times$ & \texttt{41.82} & $=$ & \texttt{125.97} \\
  \texttt{18.95} & $\times$ & \texttt{54.00} & $=$ & \texttt{1023.25} \\
  \texttt{41.82} & $\times$ & \texttt{61.00} & $=$ & \texttt{2551.10} \\
  \texttt{54.00} & $\times$ & \texttt{64.00} & $=$ & \texttt{3456.00} \\
  \texttt{61.00} & $\times$ & \texttt{63.00} & $=$ & \texttt{3843.00} \\
  \texttt{64.00} & $\times$ & \texttt{58.00} & $=$ & \texttt{3712.00} \\
  \texttt{63.00} & $\times$ & \texttt{49.00} & $=$ & \texttt{3087.00} \\
  \texttt{58.00} & $\times$ & \texttt{38.00} & $=$ & \texttt{2204.00} \\
  \texttt{49.00} & $\times$ & \texttt{22.81} & $=$ & \texttt{1117.77} \\
  \texttt{38.00} & $\times$ & \texttt{4.89} & $=$ & \texttt{185.82} \\
  \texttt{22.81} & $\times$ & \texttt{-1.51} & $=$ & \texttt{-34.36} \\
  \texttt{4.89} & $\times$ & \texttt{0.00} & $=$ & \texttt{0.00} \\
  \hline
  \multicolumn{3}{r}{$\text{autocorrelation}_2$} & $=$ & \texttt{21271.56} \\
\end{tabular}
\par
\begin{tabular}{rrrrr}
  \texttt{0.00} & $\times$ & \texttt{41.82} & $=$ & \texttt{0.00} \\
  \texttt{3.01} & $\times$ & \texttt{54.00} & $=$ & \texttt{162.65} \\
  \texttt{18.95} & $\times$ & \texttt{61.00} & $=$ & \texttt{1155.89} \\
  \texttt{41.82} & $\times$ & \texttt{64.00} & $=$ & \texttt{2676.56} \\
  \texttt{54.00} & $\times$ & \texttt{63.00} & $=$ & \texttt{3402.00} \\
  \texttt{61.00} & $\times$ & \texttt{58.00} & $=$ & \texttt{3538.00} \\
  \texttt{64.00} & $\times$ & \texttt{49.00} & $=$ & \texttt{3136.00} \\
  \texttt{63.00} & $\times$ & \texttt{38.00} & $=$ & \texttt{2394.00} \\
  \texttt{58.00} & $\times$ & \texttt{22.81} & $=$ & \texttt{1323.07} \\
  \texttt{49.00} & $\times$ & \texttt{4.89} & $=$ & \texttt{239.61} \\
  \texttt{38.00} & $\times$ & \texttt{-1.51} & $=$ & \texttt{-57.23} \\
  \texttt{22.81} & $\times$ & \texttt{0.00} & $=$ & \texttt{0.00} \\
  \hline
  \multicolumn{3}{r}{$\text{autocorrelation}_3$} & $=$ & \texttt{17970.57} \\
\end{tabular}
\par
\begin{tabular}{rrrrr}
  \texttt{0.00} & $\times$ & \texttt{54.00} & $=$ & \texttt{0.00} \\
  \texttt{3.01} & $\times$ & \texttt{61.00} & $=$ & \texttt{183.74} \\
  \texttt{18.95} & $\times$ & \texttt{64.00} & $=$ & \texttt{1212.74} \\
  \texttt{41.82} & $\times$ & \texttt{63.00} & $=$ & \texttt{2634.74} \\
  \texttt{54.00} & $\times$ & \texttt{58.00} & $=$ & \texttt{3132.00} \\
  \texttt{61.00} & $\times$ & \texttt{49.00} & $=$ & \texttt{2989.00} \\
  \texttt{64.00} & $\times$ & \texttt{38.00} & $=$ & \texttt{2432.00} \\
  \texttt{63.00} & $\times$ & \texttt{22.81} & $=$ & \texttt{1437.13} \\
  \texttt{58.00} & $\times$ & \texttt{4.89} & $=$ & \texttt{283.62} \\
  \texttt{49.00} & $\times$ & \texttt{-1.51} & $=$ & \texttt{-73.80} \\
  \texttt{38.00} & $\times$ & \texttt{0.00} & $=$ & \texttt{0.00} \\
  \hline
  \multicolumn{3}{r}{$\text{autocorrelation}_4$} & $=$ & \texttt{14231.18} \\
\end{tabular}
\end{multicols}
}

\clearpage

\subsubsection{LP Coefficient Calculation}

{\relsize{-1}
\ALGORITHM{a list of autocorrelation floats}{a list of LP coefficient lists}
\SetKwData{LPCOEFF}{LP coefficient}
\SetKwData{ERROR}{error}
\SetKwData{AUTOCORRELATION}{autocorrelation}
\begin{tabular}{rcl}
$\kappa_0$ &$\leftarrow$ & $ \AUTOCORRELATION_1 \div \AUTOCORRELATION_0$ \\
$\LPCOEFF_{0~0}$ &$\leftarrow$ & $ \kappa_0$ \\
$\ERROR_0$ &$\leftarrow$ & $ \AUTOCORRELATION_0 \times (1 - {\kappa_0} ^ 2)$ \\
\end{tabular}\;
\For{i = 1 \emph{\KwTo}8}{
  \tcc{"zip" all of the previous row's LP coefficients
    \newline
    and the reversed autocorrelation values from 1 to i + 1
    \newline
    into ($c$,$a$) pairs
    \newline
    $q_i$ is $\AUTOCORRELATION_{i + 1}$ minus the sum of those mutiplied ($c$,$a$) pairs}
  $q_i \leftarrow \AUTOCORRELATION_{i + 1}$\;
  \For{j = 0 \emph{\KwTo}i}{
    $q_i \leftarrow q_i - (\LPCOEFF_{(i - 1)~j} \times \AUTOCORRELATION_{i - j})$\;
  }
  \BlankLine
  \tcc{"zip" all of the previous row's LP coefficients
    \newline
    and the previous row's LP coefficients reversed
    \newline
    into ($c$,$r$) pairs}
  $\kappa_i = q_i \div \ERROR_{i - 1}$\;
  \For{j = 0 \emph{\KwTo}i}{
    \tcc{then build a new coefficient list of $c - (\kappa_i * r)$ for each ($c$,$r$) pair}
    $\LPCOEFF_{i~j} \leftarrow \LPCOEFF_{(i - 1)~j} - (\kappa_i \times \LPCOEFF_{(i - 1)~(i - j - 1)})$\;
  }
  $\text{LP coefficient}_{i~i} \leftarrow \kappa_i$\tcc*[r]{and append $\kappa_i$ as the final coefficient in that list}
  \BlankLine
  $\ERROR_i \leftarrow \ERROR_{i - 1} \times (1 - {\kappa_i}^2)$\;
}
\Return list of LP coefficient lists\;
\EALGORITHM
}

\begin{landscape}

\subsubsection{LP Coefficient Calculation Example}
\begin{table}[h]
{\relsize{-1}
\begin{tabular}{r|r}
$i$ & $\text{autocorrelation}_i$ \\
\hline
0 & \texttt{24598.25} \\
1 & \texttt{23694.34} \\
2 & \texttt{21304.57} \\
3 & \texttt{18007.86} \\
4 & \texttt{14270.30} \\
\end{tabular}
}
\end{table}

\begin{table}[h]
{\relsize{-1}
\renewcommand{\arraystretch}{1.45}
\begin{tabular}{|>{$}r<{$}||>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|}
\hline
k_0 &
\multicolumn{4}{>{$}l<{$}|}{\texttt{23694.34} \div \texttt{24598.25} = \texttt{0.96}} \\
\text{LP coefficient}_{0~0} & \texttt{\color{blue}0.96} & & & \\
\text{error}_0 &
\multicolumn{4}{>{$}l<{$}|}{\texttt{24598.25} \times (1 - \texttt{0.96} ^ 2) = \texttt{1774.62}} \\
\hline
q_1 & \multicolumn{4}{>{$}l<{$}|}{\texttt{21304.57} - (\texttt{0.96} \times \texttt{23694.34}) = \texttt{-1519.07}} \\
k_1 & \multicolumn{4}{>{$}l<{$}|}{\texttt{-1519.07} \div \texttt{1774.62} = \texttt{-0.86}} \\
\text{LP coefficient}_{1~i} &
\texttt{0.96} -(\texttt{-0.86} \times \texttt{0.96}) = \texttt{\color{blue}1.79} &
\texttt{\color{blue}-0.86} & & \\
\text{error}_1 & \multicolumn{4}{>{$}l<{$}|}{\texttt{1774.62} \times (1 - \texttt{-0.86} ^ 2) = \texttt{474.30}} \\
\hline
q_2 & \multicolumn{4}{>{$}l<{$}|}{\texttt{18007.86} - (\texttt{1.79} \times \texttt{21304.57} + \texttt{-0.86} \times \texttt{23694.34}) = \texttt{201.96}} \\
k_2 & \multicolumn{4}{>{$}l<{$}|}{\texttt{201.96} \div \texttt{474.30} = \texttt{0.43}} \\
\text{LP coefficient}_{2~i} &
\texttt{1.79} -(\texttt{0.43} \times \texttt{-0.86}) = \texttt{\color{blue}2.15} &
\texttt{-0.86} -(\texttt{0.43} \times \texttt{1.79}) = \texttt{\color{blue}-1.62} &
\texttt{\color{blue}0.43} & \\
\text{error}_2 & \multicolumn{4}{>{$}l<{$}|}{\texttt{474.30} \times (1 - \texttt{0.43} ^ 2) = \texttt{388.31}} \\
\hline
q_3 & \multicolumn{4}{>{$}l<{$}|}{\texttt{14270.30} - (\texttt{2.15} \times \texttt{18007.86} + \texttt{-1.62} \times \texttt{21304.57} + \texttt{0.43} \times \texttt{23694.34}) = \texttt{-122.06}} \\
k_3 & \multicolumn{4}{>{$}l<{$}|}{\texttt{-122.06} \div \texttt{388.31} = \texttt{-0.31}} \\
\text{LP coefficient}_{3~i} &
\texttt{2.15} -(\texttt{-0.31} \times \texttt{0.43}) = \texttt{\color{blue}2.29} &
\texttt{-1.62} -(\texttt{-0.31} \times \texttt{-1.62}) = \texttt{\color{blue}-2.13} &
\texttt{0.43} -(\texttt{-0.31} \times \texttt{2.15}) = \texttt{\color{blue}1.10} &
\texttt{\color{blue}-0.31} \\
\text{error}_3 & \multicolumn{4}{>{$}l<{$}|}{\texttt{388.31} \times (1 - \texttt{-0.31} ^ 2) = \texttt{349.94}} \\
\hline
\end{tabular}
\renewcommand{\arraystretch}{1.0}
}
\end{table}

\end{landscape}

\subsubsection{Quantizing LP Coefficients}

\ALGORITHM{LP coefficients, an order value of 4 or 8}{QLP coefficients as a list of signed integers}
\SetKwFunction{MIN}{min}
\SetKwFunction{MAX}{max}
\SetKwFunction{ROUND}{round}
\tcc{QLP min and max are the smallest and largest QLP coefficients that fit in a signed field that's 16 bits wide}
QLP max $\leftarrow 2 ^ \text{15} - 1$\;
QLP min $\leftarrow -(2 ^ \text{15})$\;
$error \leftarrow 0.0$\;
\For{i = 0 \emph{\KwTo}order}{
  $error \leftarrow error + \text{LP Coefficients}_{order - 1~i} \times 2 ^ 9$\;
  $\text{QLP coefficient}_i \leftarrow \MIN(\MAX(\ROUND(error), \text{QLP min}), \text{QLP max})$\;
  $error \leftarrow error - \text{QLP coefficient}_i$\;
}
\Return QLP coefficients\;
\EALGORITHM

\clearpage

\subsubsection{Quantizing Coefficients Example}
\begin{align*}
error &\leftarrow \texttt{0.00} + \texttt{2.29} \times 2 ^ 9 = \texttt{1170.49} \\
\text{QLP Coefficient}_0 &\leftarrow \texttt{round}(\texttt{1170.49}) = \texttt{\color{blue}1170} \\
error &\leftarrow \texttt{1170.49} - 1170 = \texttt{0.49} \\
error &\leftarrow \texttt{0.49} + \texttt{-2.13} \times 2 ^ 9 = \texttt{-1087.81} \\
\text{QLP Coefficient}_1 &\leftarrow \texttt{round}(\texttt{-1087.81}) = \texttt{\color{blue}-1088} \\
error &\leftarrow \texttt{-1087.81} - -1088 = \texttt{0.19} \\
error &\leftarrow \texttt{0.19} + \texttt{1.10} \times 2 ^ 9 = \texttt{564.59} \\
\text{QLP Coefficient}_2 &\leftarrow\texttt{round}(\texttt{564.59}) = \texttt{\color{blue}565} \\
error &\leftarrow \texttt{564.59} - 565 = \texttt{-0.41} \\
error &\leftarrow \texttt{-0.41} + \texttt{-0.31} \times 2 ^ 9 = \texttt{-161.35} \\
\text{QLP Coefficient}_3 &\leftarrow \texttt{round}(\texttt{-161.35}) = \texttt{\color{blue}-161} \\
error &\leftarrow \texttt{-161.35} - -161 = \texttt{-0.35} \\
\end{align*}

\clearpage

\subsubsection{Computing Residual Values}
\ALGORITHM{a list of signed PCM samples, a list of 4 or 8 QLP coefficients}{a list of signed residual values}
\SetKwFunction{SIGN}{sign}
\SetKw{BREAK}{break}
\SetKwData{ORIGSIGN}{original sign}
$\text{Residual}_0 \leftarrow \text{Sample}_0$\;
\For{i = 1 \emph{\KwTo}coefficient count + 1}{
  $\text{Residual}_i \leftarrow \text{Sample}_i - \text{Sample}_{i - 1}$
}
\For{i = coefficient count + 1 \emph{\KwTo}sample count}{
  $\text{Base Sample}_i \leftarrow \text{Sample}_{i - coeff.~count - 1}$\;
  $\text{LPC Sum}_i \leftarrow \overset{coeff.~count - 1}{\underset{j = 0}{\sum}} \text{QLP Coefficient}_j \times (\text{Sample}_{i - j - 1} - \text{Base Sample}_i)$\;
  $\text{Residual}_i \leftarrow \text{Sample}_i - \left(\left\lfloor\frac{\text{LPC Sum}_i + 2 ^ 8}{2 ^ 9}\right\rfloor + \text{Base Sample}_i\right)$\;
  \BlankLine
  \uIf(\tcc*[f]{modify QLP coefficients}){$\text{Residual}_i > 0$}{
    \For{j = 0 \emph{\KwTo}$\text{coefficient count}$}{
      $diff \leftarrow \text{Base Sample}_i - \text{Samples}_{i - coeff.~count + j}$\;
      $sign \leftarrow \SIGN(diff)$\;
      $\text{QLP Coefficient}_{coeff.~count - j - 1} \leftarrow \text{QLP Coefficient}_{coeff.~count - j - 1} - sign$\;
      $\text{Residual}_i \leftarrow \text{Residual}_i - \left\lfloor\frac{diff \times sign}{2 ^ 9}\right\rfloor \times (j + 1)$\;
      \If{$\text{Residual}_i \leq 0$}{
        \BREAK\;
      }
    }
  }
  \ElseIf{$\text{Residual}_i < 0$}{
    \For{j = 0 \emph{\KwTo}$\text{coefficient count}$}{
      $diff \leftarrow \text{Base Sample}_i - \text{Samples}_{i - coeff.~count + j}$\;
      $sign \leftarrow \SIGN(diff)$\;
      $\text{QLP Coefficient}_{coeff.~count - j - 1} \leftarrow \text{QLP Coefficient}_{coeff.~count - j - 1} + sign$\;
      $\text{Residual}_i \leftarrow \text{Residual}_i - \left\lfloor\frac{diff \times -sign}{2 ^ 9}\right\rfloor \times (j + 1)$\;
      \If{$\text{Residual}_i \geq 0$}{
        \BREAK\;
      }
    }
  }
}
\Return signed residual values\;
\EALGORITHM
where the \texttt{sign} function is defined as:
\begin{equation*}
\texttt{sign}(x) =
\begin{cases}
\texttt{ 1} & \text{if } x > 0 \\
\texttt{ 0} & \text{if } x = 0 \\
\texttt{-1} & \text{if } x < 0
\end{cases}
\end{equation*}

\clearpage

\subsubsection{Computing Residuals Example}
{\relsize{-2}
Given the samples
\texttt{0, 16, 32, 44, 54, 61, 64, 63, 58, 49, 38, 24, 8, -8, -24},
and the QLP coefficients
\texttt{1170, -1088, 565, -161},
the subframe's residuals are calculate as follows:
\par
\vskip .15in
\noindent
\begin{tabular}{r||r|r|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}}
$i$ & $\text{Sample}_i$ & $\text{Base}_i$ & \text{LPC Sum}_i & \text{Residual}_i & \text{QLP Coeff.}_{(i + 1)~j} \\
\hline
0 & 0 & & & 0 \\
1 & 16 & & & 16 - 0 = 16 \\
2 & 32 & & & 32 - 16 = 16 \\
3 & 44 & & & 44 - 32 = 12 \\
4 & 54 & & & 54 - 44 = 10 \\
\hline
5 & 61 & 0 & 1170 \times (54 - 0) \texttt{ +} & 61 - (\lfloor(30812 + 2 ^ 8) \div 2 ^ 9\rfloor + 0) = 1 & 1170 + 1 = 1171 \\
& & & -1088 \times (44 - 0) \texttt{ +} & & -1088 + 1 = -1087 \\
& & & 565 \times (32 - 0) \texttt{ +} & & 565 + 1 = 566 \\
& & & -161 \times (16 - 0) \texttt{~~} & & -161 + 1 = -160 \\
\hline
6 & 64 & 16 & 1171 \times (61 - 16) \texttt{ +} & 64 - (\lfloor(24677 + 2 ^ 8) \div 2 ^ 9\rfloor + 16) = 0 & 1171 \\
& & & -1087 \times (54 - 16) \texttt{ +} & & -1087 \\
& & & 566 \times (44 - 16) \texttt{ +} & & 566 \\
& & & -160 \times (32 - 16) \texttt{~~} & & -160 \\
\hline
7 & 63 & 32 & 1171 \times (64 - 32) \texttt{ +} & 63 - (\lfloor(16481 + 2 ^ 8) \div 2 ^ 9\rfloor + 32) = -1 & 1171 \\
& & & -1087 \times (61 - 32) \texttt{ +} & & -1087 \\
& & & 566 \times (54 - 32) \texttt{ +} & & 566 \\
& & & -160 \times (44 - 32) \texttt{~~} & & -160 - 1 = -159 \\
\hline
8 & 58 & 44 & 1171 \times (63 - 44) \texttt{ +} & 58 - (\lfloor(8521 + 2 ^ 8) \div 2 ^ 9\rfloor + 44) = -3 & 1171 \\
& & & -1087 \times (64 - 44) \texttt{ +} & & -1087 \\
& & & 566 \times (61 - 44) \texttt{ +} & & 565 \\
& & & -161 \times (54 - 44) \texttt{~~} & & -161 - 1 = -160 \\
\hline
9 & 49 & 54 & 1171 \times (58 - 54) \texttt{ +} & 49 - (\lfloor(-583 + 2 ^ 8) \div 2 ^ 9\rfloor + 54) = -4 & 1171 \\
& & & -1087 \times (63 - 54) \texttt{ +} & & -1088 \\
& & & 565 \times (64 - 54) \texttt{ +} & & -1087 - 1 = -1086 \\
& & & -162 \times (61 - 54) \texttt{~~} & & -162 - 1 = -161 \\
\hline
10 & 38 & 61 & 1171 \times (49 - 61) \texttt{ +} & 38 - (\lfloor(-10149 + 2 ^ 8) \div 2 ^ 9\rfloor + 61) = -3 & 1171 \\
& & & -1088 \times (58 - 61) \texttt{ +} & & -1088 \\
& & & 564 \times (63 - 61) \texttt{ +} & & 563 \\
& & & -163 \times (64 - 61) \texttt{~~} & & -163 - 1 = -162 \\
\hline
11 & 24 & 64 & 1171 \times (38 - 64) \texttt{ +} & 24 - (\lfloor(-17340 + 2 ^ 8) \div 2 ^ 9\rfloor + 64) = -6 & 1171 \\
& & & -1088 \times (49 - 64) \texttt{ +} & & -1087 \\
& & & 563 \times (58 - 64) \texttt{ +} & & -1088 + 1 = -1089 \\
& & & -164 \times (63 - 64) \texttt{~~} & & -164 + 1 = -165 \\
\hline
12 & 8 & 63 & 1171 \times (24 - 63) \texttt{ +} & 8 - (\lfloor(-25575 + 2 ^ 8) \div 2 ^ 9\rfloor + 63) = -5 & 1171 \\
& & & -1087 \times (38 - 63) \texttt{ +} & & -1086 \\
& & & 564 \times (49 - 63) \texttt{ +} & & -1087 + 1 = -1088 \\
& & & -163 \times (58 - 63) \texttt{~~} & & -163 + 1 = -164 \\
\hline
13 & -8 & 58 & 1171 \times (8 - 58) \texttt{ +} & -8 - (\lfloor(-31468 + 2 ^ 8) \div 2 ^ 9\rfloor + 58) = -5 & 1171 \\
& & & -1086 \times (24 - 58) \texttt{ +} & & -1085 \\
& & & 565 \times (38 - 58) \texttt{ +} & & -1086 + 1 = -1087 \\
& & & -162 \times (49 - 58) \texttt{~~} & & -162 + 1 = -163 \\
\hline
14 & -24 & 49 & 1171 \times (-8 - 49) \texttt{ +} & -24 - (\lfloor(-34641 + 2 ^ 8) \div 2 ^ 9\rfloor + 49) = -5 & 1171 \\
& & & -1085 \times (8 - 49) \texttt{ +} & & -1084 \\
& & & 566 \times (24 - 49) \texttt{ +} & & -1085 + 1 = -1086 \\
& & & -161 \times (38 - 49) \texttt{~~} & & -161 + 1 = -162 \\
\hline
\end{tabular}
}

\clearpage

\subsubsection{Encoding Residual Block}
\ALGORITHM{a list of signed residual values, sample size; initial history, history multiplier, maximum K from encoding options}{a block of residual data}
\SetKwData{HISTORY}{history}
\SetKwData{HISTORYMULT}{history multiplier}
\SetKwData{MAXIMUMK}{maximum K}
\SetKwData{SIGNMODIFIER}{sign modifier}
\SetKwData{ZEROES}{zeroes}
\SetKw{RAISE}{raise}
\SetKwFunction{MIN}{min}
\SetKwFunction{WRITERESIDUAL}{write residual}
\SetKw{AND}{and}
\HISTORY $\leftarrow$ initial history\;
\SIGNMODIFIER $\leftarrow 0$\;
$i \leftarrow 0$\;
\While{$i < \text{residual count}$}{
  \eIf(\tcc*[f]{add sign bit}){$\text{residual}_i \geq 0$}{
    $\text{unsigned}_i \leftarrow \text{residual}_i \times 2 - \SIGNMODIFIER$\;
  }{
    $\text{unsigned}_i \leftarrow (-\text{residual}_i \times 2) - 1 - \SIGNMODIFIER$\;
  }
  $\SIGNMODIFIER \leftarrow 0$\;
  \If{$\text{unsigned}_i \geq 2 ^ \text{sample size}$}{
    \RAISE residual overflow exception\footnote{in this case, we should cease building a compressed frame and write an uncompressed frame instead}\;
  }
  $\kappa \leftarrow \MIN(\lfloor\log_2((\HISTORY \div 2 ^ 9) + 3)\rfloor~,~\MAXIMUMK)$\;
  $\WRITERESIDUAL(\text{unsigned}_i~,~\kappa~,~\text{sample size})$\;
  \BlankLine
  \eIf(\tcc*[f]{update history}){$\text{unsigned}_i < 65535$}{
    $\HISTORY \leftarrow \HISTORY + (\text{unsigned}_i \times \HISTORYMULT) - \left\lfloor\frac{\HISTORY \times \HISTORYMULT}{2 ^ 9}\right\rfloor$\;
    $i \leftarrow i + 1$\;
    \BlankLine
    \If(\tcc*[f]{handle 0 residuals}){$\HISTORY < 128$ \AND $i < \text{residual count}$}{
      $\kappa \leftarrow \MIN(7 - \lfloor\log_2(\HISTORY)\rfloor + \lfloor(\HISTORY + 16) \div 2 ^ 6\rfloor~,~\MAXIMUMK)$\;
      $\ZEROES \leftarrow 0$\;
      \While{$i < \text{residual count}$ \AND $\text{residual}_i = 0$}{
        $\ZEROES \leftarrow \ZEROES + 1$\;
        $i \leftarrow i + 1$\;
      }
      $\WRITERESIDUAL(\ZEROES~,~\kappa~,~16)$\;
      \If{$\ZEROES < 65535$}{
        $\SIGNMODIFIER \leftarrow 1$\;
      }
      $\HISTORY \leftarrow 0$\;
    }
  }{
    $i \leftarrow i + 1$\;
    $\HISTORY \leftarrow 65535$\;
  }
}
\Return encoded residual block\;
\EALGORITHM

\clearpage

\subsubsection{Encoding Individual Residual}

\ALGORITHM{an unsigned residual value, $\kappa$, sample size}{an individual encoded residual}
\SetKwData{MSB}{MSB}
\SetKwData{LSB}{LSB}
$\MSB \leftarrow \text{unsigned} \div 2 ^ \kappa - 1$\;
$\LSB \leftarrow \text{unsigned} \bmod~2 ^ \kappa - 1$\;
\eIf{$\MSB > 8$}{
  \WRITE \texttt{0x1FF} in 9 unsigned bits\;
  \WRITE unsigned in (sample size) unsigned bits\;
}{
  \WUNARY \MSB with stop bit 0\;
  \If{$\kappa > 1$}{
    \eIf{$\LSB > 0$}{
      \WRITE ($\LSB + 1$) in $\kappa$ unsigned bits\;
    }{
      \WRITE 0 in ($\kappa - 1$) unsigned bits\;
    }
  }
}
\EALGORITHM

\begin{landscape}

\subsubsection{Residual Encoding Example}
\begin{table}[h]
{\relsize{-1}
\renewcommand{\arraystretch}{1.5}
\begin{tabular}{r||r|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}|>{$}r<{$}}
$i$ & $\text{residual}_i$ & \text{unsigned}_i & \kappa & \text{MSB}_i & \text{LSB}_i & \text{history}_{i + 1} \\
\hline
0 & \texttt{0} &
\texttt{0} \times 2 = \texttt{0} &
\lfloor\log_2(\frac{\texttt{10}}{2 ^ 9} + 3)\rfloor = \texttt{1} &
0 \div 2 ^ 1 - 1 = 0 &
 &
\texttt{10} + (\texttt{0} \times \texttt{40}) - \left\lfloor\frac{\texttt{10} \times \texttt{40}}{2 ^ 9}\right\rfloor = \texttt{10} \\
& $zeroes = 0$ &
\multicolumn{2}{>{$}r<{$}|}{7 - \lfloor\log_2(10)\rfloor + \lfloor\frac{10 + 16}{2 ^ 6}\rfloor = 4} &
0 \div 2 ^ 4 - 1 = 0 &
0 \bmod~2 ^ 4 - 1 = 0 &
\texttt{0} \\
1 & \texttt{16} &
\texttt{16} \times 2 - 1 = \texttt{31} &
\lfloor\log_2(\frac{\texttt{0}}{2 ^ 9} + 3)\rfloor = \texttt{1} &
\multicolumn{2}{r|}{write \texttt{0x1FFF} in 9 unsigned bits} &
\texttt{0} + (\texttt{31} \times \texttt{40}) - \left\lfloor\frac{\texttt{0} \times \texttt{40}}{2 ^ 9}\right\rfloor = \texttt{1240} \\
& & & & \multicolumn{2}{r|}{write \texttt{31} in 16 unsigned bits} & \\
2 & \texttt{16} &
\texttt{16} \times 2 = \texttt{32} &
\lfloor\log_2(\frac{\texttt{1240}}{2 ^ 9} + 3)\rfloor = \texttt{2} &
\multicolumn{2}{r|}{write \texttt{0x1FFF} in 9 unsigned bits} &
\texttt{1240} + (\texttt{32} \times \texttt{40}) - \left\lfloor\frac{\texttt{1240} \times \texttt{40}}{2 ^ 9}\right\rfloor = \texttt{2424} \\
& & & & \multicolumn{2}{r|}{write \texttt{32} in 16 unsigned bits} & \\
3 & \texttt{12} &
\texttt{12} \times 2 = \texttt{24} &
\lfloor\log_2(\frac{\texttt{2424}}{2 ^ 9} + 3)\rfloor = \texttt{2} &
24 \div 2 ^ 2 - 1 = 8 &
24 \bmod~2 ^ 2 - 1 = 0 &
\texttt{2424} + (\texttt{24} \times \texttt{40}) - \left\lfloor\frac{\texttt{2424} \times \texttt{40}}{2 ^ 9}\right\rfloor = \texttt{3195} \\
4 & \texttt{10} &
\texttt{10} \times 2 = \texttt{20} &
\lfloor\log_2(\frac{\texttt{3195}}{2 ^ 9} + 3)\rfloor = \texttt{3} &
20 \div 2 ^ 3 - 1 = 2 &
20 \bmod~2 ^ 3 - 1 = 6 &
\texttt{3195} + (\texttt{20} \times \texttt{40}) - \left\lfloor\frac{\texttt{3195} \times \texttt{40}}{2 ^ 9}\right\rfloor = \texttt{3746} \\
5 & \texttt{1} &
\texttt{1} \times 2 = \texttt{2} &
\lfloor\log_2(\frac{\texttt{3746}}{2 ^ 9} + 3)\rfloor = \texttt{3} &
2 \div 2 ^ 3 - 1 = 0 &
2 \bmod~2 ^ 3 - 1 = 2 &
\texttt{3746} + (\texttt{2} \times \texttt{40}) - \left\lfloor\frac{\texttt{3746} \times \texttt{40}}{2 ^ 9}\right\rfloor = \texttt{3534} \\
6 & \texttt{0} &
\texttt{0} \times 2 = \texttt{0} &
\lfloor\log_2(\frac{\texttt{3534}}{2 ^ 9} + 3)\rfloor = \texttt{3} &
0 \div 2 ^ 3 - 1 = 0 &
0 \bmod~2 ^ 3 - 1 = 0 &
\texttt{3534} + (\texttt{0} \times \texttt{40}) - \left\lfloor\frac{\texttt{3534} \times \texttt{40}}{2 ^ 9}\right\rfloor = \texttt{3258} \\
7 & \texttt{-1} &
(\texttt{1} \times 2) - 1 = \texttt{1} &
\lfloor\log_2(\frac{\texttt{3258}}{2 ^ 9} + 3)\rfloor = \texttt{3} &
1 \div 2 ^ 3 - 1 = 0 &
1 \bmod~2 ^ 3 - 1 = 1 &
\texttt{3258} + (\texttt{1} \times \texttt{40}) - \left\lfloor\frac{\texttt{3258} \times \texttt{40}}{2 ^ 9}\right\rfloor = \texttt{3044} \\
8 & \texttt{-3} &
(\texttt{3} \times 2) - 1 = \texttt{5} &
\lfloor\log_2(\frac{\texttt{3044}}{2 ^ 9} + 3)\rfloor = \texttt{3} &
5 \div 2 ^ 3 - 1 = 0 &
5 \bmod~2 ^ 3 - 1 = 5 &
\texttt{3044} + (\texttt{5} \times \texttt{40}) - \left\lfloor\frac{\texttt{3044} \times \texttt{40}}{2 ^ 9}\right\rfloor = \texttt{3007} \\
9 & \texttt{-4} &
(\texttt{4} \times 2) - 1 = \texttt{7} &
\lfloor\log_2(\frac{\texttt{3007}}{2 ^ 9} + 3)\rfloor = \texttt{3} &
7 \div 2 ^ 3 - 1 = 1 &
7 \bmod~2 ^ 3 - 1 = 0 &
\texttt{3007} + (\texttt{7} \times \texttt{40}) - \left\lfloor\frac{\texttt{3007} \times \texttt{40}}{2 ^ 9}\right\rfloor = \texttt{3053} \\
10 & \texttt{-3} &
(\texttt{3} \times 2) - 1 = \texttt{5} &
\lfloor\log_2(\frac{\texttt{3053}}{2 ^ 9} + 3)\rfloor = \texttt{3} &
5 \div 2 ^ 3 - 1 = 0 &
5 \bmod~2 ^ 3 - 1 = 5 &
\texttt{3053} + (\texttt{5} \times \texttt{40}) - \left\lfloor\frac{\texttt{3053} \times \texttt{40}}{2 ^ 9}\right\rfloor = \texttt{3015} \\
11 & \texttt{-6} &
(\texttt{6} \times 2) - 1 = \texttt{11} &
\lfloor\log_2(\frac{\texttt{3015}}{2 ^ 9} + 3)\rfloor = \texttt{3} &
11 \div 2 ^ 3 - 1 = 1 &
11 \bmod~2 ^ 3 - 1 = 4 &
\texttt{3015} + (\texttt{11} \times \texttt{40}) - \left\lfloor\frac{\texttt{3015} \times \texttt{40}}{2 ^ 9}\right\rfloor = \texttt{3220} \\
12 & \texttt{-5} &
(\texttt{5} \times 2) - 1 = \texttt{9} &
\lfloor\log_2(\frac{\texttt{3220}}{2 ^ 9} + 3)\rfloor = \texttt{3} &
9 \div 2 ^ 3 - 1 = 1 &
9 \bmod~2 ^ 3 - 1 = 2 &
\texttt{3220} + (\texttt{9} \times \texttt{40}) - \left\lfloor\frac{\texttt{3220} \times \texttt{40}}{2 ^ 9}\right\rfloor = \texttt{3329} \\
13 & \texttt{-5} &
(\texttt{5} \times 2) - 1 = \texttt{9} &
\lfloor\log_2(\frac{\texttt{3329}}{2 ^ 9} + 3)\rfloor = \texttt{3} &
9 \div 2 ^ 3 - 1 = 1 &
9 \bmod~2 ^ 3 - 1 = 2 &
\texttt{3329} + (\texttt{9} \times \texttt{40}) - \left\lfloor\frac{\texttt{3329} \times \texttt{40}}{2 ^ 9}\right\rfloor = \texttt{3429} \\
14 & \texttt{-5} &
(\texttt{5} \times 2) - 1 = \texttt{9} &
\lfloor\log_2(\frac{\texttt{3429}}{2 ^ 9} + 3)\rfloor = \texttt{3} &
9 \div 2 ^ 3 - 1 = 1 &
9 \bmod~2 ^ 3 - 1 = 2 &
\texttt{3429} + (\texttt{9} \times \texttt{40}) - \left\lfloor\frac{\texttt{3429} \times \texttt{40}}{2 ^ 9}\right\rfloor = \texttt{3522} \\

\end{tabular}
\renewcommand{\arraystretch}{1.0}
}
\end{table}

\clearpage

\begin{figure}[h]
\includegraphics{figures/alac/residual-build.pdf}
\end{figure}

\end{landscape}

\subsection{Writing Subframe Header}
\ALGORITHM{4 or 8 signed QLP coefficients}{a subframe header}
\WRITE 0 in 4 unsigned bits\tcc*[r]{prediction type}
\WRITE 9 in 4 unsigned bits\tcc*[r]{QLP shift needed}
\WRITE 4 in 3 unsigned bits\tcc*[r]{Rice modifier}
\WRITE coefficient count in 5 unsigned bits\;
\ForEach{QLP coefficient \IN QLP coefficients}{
  \WRITE QLP coefficient in 16 signed bits\;
}
\EALGORITHM
\begin{figure}[h]
\includegraphics{figures/alac/subframe_header.pdf}
\end{figure}
\par
\noindent
For example, given the QLP coefficients
\texttt{1170, -1088, 565, -161},
the subframe header is written as:
\begin{figure}[h]
\includegraphics{figures/alac/subframe-build.pdf}
\end{figure}

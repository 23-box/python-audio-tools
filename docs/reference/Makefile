#FIXME - reorganize this big mess
ID3v22 = \
figures/id3v22/header.pdf \
figures/id3v22/frame.pdf \
figures/id3v22/frames.pdf \
figures/id3v22/com.pdf \
figures/id3v22/com-example.pdf \
figures/id3v22/geo.pdf \
figures/id3v22/pic.pdf \
figures/id3v22/pic-example.pdf \
figures/id3v22/t__.pdf \
figures/id3v22/t__-example.pdf \
figures/id3v22/txx.pdf \
figures/id3v22/ult.pdf \
figures/id3v22/w__.pdf \
figures/id3v22/wxx.pdf

ID3v23 = \
figures/id3v23/header.pdf \
figures/id3v23/frame.pdf \
figures/id3v23/frames.pdf \
figures/id3v23/apic.pdf \
figures/id3v23/apic-example.pdf \
figures/id3v23/comm.pdf \
figures/id3v23/comm-example.pdf \
figures/id3v23/geob.pdf \
figures/id3v23/t___.pdf \
figures/id3v23/t___-example.pdf \
figures/id3v23/txxx.pdf \
figures/id3v23/uslt.pdf \
figures/id3v23/w___.pdf \
figures/id3v23/wxxx.pdf

ID3v24 = \
figures/id3v24/header.pdf \
figures/id3v24/frame.pdf \
figures/id3v24/frames.pdf \
figures/id3v24/apic.pdf \
figures/id3v24/apic-example.pdf \
figures/id3v24/comm.pdf \
figures/id3v24/comm-example.pdf \
figures/id3v24/geob.pdf \
figures/id3v24/size.pdf \
figures/id3v24/t___.pdf \
figures/id3v24/t___-example.pdf \
figures/id3v24/txxx.pdf \
figures/id3v24/uslt.pdf \
figures/id3v24/w___.pdf \
figures/id3v24/wxxx.pdf

FLAC = \
figures/flac/application.pdf \
figures/flac/block_header.pdf \
figures/flac/constant.pdf \
figures/flac/cuesheet.pdf \
figures/flac/cuesheet-example.pdf \
figures/flac/fixed.pdf \
figures/flac/fixed2.pdf \
figures/flac/fixed-parse.pdf \
figures/flac/frame.pdf \
figures/flac/frames.pdf \
figures/flac/header-example.pdf \
figures/flac/lag0.pdf \
figures/flac/lag1.pdf \
figures/flac/lag2.pdf \
figures/flac/lag3.pdf \
figures/flac/lpc.pdf \
figures/flac/lpc2.pdf \
figures/flac/lpc-parse.pdf \
figures/flac/lpc-parse2.pdf \
figures/flac/metadata.pdf \
figures/flac/metadata-blocks.pdf \
figures/flac/padding.pdf \
figures/flac/picture.pdf \
figures/flac/picture-example.pdf \
figures/flac/read_utf8.pdf \
figures/flac/residual.pdf \
figures/flac/residual-example1.pdf \
figures/flac/residual-example2.pdf \
figures/flac/residual-example3.pdf \
figures/flac/residual-example4.pdf \
figures/flac/residual-example5.pdf \
figures/flac/residual-parse.pdf \
figures/flac/seektable.pdf \
figures/flac/seektable-example.pdf \
figures/flac/stream.pdf \
figures/flac/stream2.pdf \
figures/flac/stream3.pdf \
figures/flac/streaminfo.pdf \
figures/flac/streaminfo-example.pdf \
figures/flac/subframes.pdf \
figures/flac/tukey.pdf \
figures/flac/utf8.pdf \
figures/flac/verbatim.pdf \
figures/flac/vorbiscomment.pdf \
figures/flac/vorbiscomment-example.pdf \
figures/flac/write_utf8.pdf \
figures/oggflac_stream.pdf


M4A = figures/m4a/quicktime.pdf \
figures/m4a/atom.pdf \
figures/m4a/atom2.pdf \
figures/m4a/atoms.pdf \
figures/m4a/data.pdf \
figures/m4a/disk.pdf \
figures/m4a/dref.pdf \
figures/m4a/ftyp.pdf \
figures/m4a/hdlr.pdf \
figures/m4a/mdhd.pdf \
figures/m4a/meta.pdf \
figures/m4a/meta_atoms.pdf \
figures/m4a/mp4a.pdf \
figures/m4a/mvhd.pdf \
figures/m4a/smhd.pdf \
figures/m4a/stco.pdf \
figures/m4a/stsc.pdf \
figures/m4a/stsd.pdf \
figures/m4a/stsz.pdf \
figures/m4a/stts.pdf \
figures/m4a/tkhd.pdf \
figures/m4a/trkn.pdf

WAVPACK = figures/wavpack/block_channels.pdf \
figures/wavpack/block_header.pdf \
figures/wavpack/block_header2.pdf \
figures/wavpack/block_header_parse.pdf \
figures/wavpack/channel_info.pdf \
figures/wavpack/decoding_params.pdf \
figures/wavpack/decorr_samples.pdf \
figures/wavpack/decorr_samples_encode.pdf \
figures/wavpack/decorr_samples_parse.pdf \
figures/wavpack/decorr_terms.pdf \
figures/wavpack/decorr_weights.pdf \
figures/wavpack/decorr_weights_parse.pdf \
figures/wavpack/decorrelation0.pdf \
figures/wavpack/decorrelation1.pdf \
figures/wavpack/decorrelation2.pdf \
figures/wavpack/decorrelation3.pdf \
figures/wavpack/decorrelation4.pdf \
figures/wavpack/decorrelation5.pdf \
figures/wavpack/entropy_vars.pdf \
figures/wavpack/entropy_vars_parse.pdf \
figures/wavpack/extended_integers.pdf \
figures/wavpack/md5sum.pdf \
figures/wavpack/pcm_sandwich.pdf \
figures/wavpack/residuals.pdf \
figures/wavpack/residuals_parse.pdf \
figures/wavpack/residuals_parse2.pdf \
figures/wavpack/sample_rate.pdf \
figures/wavpack/stream.pdf \
figures/wavpack/subblock.pdf \
figures/wavpack/subblock_header.pdf \
figures/wavpack/subblock_parse.pdf \
figures/wavpack/terms_parse.pdf \
figures/wavpack/typical_block.pdf

SHORTEN = figures/shorten/block1.pdf \
figures/shorten/block2.pdf \
figures/shorten/filetype.pdf \
figures/shorten/header_parse.pdf \
figures/shorten/qlpc.pdf \
figures/shorten/qlpc1.pdf \
figures/shorten/stream.pdf \
figures/shorten/verbatim.pdf

ALAC = figures/alac/alac_atom.pdf \
figures/alac/alac-atom-parse.pdf \
figures/alac/atom.pdf \
figures/alac/atoms.pdf \
figures/alac/interlaced_frame.pdf \
figures/alac/mdhd.pdf \
figures/alac/mdhd-parse.pdf \
figures/alac/noninterlaced_frame.pdf \
figures/alac/residual-build.pdf \
figures/alac/residual-parse.pdf \
figures/alac/stream.pdf \
figures/alac/subframe-build.pdf \
figures/alac/subframe-parse.pdf \
figures/alac/subframe_header.pdf \
figures/alac/uncompressed_frame.pdf

MLP = figures/mlp/channel_parameters.pdf \
figures/mlp/codebook1.pdf \
figures/mlp/codebook2.pdf \
figures/mlp/codebook3.pdf \
figures/mlp/decoding_params.pdf \
figures/mlp/filter_params_fir.pdf \
figures/mlp/filter_params_iir.pdf \
figures/mlp/major_sync.pdf \
figures/mlp/matrix_params.pdf \
figures/mlp/output_shifts.pdf \
figures/mlp/parameter_presence_flags.pdf \
figures/mlp/quant_steps.pdf \
figures/mlp/residuals.pdf \
figures/mlp/restart_header.pdf \
figures/mlp/stream.pdf \
figures/mlp/substream.pdf \
figures/mlp/substream_size.pdf

DVDA = figures/dvda/aob_mlp_payload.pdf \
figures/dvda/aob_pack_header.pdf \
figures/dvda/aob_pcm_payload.pdf \
figures/dvda/ats_sectors.pdf \
figures/dvda/ats_title.pdf \
figures/dvda/ats_xx_0.pdf \
figures/dvda/ats_xx_x.pdf \
figures/dvda/audio_packet.pdf \
figures/dvda/audio_ts_ifo.pdf \
figures/dvda/layout.pdf \
figures/dvda/mlp_channel_params.pdf \
figures/dvda/mlp_codebook1.pdf \
figures/dvda/mlp_codebook2.pdf \
figures/dvda/mlp_codebook3.pdf \
figures/dvda/mlp_block_parse.pdf \
figures/dvda/mlp_decoding_params.pdf \
figures/dvda/mlp_decoding_params_parse.pdf \
figures/dvda/mlp_frame.pdf \
figures/dvda/mlp_iir_filter_params.pdf \
figures/dvda/mlp_fir_filter_params.pdf \
figures/dvda/mlp_matrix_params.pdf \
figures/dvda/mlp_major_sync.pdf \
figures/dvda/mlp_major_sync_parse.pdf \
figures/dvda/mlp_parity_parse.pdf \
figures/dvda/mlp_residuals.pdf \
figures/dvda/mlp_restart_header.pdf \
figures/dvda/mlp_restart_header_parse1.pdf \
figures/dvda/mlp_restart_header_parse2.pdf \
figures/dvda/mlp_stream.pdf \
figures/dvda/mlp_substream.pdf \
figures/dvda/mlp_substream_info.pdf \
figures/dvda/mlp_substream_info_parse.pdf

AOBPCM = figures/aobpcm/24bps_1ch.pdf \
figures/aobpcm/24bps_2ch.pdf \
figures/aobpcm/24bps_3ch.pdf \
figures/aobpcm/24bps_4ch.pdf \
figures/aobpcm/24bps_5ch.pdf \
figures/aobpcm/24bps_6ch.pdf

VORBIS = figures/ogg_packets.pdf \
figures/ogg_stream.pdf \
figures/vorbis/codebooks.pdf \
figures/vorbis/comment.pdf \
figures/vorbis/float32.pdf \
figures/vorbis/huffman_example1.pdf \
figures/vorbis/huffman_example2.pdf \
figures/vorbis/huffman_example3.pdf \
figures/vorbis/huffman_example4.pdf \
figures/vorbis/identification.pdf \
figures/vorbis/ordered_entries.pdf \
figures/vorbis/setup_packet.pdf

BASICS = figures/diagram.pdf \
figures/diagram2.pdf \
figures/big_endian.pdf \
figures/little_endian.pdf \
figures/unary1.pdf

MP3 = figures/mp3/frame_header.pdf \
figures/mp3/granule.pdf \
figures/mp3/id3v1.pdf \
figures/mp3/id3v11.pdf \
figures/mp3/id3v11-example.pdf \
figures/mp3/id3v2_stream.pdf \
figures/mp3/id3v2_stream-example.pdf \
figures/mp3/main_data.pdf \
figures/mp3/scalefactors.pdf \
figures/mp3/side_data_1ch.pdf \
figures/mp3/side_data_2ch.pdf \
figures/mp3/stream.pdf \
figures/mp3/stream2.pdf \
figures/mp3/xing.pdf

WAVE = \
figures/wav/stream.pdf \
figures/wav/fmt.pdf \
figures/wav/fmtext.pdf \
figures/wav/data.pdf

AIFF = \
figures/aiff/stream.pdf \
figures/aiff/comm.pdf \
figures/aiff/ssnd.pdf

APE = \
figures/ape/stream.pdf \
figures/ape/descriptor.pdf \
figures/ape/header.pdf \
figures/ape/apev2_item.pdf \
figures/ape/apev2_tag.pdf \
figures/ape/apev2_tagheader.pdf \
figures/ape/apev2_flags.pdf

MUSEPACK = \
figures/musepack/sv7_stream.pdf \
figures/musepack/sv8_stream.pdf \
figures/musepack/sv8_sh.pdf \
figures/musepack/sv8_rg.pdf \
figures/musepack/sv8_ei.pdf \
figures/musepack/sv8_nut.pdf

FREEDB = \
figures/freedb/sequence.pdf \
figures/freedb/discid.pdf \

MUSICBRAINZ = \
figures/musicbrainz/discid.pdf \
figures/musicbrainz/xml.pdf \


FIGURES = \
$(BASICS) \
$(WAVE) \
$(AIFF) \
figures/au_stream.pdf \
$(SHORTEN) \
$(FLAC) \
$(WAVPACK) \
$(APE) \
$(MP3) \
$(ID3v22) \
$(ID3v23) \
$(ID3v24) \
$(M4A) \
$(ALAC) \
$(VORBIS) \
figures/speex_header.pdf \
$(MUSEPACK) \
$(DVDA) \
$(FREEDB) \
$(MUSICBRAINZ)


CHAPTERS = \
introduction.tex \
basics.tex \
wav.tex \
aiff.tex \
au.tex \
shorten.tex \
flac.tex \
wavpack.tex \
ape.tex \
mp3.tex \
m4a.tex \
alac.tex \
vorbis.tex \
oggflac.tex \
speex.tex \
musepack.tex \
dvda2.tex \
freedb.tex \
musicbrainz.tex \
musicbrainz_mmd.tex \
replaygain.tex \
references.tex \
license.tex


all: audioformats-letter.pdf audioformats-a4.pdf

clean:
	rm -f *.toc *.aux *.log *.out $(FIGURES)
	rm -f figures/pcm.fig figures/flac/tukey.fig
	rm -f audiotools-a4.tex audiotools-letter.tex

audioformats-letter.pdf: audioformats-letter.tex $(CHAPTERS) $(FIGURES)
	python pdflatexbuild.py -halt-on-error audioformats-letter.tex
	python ../pdftag.py "--title=Audio Formats Reference" "--author=Brian Langenberger" $@

audioformats-a4.pdf: audioformats-a4.tex $(CHAPTERS) $(FIGURES)
	python pdflatexbuild.py -halt-on-error audioformats-a4.tex
	python ../pdftag.py "--title=Audio Formats Reference" "--author=Brian Langenberger" $@

mp3_decode.pdf: mp3_decode.tex $(MP3)
	python pdflatexbuild.py -halt-on-error $<

flac-codec.tex: flac-codec.m4 header.m4 footer.m4
	m4 -D PAPERSIZE=letterpaper $< > $@

flac-codec.pdf: flac-codec.tex flac.tex $(FLAC)
	python pdflatexbuild.py -halt-on-error $<

alac-codec.tex: alac-codec.m4 header.m4 footer.m4
	m4 -D PAPERSIZE=letterpaper $< > $@

alac-codec.pdf: alac-codec.tex alac.tex $(ALAC)
	python pdflatexbuild.py -halt-on-error $<

wavpack-codec.tex: wavpack-codec.m4 header.m4 footer.m4
	m4 -D PAPERSIZE=letterpaper $< > $@

wavpack-codec.pdf: wavpack-codec.tex wavpack.tex $(WAVPACK)
	python pdflatexbuild.py -halt-on-error $<

shorten-codec.tex: shorten-codec.m4 header.m4 footer.m4
	m4 -D PAPERSIZE=letterpaper $< > $@

shorten-codec.pdf: shorten-codec.tex shorten.tex $(SHORTEN)
	python pdflatexbuild.py -halt-on-error $<

dvda-codec.tex: dvda-codec.m4 header.m4 footer.m4
	m4 -D PAPERSIZE=letterpaper $< > $@

dvda-codec.pdf: dvda-codec.tex dvda2.tex $(DVDA)
	python pdflatexbuild.py -halt-on-error $<

mp3-codec.tex: mp3-codec.m4 header.m4 footer.m4
	m4 -D PAPERSIZE=letterpaper $< > $@

mp3-codec.pdf: mp3-codec.tex mp3.tex $(MP3) $(ID3v22) $(ID3v23) $(ID3v24)
	python pdflatexbuild.py -halt-on-error $<

audioformats-letter.tex: audioformats.m4 header.m4 footer.m4
	m4 -D PAPERSIZE=letterpaper $< > $@

audioformats-a4.tex: audioformats.m4 header.m4 footer.m4
	m4 -D PAPERSIZE=a4paper $< > $@

figures/pcm.pdf: figures/pcm.fig
	fig2dev -Z 3 -L pdf $< $@

figures/pcm.fig: figures/pcm.plot
	./figures/pcm.plot > $@

figures/flac/tukey.pdf: figures/flac/tukey.fig
	fig2dev -Z 3 -L pdf $< $@

figures/flac/tukey.fig: figures/flac/tukey.plot
	./figures/flac/tukey.plot > $@

figures/flac/lag0.pdf: figures/flac/lag0.fig
	fig2dev -Z 3.5 -L pdf $< $@

figures/flac/lag1.pdf: figures/flac/lag1.fig
	fig2dev -Z 3.5 -L pdf $< $@

figures/flac/lag2.pdf: figures/flac/lag2.fig
	fig2dev -Z 3.5 -L pdf $< $@

figures/flac/lag3.pdf: figures/flac/lag3.fig
	fig2dev -Z 3.5 -L pdf $< $@

figures/freedb/sequence.pdf: figures/freedb/sequence.fig
	fig2dev -Z 4 -L pdf $< $@

figures/musicbrainz/xml.pdf: figures/musicbrainz/xml.fig
	fig2dev -Z 4 -L pdf $< $@

figures/m4a/atoms.pdf: figures/m4a/atoms.fig
	fig2dev -Z 6 -L pdf $< $@

figures/m4a/meta_atoms.pdf: figures/m4a/meta_atoms.fig
	fig2dev -Z 3 -L pdf $< $@

figures/alac/atoms.pdf: figures/alac/atoms.fig
	fig2dev -Z 5 -L pdf $< $@

figures/bitstream_bigendian.pdf: figures/bitstream_bigendian.fig
	fig2dev -Z 6 -L pdf $< $@

figures/bitstream_littleendian.pdf: figures/bitstream_littleendian.fig
	fig2dev -Z 6 -L pdf $< $@

figures/bitstream_littleendian_alt.pdf: figures/bitstream_littleendian_alt.fig
	fig2dev -Z 6 -L pdf $< $@

figures/vorbis/ordered_entries.pdf: figures/vorbis/ordered_entries.dot
	dot -Tpdf $< -o $@

.SUFFIXES: .pdf .bdx .bpx .bypx .dot

.bdx.pdf:
	./bitdiagram.py -i $< -o $@

.bpx.pdf:
	./bitparse.py -i $< -o $@

.bypx.pdf:
	./byteparse.py -i $< -o $@

.dot.pdf:
	dot -Tpdf $< -o $@

figures/m4a/ftyp.pdf: figures/m4a/ftyp.bdx
	./bitdiagram.py -w 270 -i $< -o $@

figures/m4a/mvhd.pdf: figures/m4a/mvhd.bdx
	./bitdiagram.py -w 270 -i $< -o $@

figures/m4a/meta.pdf: figures/m4a/meta.bdx
	./bitdiagram.py -w 306 -i $< -o $@

figures/m4a/data.pdf: figures/m4a/data.bdx
	./bitdiagram.py -w 306 -i $< -o $@

figures/alac/atom.pdf: figures/m4a/atom.bdx
	./bitdiagram.py -w 324 -i $< -o $@

figures/alac/alac-atom-parse.pdf: figures/alac/alac-atom-parse.bpx
	./bitparse.py -w 480 -b 24 -i $< -o $@

figures/alac/mdhd.pdf: figures/m4a/mdhd.bdx
	./bitdiagram.py -i $< -o $@

# figures/alac/subframe-parse.pdf: figures/alac/subframe-parse.bpx
# 	./bitparse.py -w 500 -b 24 -i $< -o $@

figures/alac/subframe-parse.pdf: figures/alac/subframe-parse.bpx
	./bitparse.py -w 432 -b 16 -i $< -o $@

figures/alac/residual-parse.pdf: figures/alac/residual-parse.bpx
	./bitparse.py -w 490 -b 24 -i $< -o $@

figures/alac/residual-build.pdf: figures/alac/residual-build.bpx
	./bitparse.py -w 490 -b 24 -i $< -o $@

# figures/wavpack/block_header_parse.pdf: figures/wavpack/block_header_parse.bpx
# 	./bitparse.py -w 480 -b 24 -i $< -o $@

figures/wavpack/decorrelation0.fig: figures/wavpack/decorrelation1.plot figures/wavpack/decorr_pass0.dat
	./figures/wavpack/decorrelation0.plot > $@

figures/wavpack/decorrelation0.pdf: figures/wavpack/decorrelation0.fig
	fig2dev -Z 3 -L pdf $< $@

figures/wavpack/decorrelation1.fig: figures/wavpack/decorrelation1.plot figures/wavpack/decorr_pass1.dat
	./figures/wavpack/decorrelation1.plot > $@

figures/wavpack/decorrelation1.pdf: figures/wavpack/decorrelation1.fig
	fig2dev -Z 3 -L pdf $< $@

figures/wavpack/decorrelation2.fig: figures/wavpack/decorrelation2.plot
	./figures/wavpack/decorrelation2.plot > $@

figures/wavpack/decorrelation2.pdf: figures/wavpack/decorrelation2.fig
	fig2dev -Z 3 -L pdf $< $@

figures/wavpack/decorrelation3.fig: figures/wavpack/decorrelation3.plot
	./figures/wavpack/decorrelation3.plot > $@

figures/wavpack/decorrelation3.pdf: figures/wavpack/decorrelation3.fig
	fig2dev -Z 3 -L pdf $< $@

figures/wavpack/decorrelation4.fig: figures/wavpack/decorrelation4.plot
	./figures/wavpack/decorrelation4.plot > $@

figures/wavpack/decorrelation4.pdf: figures/wavpack/decorrelation4.fig
	fig2dev -Z 3 -L pdf $< $@

figures/wavpack/decorrelation5.fig: figures/wavpack/decorrelation5.plot
	./figures/wavpack/decorrelation5.plot > $@

figures/wavpack/decorrelation5.pdf: figures/wavpack/decorrelation5.fig
	fig2dev -Z 3 -L pdf $< $@

figures/wavpack/residuals_parse.pdf: figures/wavpack/residuals_parse.bpx
	./bitparse.py -i $< -o $@ -b 24 -w 480

figures/flac/utf8.pdf: figures/flac/utf8.bpx
	./bitparse.py -i $< -o $@ -b 8 -w 170

figures/flac/lpc-parse2.pdf: figures/flac/lpc-parse2.bpx
	./bitparse.py -i $< -o $@ -b 24 -w 480

figures/shorten/filetype.pdf: figures/shorten/filetype.bpx
	./bitparse.py -w 140 -b 7 -i $< -o $@

basics-info.tex: basics-info.m4 header.m4 footer.m4
	m4 -D PAPERSIZE=letterpaper $< > $@

basics-info.pdf: basics-info.tex basics.tex $(BASICS)
	python pdflatexbuild.py -halt-on-error $<

figures/flac/cuesheet-example.pdf: figures/flac/cuesheet-example.bypx
	./byteparse.py --no-ascii --digits-per-row 20 -i $< -o $@
